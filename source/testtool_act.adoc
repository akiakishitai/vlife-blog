= GitHub Actions ã‚’ act ã§ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆã™ã‚‹
ç§‹ã€…ã™ã™ã
v1.2, 2020-11-19
:created_at: 2020-11-02
:tags: github, github-actions, act
:toc: left
:toc-title: ç›®æ¬¡
:toclevels: 3
include::commons/attrs.adoc[]

== ã¯ã˜ã‚ã«

https://github.co.jp/features/actions[_GitHub Actions_] ã¯ä¾¿åˆ©ã€‚
ã ã‘ã©æ›¸ã„ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿéš›ã©ã†å‹•ãã‹è©¦ã™ãŸã‚ã€å®Ÿéš›ã« GitHub ãƒªãƒã‚¸ãƒˆãƒªã¸ãƒ—ãƒƒã‚·ãƒ¥ã‚„ãƒãƒ¼ã‚¸ã—ã¦ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’æ±šãã™ã‚‹ã®ã¯ã¤ã‚‰ã„ã€‚

ã§ãã‚Œã°ãƒ­ãƒ¼ã‚«ãƒ«ä¸Šã§ _GitHub Actions_ ã‚’ãƒ†ã‚¹ãƒˆã—ãŸã„ï¼

ã¨ã„ã†ã“ã¨ã§ https://github.com/nektos/act[act] ã‚’å°å…¥ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ä¸Šã§ãƒ†ã‚¹ãƒˆã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

.ç’°å¢ƒ
[cols=",", options="header"]
|===
|App
|Version

|Windows10 Pro
|1903

|Docker Desktop
|2.4.0.0

|act
|0.2.16
|===

== act ã¨ã¯ğŸš€

_GitHub Actions_ ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ãƒ„ãƒ¼ãƒ«ã€‚
åˆ©ç”¨ã™ã‚‹ã«ã¯ _Docker_ ãŒå¿…è¦ã€‚

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé…ä¸‹ã® `.github/workflows/` ã‚’èª­ã¿è¾¼ã¿ã€_Docker API_ ã‚’ä½¿ã£ã¦å¿…è¦ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒ«ãƒ»ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã€‚
ãã—ã¦å„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚

.ç‰¹å¾´
* ç’°å¢ƒå¤‰æ•°ã‚„ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã¯ GitHub ãŒæä¾›ã—ã¦ã„ã‚‹ã‚‚ã®ã«å¯¾å¿œ
* _GitHub Actions_ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼ä»£ã‚ã‚Šã¨ã—ã¦ä½¿ç”¨å¯èƒ½
** `Makefile` ã®ä»£æ›¿
* GitHub ãŒæä¾›ã—ã¦ã„ã‚‹ã‚³ãƒãƒ³ãƒ‰ãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ä¸€éƒ¨ã®ã¿å¯¾å¿œ
** ã™ã¹ã¦ã®ã‚³ãƒãƒ³ãƒ‰ãƒ„ãƒ¼ãƒ«ã«å¯¾å¿œã•ã›ã‚‹ã¨ Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚µã‚¤ã‚ºãŒå·¨å¤§ãƒãƒƒã‚¯ã‚¹
** å…¨éƒ¨è¾¼ã¿ã“ã¿ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã—ã¦ https://hub.docker.com/r/nektos/act-environments-ubuntu/tags[nektos/act-environments-ubuntu:18.04] ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ãŒ 18GB è¶…ãˆâ€¦â€¦
* Rnners ã¯ ubuntu ã®ã¿å¯¾å¿œ
+
[cols=",",options="header",]
|===
|GitHub Runner
|actãŒä½¿ç”¨ã™ã‚‹Dockerã‚¤ãƒ¡ãƒ¼ã‚¸

|ubuntu-latest
|node:12.6-buster-slim

|ubuntu-18.04
|node:12.6-buster-slim

|ubuntu-16.04
|node:12.6-stretch-slim
|===

=== ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ä»Šå›ã¯Debian ãƒ™ãƒ¼ã‚¹ã® Docker ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ä½¿ã†ã®ã§ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã€‚
ä»–ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã¯ https://github.com/nektos/act#installation[å…¬å¼ã®README] ã‚’å‚ç…§ã€‚


.rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
[.no-line-numbers.command-line]
[source,bash,data-user="root",data-host="container"]
----
curl https://raw.githubusercontent.com/nektos/act/master/install.sh | bash
----

== ä½¿ã„æ–¹ğŸ£

`act [event name to run] [flags]` ã§å®Ÿè¡Œã™ã‚‹ã€‚

=== ã‚³ãƒãƒ³ãƒ‰ã®ä¸€ä¾‹

ä»–ã‚³ãƒãƒ³ãƒ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦ã¯ `act -h` ã¾ãŸã¯ https://github.com/nektos/act/blob/master/README.md[README] ã‚’å‚ç…§ã€‚

.ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ç¢ºèª
====

[.no-line-numbers.command-line]
[source,bash,data-user="user",data-host="local",data-output="3,6"]
----
# ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§
act -l

# ç‰¹å®šã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§
act pull_request -l

# DryRun
act -n
----

====

.ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
====

[.no-line-numbers.command-line]
[source,bash,data-user="user",data-host="local",data-output="3,6,9,12"]
----
# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
act

# ã‚³ãƒ³ãƒ†ãƒŠã‚’å†åˆ©ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆ
act -r

# ã‚¤ãƒ™ãƒ³ãƒˆã‚’æŒ‡å®šã—ã¦ãƒ†ã‚¹ãƒˆ
act workflow_dispatch

# ã‚¸ãƒ§ãƒ–åã‚’æŒ‡å®šã—ã¦ãƒ†ã‚¹ãƒˆ
act -j JOB_NAME

# Secretå¤‰æ•°ã‚’æŒ‡å®šã—ã¦ãƒ†ã‚¹ãƒˆ
act -s MY_SECRET=something
----

====

=== act ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

* ã‚³ãƒãƒ³ãƒ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³
+
ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ `./.actrc` ã¾ãŸã¯ `~/.actrc` è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¿°ã—ã¦ãŠãã“ã¨ãŒã§ãã‚‹ã€‚
+
.`.actrc` ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¾‹
====
[source,ini]
----
# runnerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å¤‰æ›´
-P ubuntu-18.04=node:12-buster
----
====

* ç’°å¢ƒå¤‰æ•°
+
ç’°å¢ƒå¤‰æ•°ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã™ã‚‹ã€‚
åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã§å‚ç…§ã•ã›ãŸã„ã¨ãã¯ `--env-file <ENV_FILE>` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã€‚

=== Dockerã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œã—ãŸã„

Docker ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã‚„ã‚‹å ´åˆã¯ _DooDï¼ˆDocker outside of Dockerï¼‰_ ã®ã‚ˆã†ã«ã€ãƒ›ã‚¹ãƒˆå´ã® `docker.sock` ã‚’ãƒã‚¤ãƒ³ãƒ‰ã—ã¦ãŠãã€‚
ï¼ˆã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã®dockerãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ä¸è¦ï¼‰

.docker.sockã‚’ãƒã‚¤ãƒ³ãƒ‰ã—ã¦ãŠã
[.no-line-numbers.command-line]
[source,bash,data-user="user",data-host="local"]
----
docker run --rm -it \
    --mount type=bind,src=/var/run/docker.sock,dst=/var/run/docker.sock \
    debian:buster-slim \
    bash
----

.ã‚³ãƒ³ãƒ†ãƒŠãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ `root` ä»¥å¤–
[TIP]
====
`docker.sock` ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã®ãŸã‚ã€ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã« `root` ã‚°ãƒ«ãƒ¼ãƒ—ã¸æ‰€å±ã•ã›ã¦ãŠãï¼ˆ`--group-add 0`ï¼‰ã€‚
ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯ä½ä¸‹ã™ã‚‹ãŒã€é–‹ç™ºç”¨ã§ã—ã‹ä½¿ã‚ãªã„ãªã‚‰è¨±å®¹ã§ãã‚‹ã€‚

[.no-line-numbers.command-line]
[source,bash,data-user="user",data-host="local"]
----
docker run --group-add 0 ...
----

====

.Windowsãƒ›ã‚¹ãƒˆã®å ´åˆ
[IMPORTANT]
====
ãƒã‚¤ãƒ³ãƒ‰ã—ãŸ `/var/run/docker.sock` ã¯æ‰€æœ‰è€… `root:root` ã§ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒ `755` ã«ãªã£ã¦ã„ã‚‹ã€‚
ã‚ˆã£ã¦ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ `root` ä»¥å¤–ã®å ´åˆã¯ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿®æ­£ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

.Windowsãƒ›ã‚¹ãƒˆã‹ã‚‰ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿®æ­£
[.no-line-numbers.command-line]
[source,powershell,data-prompt="PS >"]
----
docker exec CONTAINER_NAME chmod 660 /var/run/docker.sock
----
====

== ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ğŸ”¨

=== â—‹âœ•ã‚³ãƒãƒ³ãƒ‰ãŒãªã„

`act` ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä½¿ã† Runner ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆ_node:12.6-buster-slim_ï¼‰ã§ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‚³ãƒãƒ³ãƒ‰ãŒå°‘ãªã„ãŸã‚ã€‚
`git` ã‚³ãƒãƒ³ãƒ‰ã‚‚ãªã„ã€‚

ä»£æ›¿ã¨ã—ã¦ã€ä¸€é€šã‚Šã®ã‚³ãƒãƒ³ãƒ‰ãŒæƒã£ã¦ã„ã‚‹ _node:12-buster_ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã†ã¨ã„ã„ã€‚

[.no-line-numbers.command-line]
[source,bash,data-user="user",data-host="local"]
----
act -P ubuntu-18.04=node:12-buster
----

=== ifæ–‡ãŒæœŸå¾…ã™ã‚‹å‹•ä½œã‚’ã—ãªã„

æ¡ä»¶å¼ã‚’ `${{ }}` ã§å›²ã‚€ã¨ã„ã„ã€‚
å®Ÿéš›ã® _GitHub Actions_ ã§ã¯çœç•¥ã—ã¦ã‚‚å¤§ä¸ˆå¤«ã ãŒã€`act` ã§çœç•¥ã™ã‚‹ã¨åˆ¤å®šã—ã¦ãã‚Œãªã„å ´åˆãŒã‚ã‚‹ã£ã½ã„ã€‚

.`act` ã§å‹•ä½œã™ã‚‹ifæ–‡ã®ä¾‹
====
[source,yaml]
----
- name: install
  if: ${{ steps.yarn-cache.outputs.cache-hit != 'true' }}
  run: yarn install
----
====

== ãŠã‚ã‚Šã«ğŸ¾

`act` ã«ã‚ˆã‚Š _GitHub Actions_ ã®ãƒ†ã‚¹ãƒˆã¨ä¿®æ­£ãŒç°¡å˜ã«ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§æº€è¶³ã€‚
ãŸã ã—ã€å®Ÿéš›ã«GitHubãƒªãƒã‚¸ãƒˆãƒªã§å‹•ä½œã•ã›ã‚‹ã¨ãƒã‚°ãŒè¦‹ã¤ã‹ã‚‹å ´åˆãŒã‚ã‚‹ã®ã§æ³¨æ„ã™ã‚‹ã€‚

== å‚è€ƒ

* https://github.com/nektos/act[nektos/act]
* https://dev.classmethod.jp/articles/act-for-github-actions-local-execution-tool/[GitHub Actions ã®ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œãƒ„ãƒ¼ãƒ«ã€Œactã€ã‚’ä½¿ã†äº‹ã§ CI/CD ã‚³ãƒ³ãƒ•ã‚£ã‚°ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼ã‚’ 1 ã¤ã«ã™ã‚‹ | Developers.IO]
* https://tomgregory.com/running-docker-in-docker-on-windows/[Running Docker in Docker on Windows (Linux containers) â€“ Tom Gregory]
