__NUXT_JSONP__("/posts/github_actions_service_container", (function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L){return {data:[{posted:{filename:"github_actions_service_container.adoc",rendered:["\u003Cdiv id=\"toc\" class=\"toc\"\u003E","\u003Cdiv id=\"toctitle\"\u003E目次\u003C\u002Fdiv\u003E","\u003Cul class=\"sectlevel1\"\u003E","\u003Cli\u003E\u003Ca href=\"#_はじめに\"\u003Eはじめに🤔\u003C\u002Fa\u003E\u003C\u002Fli\u003E","\u003Cli\u003E\u003Ca href=\"#_サービスコンテナ\"\u003Eサービスコンテナ📦\u003C\u002Fa\u003E\u003C\u002Fli\u003E","\u003Cli\u003E\u003Ca href=\"#_github_actions_ワークフローで_kroki_コンテナを利用する例\"\u003E\u003Cem\u003EGitHub Actions\u003C\u002Fem\u003E ワークフローで \u003Cem\u003EKroki\u003C\u002Fem\u003E コンテナを利用する例🧾\u003C\u002Fa\u003E","\u003Cul class=\"sectlevel2\"\u003E","\u003Cli\u003E\u003Ca href=\"#_github_actions_ワークフロー\"\u003E\u003Cem\u003EGitHub Actions\u003C\u002Fem\u003E ワークフロー\u003C\u002Fa\u003E\u003C\u002Fli\u003E","\u003Cli\u003E\u003Ca href=\"#_asciidoc_の例\"\u003E\u003Cem\u003EAsciidoc\u003C\u002Fem\u003E の例\u003C\u002Fa\u003E\u003C\u002Fli\u003E",o,i,"\u003Cli\u003E\u003Ca href=\"#_おわりに\"\u003Eおわりに😎\u003C\u002Fa\u003E\u003C\u002Fli\u003E","\u003Cli\u003E\u003Ca href=\"#_参考\"\u003E参考📖\u003C\u002Fa\u003E\u003C\u002Fli\u003E",o,a,j,"\u003Ch2 id=\"_はじめに\"\u003Eはじめに🤔\u003C\u002Fh2\u003E",k,d,"\u003Cp\u003E本ブログは \u003Cem\u003EAsciidoc\u003C\u002Fem\u003E 記法で記事を書いており、その中でダイアグラム図を描画するのに \u003Cem\u003E\u003Ca href=\"https:\u002F\u002Fkroki.io\" target=\"_blank\" rel=\"noopener\"\u003EKroki\u003C\u002Fa\u003E\u003C\u002Fem\u003E APIサーバーを利用している。\u003Cbr\u003E","デフォルト設定では公式のAPIサーバーを利用するので、ブログをビルドするたびに負担をかけるのは申し訳ないなぁ、と思ってなんとかしたかった。\u003C\u002Fp\u003E",a,d,"\u003Cp\u003Eそこで \u003Cem\u003EGitHub Actions\u003C\u002Fem\u003E ワークフローで使える\u003Ca href=\"https:\u002F\u002Fdocs.github.com\u002Fja\u002Factions\u002Fguides\u002Fabout-service-containers\" target=\"_blank\" rel=\"noopener\"\u003Eサービスコンテナ\u003C\u002Fa\u003Eという機能を利用して、ビルド時に \u003Ccode\u003Ekroki\u003C\u002Fcode\u003E をセルフホストしてみる。\u003C\u002Fp\u003E",a,a,a,j,"\u003Ch2 id=\"_サービスコンテナ\"\u003E\u003Ca href=\"https:\u002F\u002Fdocs.github.com\u002Fja\u002Factions\u002Fguides\u002Fabout-service-containers\" target=\"_blank\" rel=\"noopener\"\u003Eサービスコンテナ📦\u003C\u002Fa\u003E\u003C\u002Fh2\u003E",k,d,"\u003Cp\u003E\u003Cem\u003EGitHub Actions\u003C\u002Fem\u003E ワークフローのジョブ実行時にいっしょに起動させる \u003Cem\u003EDocker\u003C\u002Fem\u003E コンテナのこと。\u003Cbr\u003E","テストやビルド時にデータベースやAPIサーバが必要なときに利用する。\u003Cbr\u003E","（公式ドキュメントでは \u003Ca href=\"https:\u002F\u002Fdocs.github.com\u002Fja\u002Factions\u002Fguides\u002Fcreating-redis-service-containers\" target=\"_blank\" rel=\"noopener\"\u003ERedis\u003C\u002Fa\u003E と \u003Ca href=\"https:\u002F\u002Fdocs.github.com\u002Fja\u002Factions\u002Fguides\u002Fcreating-postgresql-service-containers\" target=\"_blank\" rel=\"noopener\"\u003EPostgreSQL\u003C\u002Fa\u003E のサンプルが紹介されている。）\u003C\u002Fp\u003E",a,d,"\u003Cp\u003Eサービスコンテナの定義は以下のように \u003Ccode\u003Ejobs.&lt;job_id&gt;.services\u003C\u002Fcode\u003E キーで定義する。\u003Cbr\u003E","なお本記事の例はランナーマシン上での実行を前提としている。\u003C\u002Fp\u003E",a,"\u003Cdetails\u003E","\u003Csummary class=\"title\"\u003Eランナーマシン上って？\u003C\u002Fsummary\u003E",l,d,"\u003Cp\u003E\u003Cem\u003EGitHub Actions\u003C\u002Fem\u003E ワークフローにおいて、ジョブを実行する環境は用意されている環境から選ぶだけでなく、任意の \u003Cem\u003EDocker\u003C\u002Fem\u003E コンテナ上で実行させることもできる。\u003C\u002Fp\u003E",a,x,h,b,m,y,e,n,"\u003Cdiv class=\"title\"\u003Eランナーマシン or コンテナ 上でのジョブ実行\u003C\u002Fdiv\u003E","\u003Ctable class=\"tableblock frame-all grid-all stretch\"\u003E","\u003Ccolgroup\u003E","\u003Ccol style=\"width: 33.3333%;\"\u003E","\u003Ccol style=\"width: 66.6667%;\"\u003E","\u003C\u002Fcolgroup\u003E","\u003Cthead\u003E",b,"\u003Cth class=\"tableblock halign-left valign-top\"\u003Eジョブを実行する環境\u003C\u002Fth\u003E","\u003Cth class=\"tableblock halign-left valign-top\"\u003E指定方法\u003C\u002Fth\u003E",c,"\u003C\u002Fthead\u003E","\u003Ctbody\u003E",b,"\u003Ctd class=\"tableblock halign-left valign-top\"\u003E\u003Cp class=\"tableblock\"\u003Eランナーマシン\u003C\u002Fp\u003E\u003C\u002Ftd\u003E","\u003Ctd class=\"tableblock halign-left valign-top\"\u003E\u003Cp class=\"tableblock\"\u003E\u003Ccode\u003Ejobs.&lt;job_id&gt;.runs-on\u003C\u002Fcode\u003E で指定。\u003C\u002Fp\u003E\u003C\u002Ftd\u003E",c,b,"\u003Ctd class=\"tableblock halign-left valign-top\"\u003E\u003Cp class=\"tableblock\"\u003Eコンテナ\u003C\u002Fp\u003E\u003C\u002Ftd\u003E","\u003Ctd class=\"tableblock halign-left valign-top\"\u003E\u003Cp class=\"tableblock\"\u003E\u003Ccode\u003Ejobs.&lt;job_id&gt;.container\u003C\u002Fcode\u003E で指定。\u003C\u002Fp\u003E\u003C\u002Ftd\u003E",c,"\u003C\u002Ftbody\u003E",f,e,c,f,a,d,"\u003Cp\u003Eよってランナーマシン上での実行とは、 \u003Ccode\u003Ejobs.&lt;job_id&gt;.container\u003C\u002Fcode\u003E を使っていないということ。\u003C\u002Fp\u003E",a,a,"\u003C\u002Fdetails\u003E",p,"\u003Cdiv class=\"title\"\u003EExample 1. サービスコンテナの例\u003C\u002Fdiv\u003E",l,q,r,"\u003Cdiv class=\"title\"\u003E.github\u002Fworkflows\u002Fservice-container.yml\u003C\u002Fdiv\u003E",s,A,"    data-lang=\"yaml\"\u003Ejobs:",B,C,g,"    services:   \u003Ci class=\"conum\" data-value=\"1\"\u003E\u003C\u002Fi\u003E\u003Cb\u003E(1)\u003C\u002Fb\u003E","      kroki:    \u003Ci class=\"conum\" data-value=\"2\"\u003E\u003C\u002Fi\u003E\u003Cb\u003E(2)\u003C\u002Fb\u003E","        image: yuzutech\u002Fkroki   \u003Ci class=\"conum\" data-value=\"3\"\u003E\u003C\u002Fi\u003E\u003Cb\u003E(3)\u003C\u002Fb\u003E",D,"          - 8000:8000   \u003Ci class=\"conum\" data-value=\"4\"\u003E\u003C\u002Fi\u003E\u003Cb\u003E(4)\u003C\u002Fb\u003E",g,E,"      # ...\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E",t,a,u,h,b,v,"\u003Ctd\u003Eサービスコンテナを定義するキー。\u003C\u002Ftd\u003E",c,b,F,"\u003Ctd\u003Eここで指定したキーがそのままコンテナ名となる。\u003C\u002Ftd\u003E",c,b,G,"\u003Ctd\u003E利用する \u003Cem\u003EDocker\u003C\u002Fem\u003E イメージを指定。\u003C\u002Ftd\u003E",c,b,H,"\u003Ctd\u003E\u003Ccode\u003E&lt;host&gt;:&lt;container&gt;\u003C\u002Fcode\u003E を書式とするポートマッピング。\u003Cbr\u003E","ランナーマシン上で実行する場合はアクセスするために必須。\u003C\u002Ftd\u003E",c,f,a,a,a,x,h,b,m,y,e,n,"ランナーマシン上でワークフロー・ジョブを実行する場合、サービスコンテナには \u003Ccode\u003Ehttp:\u002F\u002Flocalhost:&lt;PORT&gt;\u003C\u002Fcode\u003E でアクセスできる。",e,c,f,a,"\u003Cdiv class=\"admonitionblock caution\"\u003E",h,b,m,"\u003Ci class=\"fa icon-caution\" title=\"Caution\" data-md-icon=\"local_fire_department\"\u003E\u003C\u002Fi\u003E",e,n,"\u003Cem\u003EGitHub Actions\u003C\u002Fem\u003E のローカル実行ツール \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fnektos\u002Fact\"\u003E\u003Ccode\u003Eact\u003C\u002Fcode\u003E\u003C\u002Fa\u003E では、残念ながら現時点（v0.2.20）でこのサービスコンテナに対応できていない。",e,c,f,a,a,a,j,"\u003Ch2 id=\"_github_actions_ワークフローで_kroki_コンテナを利用する例\"\u003E\u003Cem\u003EGitHub Actions\u003C\u002Fem\u003E ワークフローで \u003Cem\u003EKroki\u003C\u002Fem\u003E コンテナを利用する例🧾\u003C\u002Fh2\u003E",k,d,"\u003Cp\u003Eサービスコンテナを使って \u003Ccode\u003Ekroki\u003C\u002Fcode\u003E を利用する \u003Cem\u003EGitHub Actions\u003C\u002Fem\u003E ワークフローおよび \u003Cem\u003EAsciidoc\u003C\u002Fem\u003E と \u003Cem\u003EJavascript\u003C\u002Fem\u003E の例。\u003C\u002Fp\u003E",a,I,"\u003Ch3 id=\"_github_actions_ワークフロー\"\u003E\u003Cem\u003EGitHub Actions\u003C\u002Fem\u003E ワークフロー\u003C\u002Fh3\u003E",x,h,b,m,y,e,n,"\u003Ccode\u003Ekroki\u003C\u002Fcode\u003E の \u003Cem\u003EDocker\u003C\u002Fem\u003E コンテナの記述については\u003Ca href=\"https:\u002F\u002Fdocs.kroki.io\u002Fkroki\u002Fsetup\u002Finstall\u002F#_using_docker_compose\" target=\"_blank\" rel=\"noopener\"\u003EKroki公式ドキュメントの docker-compose.yaml\u003C\u002Fa\u003Eを参考。",e,c,f,a,d,"\u003Cp\u003Eワークフロー全体の例。\u003C\u002Fp\u003E",a,p,"\u003Cdiv class=\"title\"\u003EExample 2. サービスコンテナでkrokiを利用するワークフロー\u003C\u002Fdiv\u003E",l,q,r,"\u003Cdiv class=\"title\"\u003E.github\u002Fworkflows\u002Fasciidoc.yml\u003C\u002Fdiv\u003E",s,A,"    data-lang=\"yaml\"\u003Ename: Asciidoc with Kroki","on:","  push:","    branches:","      - main","jobs:",B,C,"    services:","      kroki:  \u003Ci class=\"conum\" data-value=\"1\"\u003E\u003C\u002Fi\u003E\u003Cb\u003E(1)\u003C\u002Fb\u003E","        image: yuzutech\u002Fkroki","        env:","          KROKI_MERMAID_HOST: mermaid   \u003Ci class=\"conum\" data-value=\"2\"\u003E\u003C\u002Fi\u003E\u003Cb\u003E(2)\u003C\u002Fb\u003E",D,"          - 8000:8000   \u003Ci class=\"conum\" data-value=\"3\"\u003E\u003C\u002Fi\u003E\u003Cb\u003E(3)\u003C\u002Fb\u003E","      mermaid:  \u003Ci class=\"conum\" data-value=\"4\"\u003E\u003C\u002Fi\u003E\u003Cb\u003E(4)\u003C\u002Fb\u003E","        image: yuzutech\u002Fkroki-mermaid",E,"      - name: checkout","        uses: actions\u002Fcheckout@v2","      - name: setup node","        uses: actions\u002Fsetup-node@v1","        with:","          node-version: '12.x'","      - name: install packages","        run: yarn install","      - name: build","        run: yarn build\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E",t,a,u,h,b,v,"\u003Ctd\u003E\u003Ccode\u003Ekroki\u003C\u002Fcode\u003E コンテナの定義を行う。\u003C\u002Ftd\u003E",c,b,F,"\u003Ctd\u003E\u003Ccode\u003EMermaid\u003C\u002Fcode\u003E 記法は別コンテナで提供されるため、この環境変数に \u003Ccode\u003Emermaid\u003C\u002Fcode\u003E コンテナ名を指定しておく。\u003C\u002Ftd\u003E",c,b,G,"\u003Ctd\u003Eポートマッピング。\u003Ccode\u003Ekroki\u003C\u002Fcode\u003E コンテナは \u003Ccode\u003E8000\u003C\u002Fcode\u003E ポートを利用する。\u003C\u002Ftd\u003E",c,b,H,"\u003Ctd\u003E\u003Ccode\u003Emermaid\u003C\u002Fcode\u003E コンテナの定義。\u003C\u002Ftd\u003E",c,f,a,a,a,a,I,"\u003Ch3 id=\"_asciidoc_の例\"\u003E\u003Cem\u003EAsciidoc\u003C\u002Fem\u003E の例\u003C\u002Fh3\u003E",d,"\u003Cp\u003E\u003Ccode\u003Easciidoctor\u002Fcore\u003C\u002Fcode\u003E を利用する場合の例。\u003C\u002Fp\u003E",a,"\u003Cdiv class=\"admonitionblock important\"\u003E",h,b,m,"\u003Ci class=\"fa icon-important\" title=\"Important\" data-md-icon=\"report\"\u003E\u003C\u002Fi\u003E",e,n,"\u003Cem\u003EGitHub Actions\u003C\u002Fem\u003E ワークフローでは環境変数 \u003Ccode\u003EGITHUB_ACTIONS\u003C\u002Fcode\u003E が \u003Ccode\u003Etrue\u003C\u002Fcode\u003E に設定されているため、それを指標にして条件分岐している。",e,c,f,a,p,"\u003Cdiv class=\"title\"\u003EExample 3. Asciidoc\u003C\u002Fdiv\u003E",l,q,r,g,s,"  \u003Cpre class=\"highlight \" \u003E\u003Ccode class=\"language-asciidoc\"","    data-lang=\"asciidoc\"\u003E= サービスコンテナkrokiのテスト","ifdef::env-github[]   \u003Ci class=\"conum\" data-value=\"1\"\u003E\u003C\u002Fi\u003E\u003Cb\u003E(1)\u003C\u002Fb\u003E",":kroki-server-url: http:\u002F\u002Flocalhost:8000",":kroki-default-options: inline","endif::[]",g,"`kroki` Docerコンテナのテスト。",g,".Mermaid.js","[mermaid, mermaid.js, svg]","....","gantt","  title サンプル",g,"  section サンプルタスク","    apple :a, 2017-07-20, 1w","    banana :crit, b, 2017-07-23, 1d","    ぶどう :active, c, after b a, 1d","    オレンジ  : d, after c, 3d","....\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E",t,a,u,h,b,v,"\u003Ctd\u003E\u003Ccode\u003Eenv-github\u003C\u002Fcode\u003E 属性が設定されていれば \u003Ccode\u003Ekroki\u003C\u002Fcode\u003E はローカルサーバーのものを利用する。\u003C\u002Ftd\u003E",c,f,a,a,a,p,"\u003Cdiv class=\"title\"\u003EExample 4. Asciidocを変換するjavascript\u003C\u002Fdiv\u003E",l,q,r,g,s,"  \u003Cpre class=\"highlight \" \u003E\u003Ccode class=\"language-js\"","    data-lang=\"js\"\u003E\u002F** @type {import('@asciidoctor\u002Fcore').Asciidoctor} *\u002F","const asciidoctor = require('@asciidoctor\u002Fcore')()","const kroki = require('asciidoctor-kroki')","const { resolve } = require('path')",g,"kroki.register(asciidoctor.Extensions)",g,"const doc = asciidoctor.convertFile(resolve(__dirname, 'test.adoc'), {","  safe: 'safe',","  mkdirs: true,","  base_dir: __dirname,","  to_dir: 'dist',","  attributes: Object.assign(","    { 'allow-uri-read': true },","    process.env.GITHUB_ACTIONS != null ? { 'env-github': true } : undefined   \u003Ci class=\"conum\" data-value=\"1\"\u003E\u003C\u002Fi\u003E\u003Cb\u003E(1)\u003C\u002Fb\u003E","  ),","})",g,"\u002F\u002F output file","doc.convert()\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E",t,a,u,h,b,v,"\u003Ctd\u003E環境変数 \u003Ccode\u003EGITHUB_ACTIONS\u003C\u002Fcode\u003E が設定されていれば、条件分岐用に \u003Ccode\u003Eenv-github\u003C\u002Fcode\u003E 属性を設定しておく。\u003C\u002Ftd\u003E",c,f,a,a,a,a,a,a,j,"\u003Ch2 id=\"_おわりに\"\u003Eおわりに😎\u003C\u002Fh2\u003E",k,d,"\u003Cp\u003E\u003Cem\u003EGitHub Actions\u003C\u002Fem\u003E ワークフローのサービスコンテナを使うことで外部APIサーバーに負担をかけなくてすむようになった。\u003Cbr\u003E","ついでに外部通信がなくなることでワークフローの実行時間も短縮できた。\u003C\u002Fp\u003E",a,d,"\u003Cp\u003Eこういう便利な機能を知らなかったの悔しい😣。\u003C\u002Fp\u003E",a,a,a,j,"\u003Ch2 id=\"_参考\"\u003E参考📖\u003C\u002Fh2\u003E",k,J,"\u003Cdiv class=\"title\"\u003EGitHub Actions ワークフロー\u003C\u002Fdiv\u003E",K,w,"\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fdocs.github.com\u002Fja\u002Factions\u002Fguides\u002Fabout-service-containers\" target=\"_blank\" rel=\"noopener\"\u003Eサービスコンテナについて - GitHub Docs\u003C\u002Fa\u003E\u003C\u002Fp\u003E",i,w,"\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fdocs.github.com\u002Fja\u002Factions\u002Freference\u002Fworkflow-syntax-for-github-actions#jobsjob_idservices\" target=\"_blank\" rel=\"noopener\"\u003EGitHub Actionsのワークフロー構文 - GitHub Docs\u003C\u002Fa\u003E\u003C\u002Fp\u003E",i,o,a,J,"\u003Cdiv class=\"title\"\u003EKroki\u003C\u002Fdiv\u003E",K,w,"\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fkroki.io\" target=\"_blank\" rel=\"noopener\"\u003EKroki!\u003C\u002Fa\u003E\u003C\u002Fp\u003E",i,w,"\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FMogztter\u002Fasciidoctor-kroki\" target=\"_blank\" rel=\"noopener\"\u003EMogztter\u002Fasciidoctor-kroki: Asciidoctor.js extension to convert diagrams to images using Kroki!\u003C\u002Fa\u003E\u003C\u002Fp\u003E",i,o,a,a,a],title:"GitHub Actions ワークフローのサービスコンテナ機能を利用してみる",created_at:L,tags:["github","github-actions","kroki"],updated_at:L,author:"秋々すすき",description:z,revision:"1.0",revision_remark:z},navi:{next:{path:"\u002Fposts\u002Fnuxt_detect_props_changes",title:"Nuxtで親コンポーネントから渡されるプロパティ（props）の変更を検出する"},prev:{path:"\u002Fposts\u002Fumamusume_game_strategy_of_daiwascarlet",title:"【ウマ娘】ダイワスカーレットでURA優勝するまでの育成チャート"}},currentPath:"https:\u002F\u002Fvlike-vlife.netlify.app\u002Fposts\u002Fgithub_actions_service_container"}],fetch:{},mutations:z}}("\u003C\u002Fdiv\u003E","\u003Ctr\u003E","\u003C\u002Ftr\u003E","\u003Cdiv class=\"paragraph\"\u003E","\u003C\u002Ftd\u003E","\u003C\u002Ftable\u003E","","\u003Ctable\u003E","\u003C\u002Fli\u003E","\u003Cdiv class=\"sect1\"\u003E","\u003Cdiv class=\"sectionbody\"\u003E","\u003Cdiv class=\"content\"\u003E","\u003Ctd class=\"icon\"\u003E","\u003Ctd class=\"content\"\u003E","\u003C\u002Ful\u003E","\u003Cdiv class=\"exampleblock\"\u003E","\u003Cdiv ","    class=\"listingblock\"\u003E","  \u003Cdiv class=\"content\"\u003E","  \u003C\u002Fdiv\u003E","\u003Cdiv class=\"colist arabic\"\u003E","\u003Ctd\u003E\u003Ci class=\"conum\" data-value=\"1\"\u003E\u003C\u002Fi\u003E\u003Cb\u003E1\u003C\u002Fb\u003E\u003C\u002Ftd\u003E","\u003Cli\u003E","\u003Cdiv class=\"admonitionblock note\"\u003E","\u003Ci class=\"fa icon-note\" title=\"Note\" data-md-icon=\"info\"\u003E\u003C\u002Fi\u003E",void 0,"  \u003Cpre class=\"highlight \" \u003E\u003Ccode class=\"language-yaml\"","  build:","    runs-on: ubuntu-20.04","        ports:","    steps:","\u003Ctd\u003E\u003Ci class=\"conum\" data-value=\"2\"\u003E\u003C\u002Fi\u003E\u003Cb\u003E2\u003C\u002Fb\u003E\u003C\u002Ftd\u003E","\u003Ctd\u003E\u003Ci class=\"conum\" data-value=\"3\"\u003E\u003C\u002Fi\u003E\u003Cb\u003E3\u003C\u002Fb\u003E\u003C\u002Ftd\u003E","\u003Ctd\u003E\u003Ci class=\"conum\" data-value=\"4\"\u003E\u003C\u002Fi\u003E\u003Cb\u003E4\u003C\u002Fb\u003E\u003C\u002Ftd\u003E","\u003Cdiv class=\"sect2\"\u003E","\u003Cdiv class=\"ulist\"\u003E","\u003Cul\u003E","2021-03-26")));