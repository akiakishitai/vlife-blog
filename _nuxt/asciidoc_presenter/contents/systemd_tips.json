{"filename":"systemd_tips.adoc","rendered":"<div id=\"toc\" class=\"toc\">\n<div id=\"toctitle\">目次</div>\n<ul class=\"sectlevel1\">\n<li><a href=\"#_覚えておくと便利そうな_systemctl_サブコマンド\">🚀覚えておくと便利そうな <code>systemctl</code> サブコマンド</a></li>\n<li><a href=\"#_ユーザーモード\">🏃ユーザーモード</a></li>\n<li><a href=\"#_環境変数\">⛰️環境変数</a>\n<ul class=\"sectlevel2\">\n<li><a href=\"#_独自に設定したい場合\">独自に設定したい場合</a></li>\n</ul>\n</li>\n<li><a href=\"#_テンプレートユニット\">🍞テンプレートユニット</a></li>\n<li><a href=\"#_ユニット指定子\">🥨ユニット指定子</a></li>\n<li><a href=\"#_systemd_service\">🖨️ <em>systemd.service</em></a>\n<ul class=\"sectlevel2\">\n<li><a href=\"#_simple_と_oneshot\">simple と oneshot</a></li>\n</ul>\n</li>\n<li><a href=\"#_参考\">📖参考</a></li>\n</ul>\n</div>\n<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p><a href=\"systemd_scheduling\">前回の記事</a>を書く際に調べた <em>systemd</em> についての備忘録。</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_覚えておくと便利そうな_systemctl_サブコマンド\">🚀覚えておくと便利そうな <code>systemctl</code> サブコマンド</h2>\n<div class=\"sectionbody\">\n<table class=\"tableblock frame-all grid-all stretch table-auto overflow-x-auto\">\n<caption class=\"title\">Table 1. systemctl サブコマンドの一部</caption>\n<colgroup>\n<col style=\"width: 50%;\">\n<col style=\"width: 50%;\">\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">Command</th>\n<th class=\"tableblock halign-left valign-top\">Desc</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>systemctl --state=failed</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">失敗したユニットを表示する。</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>systemctl list-unit-files</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">すべてのユニットファイル一覧を表示する。</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>systemctl cat &lt;ユニット&gt;</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">指定したユニットのファイル内容を表示する。</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>systemctl edit &lt;ユニット&gt;</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">指定したユニットのドロップインファイル<sup class=\"footnote\">[<a id=\"_footnoteref_1\" class=\"footnote\" href=\"#_footnotedef_1\" title=\"View footnote.\">1</a>]</sup>を編集する。</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>systemctl edit --force --full &lt;ユニット&gt;</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">指定したユニットファイル自体を編集する。<br>\nユニットファイルが存在しない場合は新規作成される。</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>systemctl revert &lt;ユニット&gt;</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>systemctl edit</code> による変更を初期設定に戻す。<br>\n（ドロップインファイルは削除される）</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>systemctl list-dependencies &lt;ユニット&gt;</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">指定したユニットが依存しているユニットを表示する。</p></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_ユーザーモード\">🏃ユーザーモード</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p><em>systemd</em> はユーザーがログインすると自動的に <em>systemd</em> ユーザーインスタンスを起動し、ユーザーユニットを管理する。<br>\n各ユーザーごとの個人設定ができる。</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>systemctl</code> コマンドに <code>--user</code> オプションを付けて操作する（<code>systemctl --user enable &lt;SERVICE&gt;</code>）</p>\n</li>\n<li>\n<p>ユーザー・ユニットファイルは一般に <code>$XDG_CONFIG_HOME/systemd/user</code> <sup class=\"footnote\" id=\"_footnote_xdg_config_home\">[<a id=\"_footnoteref_2\" class=\"footnote\" href=\"#_footnotedef_2\" title=\"View footnote.\">2</a>]</sup>ディレクトリ以下に配置する。</p>\n<div class=\"admonitionblock tip\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-tip\" title=\"Tip\" data-md-icon=\"emoji_objects\"></i>\n</td>\n<td class=\"content\">\n<code>systemctl edit --user</code> コマンドからユニットファイルを作成すると自動的に配置されるので、こちらを推奨。\n</td>\n</tr>\n</table>\n</div>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_環境変数\">⛰️環境変数</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p><em>systemd</em> で利用できる環境変数の一覧は<a href=\"https://man.archlinux.org/man/systemd.exec.5.en#Environment_Variables_Set_or_Propagated_by_the_Service_Manager\" target=\"_blank\" rel=\"noopener\">ここを参照</a>。</p>\n</div>\n<div class=\"admonitionblock warning\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-warning\" title=\"Warning\" data-md-icon=\"warning\"></i>\n</td>\n<td class=\"content\">\n<code>~/.profile</code> や <code>~/.bash_profile</code> などに定義した環境変数は<strong>読み込まれない</strong>ことに注意。\n</td>\n</tr>\n</table>\n</div>\n<table class=\"tableblock frame-all grid-all fit-content\">\n<caption class=\"title\">Table 2. 環境変数の一部抜粋</caption>\n<colgroup>\n<col>\n<col>\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">環境変数</th>\n<th class=\"tableblock halign-left valign-top\">説明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>$PATH</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">固定値。<code>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin</code><br>\n（システムが <code>/usr</code> を使わない場合は <code>:/sbin:/bin</code> が追加される）</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>$USER</code></p></td>\n<td class=\"tableblock halign-left valign-top\" rowspan=\"2\"><p class=\"tableblock\">ユニットファイル中の <strong><em>User=</em> を設定していれば</strong>利用できる。</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>$HOME</code></p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>$PIDFILE</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">PIDファイルのパス。</p></td>\n</tr>\n</tbody>\n</table>\n<div class=\"admonitionblock tip\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-tip\" title=\"Tip\" data-md-icon=\"emoji_objects\"></i>\n</td>\n<td class=\"content\">\n後述するユニット指定子も参照するといいかも。\n</td>\n</tr>\n</table>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_独自に設定したい場合\">独自に設定したい場合</h3>\n<div class=\"paragraph\">\n<p>上述のように設定無しで使える環境変数とは別に、独自にカスタマイズした環境変数を設定したい場合は次のような方法がある。</p>\n</div>\n<div class=\"dlist\">\n<dl>\n<dt class=\"hdlist1\"><em>systemd</em> 一般</dt>\n<dd>\n<p><code>&lt;環境変数名&gt;=&lt;値&gt;</code> の書式で標準出力するスクリプトを <code>/usr/local/lib/systemd/system-environment-generators/</code> ディレクトリに配置すればいいみたい。（参考: <a href=\"https://man.archlinux.org/man/systemd.environment-generator.7.en\" target=\"_blank\" rel=\"noopener\">systemd.environment-generator(7) — Arch manual pages</a>）</p>\n<div class=\"paragraph\">\n<p>スクリプトファイル名には起動順序用の数値を接頭辞につけることが推奨される（例: <code>50-hoge.sh</code>）。</p>\n</div>\n</dd>\n<dt class=\"hdlist1\">ユーザーモード限定</dt>\n<dd>\n<p><code>~/.config/environment.d/</code> や <code>/etc/environment.d/</code> ディレクトリに環境変数を記述した <code>.conf</code> ファイルを配置する（参考: <a href=\"https://man.archlinux.org/man/environment.d.5\" target=\"_blank\" rel=\"noopener\">environment.d(5) — Arch manual pages</a>）。</p>\n<div class=\"paragraph\">\n<p>この <code>.conf</code> ファイルには行ごとに <code>&lt;環境変数名&gt;=&lt;値&gt;</code> の書式で記述する。<br>\nまたファイル名には起動順序用の数値を接頭辞につけることが推奨される（例: <code>60-foo.conf</code>）。</p>\n</div>\n</dd>\n<dt class=\"hdlist1\">ユニットファイルごと</dt>\n<dd>\n<p><em>Environment=</em> や <em>EnvironmentFile=</em> 設定で指定する（参考: <a href=\"https://man.archlinux.org/man/systemd.exec.5.en#ENVIRONMENT\" target=\"_blank\" rel=\"noopener\">systemd.exec(5) — Arch manual pages</a>）。</p>\n</dd>\n</dl>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_テンプレートユニット\">🍞テンプレートユニット</h2>\n<div class=\"sectionbody\">\n<div class=\"dlist\">\n<dl>\n<dt class=\"hdlist1\">メリット</dt>\n<dd>\n<p>ユニットファイルをテンプレートユニットとして定義すると、<em>インスタンス名</em> と呼ばれる引数によってパラメータ化できる。<br>\nつまり、1つのユニットファイルから動作が異なる複数のユニットを起動できる。</p>\n</dd>\n<dt class=\"hdlist1\">定義方法</dt>\n<dd>\n<p>テンプレートユニットとして定義するには、ユニットファイル名の末尾（拡張子の直前）に <code>@</code> 記号をつける。<br>\nこのユニットファイルの中で <em>インスタンス名</em> は <a href=\"#_part_of_unit_specifiers\"><code>%i</code> 指定子</a>を使って参照する。</p>\n<div class=\"exampleblock\">\n<div class=\"content\">\n<div \n    class=\"listingblock no-line-numbers command-line\">\n\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"root\"\n    data-host=\"local\"\n    data-output=\"2-10\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">systemctl edit --force --full template-sample@.service</code></pre>\n  </div>\n</div>\n<div \n    class=\"listingblock\">\n\n  <div class=\"content\">\n  <pre class=\"highlight \" ><code class=\"language-ini\"\n    data-lang=\"ini\">[Unit]\nDescription=Unit-Template sample\n\n[Service]\nType=simple\nExecStart=/bin/bash -c 'echo %i'    <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n\n[Install]\nWantedBy=multi-user.target</code></pre>\n  </div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td><em>インスタンス名</em> を返すだけの処理。</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n</dd>\n<dt class=\"hdlist1\">使い方</dt>\n<dd>\n<p>テンプレートユニットからユニットを開始するとき、ユニット名には <em>インスタンス名</em> を <code>@</code> 記号の直後に挿入する。<br>\n書式は <code>&lt;ユニット名&gt;@&lt;インスタンス名&gt;.service</code> のようになる。</p>\n<div class=\"exampleblock\">\n<div class=\"content\">\n<div \n    class=\"listingblock no-line-numbers command-line\">\n\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"root\"\n    data-host=\"local\"\n    data-output=\"3-10\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">systemctl start template-sample@hogehoge.service\njournalctl --unit template-sample@hogehoge.service\nOct 26 20:46:15 raspberrypi systemd[747]: Started Unit-Template sample.\nOct 26 20:46:15 raspberrypi bash[26263]: hogehoge   <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\nOct 26 20:46:15 raspberrypi systemd[747]: template-sample@hogehoge.service: Succeeded.</code></pre>\n  </div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td><em>インスタンス名</em> が引数として使われている。</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n</dd>\n</dl>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_ユニット指定子\">🥨ユニット指定子</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>ユニットファイルが読み込まれるときに置換される指定子。<br>\n指定子の一覧については<a href=\"https://man.archlinux.org/man/systemd.unit.5.en#SPECIFIERS\" target=\"_blank\" rel=\"noopener\">ここを参照</a>。<br>\n下表はそのうちのよく使いそうな一部。</p>\n</div>\n<table id=\"_part_of_unit_specifiers\" class=\"tableblock frame-all grid-all fit-content\">\n<caption class=\"title\">Table 3. 指定子の一部</caption>\n<colgroup>\n<col>\n<col>\n<col>\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">指定子</th>\n<th class=\"tableblock halign-left valign-top\">対象</th>\n<th class=\"tableblock halign-left valign-top\">説明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>%E</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">設定ファイルの<br>\nルートディレクトリ</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><em>system</em> &#8594; <code>/etc</code><br>\n<em>user</em>   &#8594; <code>$XDG_CONFIG_HOME</code> <sup class=\"footnoteref\">[<a class=\"footnote\" href=\"#_footnotedef_2\" title=\"View footnote.\">2</a>]</sup></p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>%h</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ユーザー<sup class=\"footnote\" id=\"_footnote_user\">[<a id=\"_footnoteref_3\" class=\"footnote\" href=\"#_footnotedef_3\" title=\"View footnote.\">3</a>]</sup>の<br>\nホームディレクトリ</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><em>system</em> &#8594; <code>/root</code><br>\n<em>user</em> &#8594; <code>$HOME</code></p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>%i</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">インスタンス名</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ユニットの <code>@</code> 記号から拡張子までの文字列</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>%T</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">一時ディレクトリ</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>/tmp</code> または <code>$TMPDIR</code>, <code>$TEMP</code>, <code>$TMP</code></p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>%u</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ユーザー名<sup class=\"footnoteref\">[<a class=\"footnote\" href=\"#_footnotedef_3\" title=\"View footnote.\">3</a>]</sup></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><em>system</em> &#8594; <code>root</code><br>\n<em>user</em> &#8594; <code>$USER</code></p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>%%</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">パーセント記号</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">パーセント記号（<code>%</code>）を記述したい場合</p></td>\n</tr>\n</tbody>\n</table>\n<div class=\"admonitionblock note\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-note\" title=\"Note\" data-md-icon=\"info\"></i>\n</td>\n<td class=\"content\">\n<em>XDG Base Directory</em> の仕様については <a href=\"https://wiki.archlinux.org/title/XDG_Base_Directory\" target=\"_blank\" rel=\"noopener\">XDG Base Directory - ArchWiki</a> に概要がまとめられていてわかりやすい。\n</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_systemd_service\">🖨️ <em>systemd.service</em></h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>スクリプトを実行する場合はたいてい <em>simple</em> か <em>oneshot</em> を使えばよさそう。</p>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_simple_と_oneshot\">simple と oneshot</h3>\n<div class=\"dlist\">\n<div class=\"title\">使い分け</div>\n<dl>\n<dt class=\"hdlist1\">simple</dt>\n<dd>\n<p>プロセスが起動した時点でサービスが開始されたとみなされ、後続のサービスが開始される。</p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>サービスを並列実行させたい場合</p>\n</li>\n<li>\n<p>サービスが長時間実行される場合</p>\n</li>\n</ul>\n</div>\n</dd>\n<dt class=\"hdlist1\">oneshot</dt>\n<dd>\n<p><em>ExecStart=</em> で指定したコマンドの実行完了後にユニットが開始されたとみなす。</p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>コマンド完了後に後続サービスを実行したい場合</p>\n</li>\n</ul>\n</div>\n</dd>\n</dl>\n</div>\n<div class=\"admonitionblock note\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-note\" title=\"Note\" data-md-icon=\"info\"></i>\n</td>\n<td class=\"content\">\nどっちでもいいならデフォルト推奨の <em>simple</em> を使うのが良さそう。\n</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\">📖参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://man.archlinux.org/man/systemd.unit.5.en\" target=\"_blank\" rel=\"noopener\">systemd.unit(5) — Arch manual pages</a></p>\n</li>\n<li>\n<p><a href=\"https://man.archlinux.org/man/systemd.service.5.en\" target=\"_blank\" rel=\"noopener\">systemd.service(5) — Arch manual pages</a></p>\n</li>\n<li>\n<p><a href=\"https://man.archlinux.org/man/systemd.syntax.7.en\" target=\"_blank\" rel=\"noopener\">systemd.syntax(7) — Arch manual pages</a></p>\n</li>\n<li>\n<p><a href=\"https://man.archlinux.org/man/environment.d.5\" target=\"_blank\" rel=\"noopener\">environment.d(5) — Arch manual pages</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div id=\"footnotes\">\n<hr>\n<div class=\"footnote\" id=\"_footnotedef_1\">\n<a href=\"#_footnoteref_1\">1</a>. 変更・上書きしたい設定だけを記述したファイル。\n</div>\n<div class=\"footnote\" id=\"_footnotedef_2\">\n<a href=\"#_footnoteref_2\">2</a>. デフォルト &#8594; $HOME/.config/systemd/user 。\n</div>\n<div class=\"footnote\" id=\"_footnotedef_3\">\n<a href=\"#_footnoteref_3\">3</a>. ここでのユーザーとは <em>systemd</em> 実行者のこと。<em>Service</em> セクションの <em>User=</em> 設定は影響しない。\n</div>\n</div>","title":"systemd についての Tips","created_at":"2021-10-31","tags":["linux","systemd","備忘録"],"updated_at":"2021-10-31","author":"秋々すすき","revision":"1.0"}