{"filename":"volumio_dns_server.adoc","rendered":"<div id=\"toc\" class=\"toc\">\n<div id=\"toctitle\">目次</div>\n<ul class=\"sectlevel1\">\n<li><a href=\"#_はじめに\">はじめに🧀</a></li>\n<li><a href=\"#_dnsmasq_設定\"><code>dnsmasq</code> 設定💻</a>\n<ul class=\"sectlevel2\">\n<li><a href=\"#_設定ファイル修正\">設定ファイル修正</a></li>\n<li><a href=\"#_上位dnsサーバーの設定\">上位DNSサーバーの設定</a></li>\n<li><a href=\"#_内部ホスト名\">内部ホスト名</a></li>\n<li><a href=\"#_dnsmasq_の自動起動オプションを修正\"><code>dnsmasq</code> の自動起動オプションを修正</a></li>\n</ul>\n</li>\n<li><a href=\"#_広告ブロック\">広告ブロック🚫</a>\n<ul class=\"sectlevel2\">\n<li><a href=\"#_おわりに\">おわりに😎</a></li>\n</ul>\n</li>\n<li><a href=\"#_参考\">参考📖</a></li>\n</ul>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_はじめに\">はじめに🧀</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p><em>Volumio</em> を音楽再生のためだけに常時稼働させているのがもったいないので、ついでに内部 <em>DNS</em> サーバーとしての役割も兼用してみる。</p>\n</div>\n<div class=\"paragraph\">\n<p>基本的には <code>dnsmasq</code> で <em>DNS</em> サーバーを建てる方法と一緒。<br>\nただし、<em>Volumio</em> では <code>systemd</code> ユニットの設定を修正する必要がある。</p>\n</div>\n<table class=\"tableblock frame-all grid-all stretch\">\n<caption class=\"title\">Table 1. 環境</caption>\n<colgroup>\n<col style=\"width: 50%;\">\n<col style=\"width: 50%;\">\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">Tool</th>\n<th class=\"tableblock halign-left valign-top\">Version</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Raspberry Pi 3A</p></td>\n<td class=\"tableblock halign-left valign-top\"></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Volumio</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">2.861</p></td>\n</tr>\n</tbody>\n</table>\n<div class=\"admonitionblock note\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-note\" title=\"Note\" data-md-icon=\"info\"></i>\n</td>\n<td class=\"content\">\n<div class=\"title\">テキストエディタ</div>\n<em>Volumio</em> にインストールされているエディタは <code>vim</code> ではなく <code>nano</code> になる。\n</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_dnsmasq_設定\"><code>dnsmasq</code> 設定💻</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>Volumioでは元から <code>dnsmasq</code> がインストール済みになっている。<br>\nよって <code>dnsmasq</code> の設定を編集して内部 <em>DNS</em> サーバーを実装する。</p>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_設定ファイル修正\">設定ファイル修正</h3>\n<div class=\"paragraph\">\n<p>内部 <em>DNS</em> サーバー用に設定。</p>\n</div>\n<div class=\"admonitionblock important\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-important\" title=\"Important\" data-md-icon=\"report\"></i>\n</td>\n<td class=\"content\">\n<div class=\"title\">元の設定ファイルをバックアップ</div>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"volumio\"\n    data-host=\"volumio\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">sudo cp /etc/dnsmasq.conf{,.bak}</code></pre>\n  </div>\n</div>\n</td>\n</tr>\n</table>\n</div>\n<div class=\"exampleblock\">\n<div class=\"title\">Example 1. /etc/dnsmasq.conf</div>\n<div class=\"content\">\n<div \n    class=\"listingblock\">\n\n  <div class=\"content\">\n  <pre class=\"highlight \" ><code class=\"language-ini\"\n    data-lang=\"ini\">domain-needed   <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\nbogus-priv      <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\nno-resolv       <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>\naddn-hosts=/etc/dnsmasq.hosts.d   <i class=\"conum\" data-value=\"4\"></i><b>(4)</b>\nexpand-hosts    <i class=\"conum\" data-value=\"5\"></i><b>(5)</b>\ndomain=my.homenet,192.168.100.0/24,local  <i class=\"conum\" data-value=\"6\"></i><b>(6)</b>\ncache-size=0    <i class=\"conum\" data-value=\"7\"></i><b>(7)</b>\nconf-dir=/etc/dnsmasq.d,.conf     <i class=\"conum\" data-value=\"8\"></i><b>(8)</b></code></pre>\n  </div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>ドメインが指定されていない場合は上位ネームサーバーに問い合わせない。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td><code>/etc/hosts</code> や <em>DHCP</em> リースの範囲にないプライベートIPの逆引きを上位ネームサーバーに転送しない。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>\n<td><code>/etc/resolv.conf</code> ファイルを読み込まない。<br>\n上位 <em>DNS</em> サーバの指定は後述する <code>conf-dir</code> オプションのディレクトリ以下で指定する。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"4\"></i><b>4</b></td>\n<td>読み込む <code>hosts</code> ファイルを追加する。<br>\nディレクトリパスを指定すると、そのディレクトリに含まれるすべてのファイルが読み込まれる。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"5\"></i><b>5</b></td>\n<td><code>/etc/hosts</code> に書かれたドメインなしのホスト名に、下記の <code>domain</code> プロパティ値を付加する。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"6\"></i><b>6</b></td>\n<td>任意のローカルドメインと使用するローカルLANのIPアドレス範囲を指定。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"7\"></i><b>7</b></td>\n<td>キャッシュを無効化（キャッシュポイズニング対策）。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"8\"></i><b>8</b></td>\n<td>追加で読み込みたい、他の設定ファイルがあるディレクトリパスとファイル拡張子を指定。<br>\n上位 <em>DNS</em> サーバーやブロックするドメインなどの設定は別ファイルにしたかったので記述した。</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n<div class=\"admonitionblock caution\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-caution\" title=\"Caution\" data-md-icon=\"local_fire_department\"></i>\n</td>\n<td class=\"content\">\n<em>Hotspot</em> 時に <em>Volumio</em> ドメイン名が変わるかも。\n</td>\n</tr>\n</table>\n</div>\n<div class=\"paragraph\">\n<p>設定編集後は以下のコマンドでチェックする。</p>\n</div>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">dnsmasq設定のチェック</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-host=\"volumio\"\n    data-user=\"volumio\"\n    data-output=\"2\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">/usr/sbin/dnsmasq --test\ndnsmasq: syntax check OK.</code></pre>\n  </div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_上位dnsサーバーの設定\">上位DNSサーバーの設定</h3>\n<div class=\"paragraph\">\n<p><code>resolv-file</code> プロパティで指定したファイルで上位DNSサーバーを指定する。<br>\n親ルーターとか <em>Google</em> や <em>Cloudflare</em> の公開DNSとか。</p>\n</div>\n<div class=\"exampleblock\">\n<div class=\"title\">Example 2. /etc/dnsmasq.d/nameservers.conf</div>\n<div class=\"content\">\n<div \n    class=\"listingblock\">\n\n  <div class=\"content\">\n  <pre class=\"highlight \" ><code class=\"language-ini\"\n    data-lang=\"ini\"># Cloudflare DNS\nserver=1.1.1.1\nserver=1.0.0.1</code></pre>\n  </div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_内部ホスト名\">内部ホスト名</h3>\n<div class=\"paragraph\">\n<p>内部LANにあるホストに関しては短縮名だけ記述すればいい。<br>\n今までの設定により、短縮名だけでもローカルドメインを自動的に付与するようになっているため。</p>\n</div>\n<div class=\"exampleblock\">\n<div class=\"title\">Example 3. 内部LAN用のホスト名を指定</div>\n<div class=\"content\">\n<div \n    class=\"listingblock\">\n<div class=\"title\">/etc/dnsmasq.hosts.d/internals</div>\n  <div class=\"content\">\n  <pre class=\"highlight \" ><code class=\"language-ini\"\n    data-lang=\"ini\">192.168.100.2                       volumio\n172.16.1.10   example01.other.net   example01</code></pre>\n  </div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_dnsmasq_の自動起動オプションを修正\"><code>dnsmasq</code> の自動起動オプションを修正</h3>\n<div class=\"paragraph\">\n<p><code>dnsmasq</code> の <code>systemd</code> ユニット設定を修正する。</p>\n</div>\n<div class=\"paragraph\">\n<p><em>Volumio</em> では <code>dnsmasq</code> の自動起動時に <code>--address=/#/192.168.xxx.1</code> オプションが付け加えられている。<br>\nこれによって <code>/etc/hosts</code> や <em>DHCP</em> から応答がない場合は、すべて <code>192.168.xxx.1</code> アドレスとして処理してしまう。</p>\n</div>\n<div class=\"paragraph\">\n<p>このオプションのせいで名前解決がうまくいかないので、以下の操作で取り除く。</p>\n</div>\n<div class=\"exampleblock\">\n<div class=\"content\">\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">ドロップインファイル用ディレクトリを作成</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"volumio\"\n    data-host=\"volumio\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">sudo mkdir /etc/systemd/system/dnsmasq.service.d</code></pre>\n  </div>\n</div>\n<div \n    class=\"listingblock\">\n<div class=\"title\">/etc/systemd/system/dnsmasq.service.d/override.conf</div>\n  <div class=\"content\">\n  <pre class=\"highlight \" ><code class=\"language-ini\"\n    data-lang=\"ini\">[Service]\nExecStart=  <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\nExecStart=/usr/sbin/dnsmasq -2 --interface=wlan0  <i class=\"conum\" data-value=\"2\"></i><b>(2)</b></code></pre>\n  </div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td><code>ExecStart</code> は置き換える前に空にする必要がある。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td><code>--address=&#8230;&#8203;</code> オプションを削除した起動コマンド。</td>\n</tr>\n</table>\n</div>\n<div class=\"admonitionblock caution\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-caution\" title=\"Caution\" data-md-icon=\"local_fire_department\"></i>\n</td>\n<td class=\"content\">\n<code>--interface=</code> の値は各デバイスにより違うので注意する。\n</td>\n</tr>\n</table>\n</div>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">ユニットファイルをリロードして再起動</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"volumio\"\n    data-host=\"volumio\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">sudo systemctl daemon-reload\nsudo systemctl restart dnsmasq\nsudo systemctl status dnsmasq</code></pre>\n  </div>\n</div>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>上記設定後、エラーなどがなければルーターが参照する <em>DNS</em> サーバーを <em>Volumio</em> のIPアドレスに変更しておく。</p>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_広告ブロック\">広告ブロック🚫</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>必要なら広告ドメインのブロックも行っておく。</p>\n</div>\n<div class=\"paragraph\">\n<p>広告のドメインに対して <em>NXDOMAIN</em> を返すようにすればいい。<br>\nよって <code>dnsmasq</code> 設定の <code>address</code> オプションにて、 <code>address=/ad.domain/</code> というようにIPアドレスを指定しなければいい。</p>\n</div>\n<div class=\"exampleblock\">\n<div class=\"title\">Example 4. /etc/dnsmasq.d/adblock-sample.conf</div>\n<div class=\"content\">\n<div \n    class=\"listingblock\">\n\n  <div class=\"content\">\n  <pre class=\"highlight \" ><code class=\"language-ini\"\n    data-lang=\"ini\">address=/ad.hoge.com/\naddress=/ads.hoge.com/\naddress=/ads-foo.bar.com/</code></pre>\n  </div>\n</div>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>今回は<a href=\"https://280blocker.net\" target=\"_blank\" rel=\"noopener\">280blocker</a>さんの広告ドメインリストを利用させてもらった。<br>\nこの場合、リストファイルがBOM付きUTF-8の改行コードCRLFなので、BOM無し改行LFに変換しておく必要がある。</p>\n</div>\n<div class=\"exampleblock\">\n<div class=\"content\">\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">広告ドメインリストを取得し、dnsmasq設定ファイルに変換</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"volumio\"\n    data-host=\"volumio\"\n    data-output=\"3\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">curl -Ss -o 280blocker.txt \\\n  \"https://280blocker.net/files/280blocker_domain_$(date +'%Y%m').txt\"\n\ntail --byte=+4 280blocker.txt |    <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n  sed \"s/\\r//g\" |   <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n  sed -E \"s@(^[a-zA-Z0-9].+)@address=/\\1/@g\" |  <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>\n  sudo tee /etc/dnsmasq.d/280blocker.conf &gt; /dev/null</code></pre>\n  </div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>ファイルから <em>BOM</em> を削除。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>ファイルの改行コードを <em>CRLF</em> から <em>LF</em> に変換。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>\n<td>ドメインリストを <code>dnsmasq</code> の設定プロパティ（<code>address=/&lt;domain&gt;/</code>）に変換。</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>設定終了したら <code>dnsmasq</code> を再起動。</p>\n</div>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"volumio\"\n    data-host=\"volumio\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">sudo systemctl restart dnsmasq</code></pre>\n  </div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_おわりに\">おわりに😎</h3>\n<div class=\"paragraph\">\n<p>最初 <code>vim</code> を使おうとしてなかったのと、<code>dnsmasq</code> の起動オプションになかなか気づけなかったところで詰まってた。</p>\n</div>\n<div class=\"paragraph\">\n<p>とりあえずこれで <em>Volumio</em> 兼 <em>DNS</em> サーバーなのでエコと言い張れるはず。</p>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\">参考📖</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<div class=\"title\">dnsmasq</div>\n<ul>\n<li>\n<p><a href=\"https://wiki.archlinux.jp/index.php/Dnsmasq\" target=\"_blank\" rel=\"noopener\">dnsmasq - ArchWiki</a></p>\n</li>\n<li>\n<p><a href=\"https://manpages.ubuntu.com/manpages/bionic/man8/dnsmasq.8.html\" target=\"_blank\" rel=\"noopener\">Ubuntu Manpage: dnsmasq - A lightweight DHCP and caching DNS server.</a></p>\n</li>\n</ul>\n</div>\n<div class=\"ulist\">\n<div class=\"title\">systemd</div>\n<ul>\n<li>\n<p><a href=\"https://gihyo.jp/admin/serial/01/ubuntu-recipe/0598?page=1\" target=\"_blank\" rel=\"noopener\">第598回　systemdユニットの設定を変える：Ubuntu Weekly Recipe｜gihyo.jp … 技術評論社</a></p>\n</li>\n</ul>\n</div>\n<div class=\"ulist\">\n<div class=\"title\">/etc/hosts</div>\n<ul>\n<li>\n<p><a href=\"https://access.redhat.com/ja/solutions/2312031\" target=\"_blank\" rel=\"noopener\">RHEL クラスターノードに /etc/hosts ファイルを設定する - Red Hat Customer Portal</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","title":"Volumioで内部DNSサーバーも兼用する","created_at":"2021-02-03","tags":["volumio","raspberrypi","dns","dnsmasq"],"updated_at":"2021-02-03","author":"秋々すすき","revision":"1.0"}