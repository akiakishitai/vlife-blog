{
  "filename": "golang_and_rust_statically_linked.adoc",
  "rendered": [
    "<div id=\"toc\" class=\"toc\">",
    "<div id=\"toctitle\">目次</div>",
    "<ul class=\"sectlevel1\">",
    "<li><a href=\"#_動機\">🪓動機</a></li>",
    "<li><a href=\"#_コマンドライン\">⚙️コマンドライン</a>",
    "<ul class=\"sectlevel2\">",
    "<li><a href=\"#_go_言語\">Go 言語</a></li>",
    "<li><a href=\"#_rust_言語\">Rust 言語</a></li>",
    "</ul>",
    "</li>",
    "<li><a href=\"#_dockerfile_マルチステージでの利用例\">🐳 <em>Dockerfile</em> マルチステージでの利用例</a></li>",
    "<li><a href=\"#_参考\">📖参考</a></li>",
    "</ul>",
    "</div>",
    "<div class=\"sect1\">",
    "<h2 id=\"_動機\">🪓動機</h2>",
    "<div class=\"sectionbody\">",
    "<div class=\"paragraph\">",
    "<p>たとえば <em>Alpine</em> でビルドしたのち、他の <em>Linux</em> でも実行できるように静的リンクでビルドさせたい。</p>",
    "</div>",
    "<table class=\"tableblock frame-all grid-all stretch\">",
    "<caption class=\"title\">Table 1. 実行環境</caption>",
    "<colgroup>",
    "<col style=\"width: 50%;\">",
    "<col style=\"width: 50%;\">",
    "</colgroup>",
    "<thead>",
    "<tr>",
    "<th class=\"tableblock halign-left valign-top\">Tool</th>",
    "<th class=\"tableblock halign-left valign-top\">Version</th>",
    "</tr>",
    "</thead>",
    "<tbody>",
    "<tr>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><em>go</em></p></td>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">1.16.5</p></td>",
    "</tr>",
    "<tr>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><em>rustup</em></p></td>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">1.24.3</p></td>",
    "</tr>",
    "<tr>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><em>rustc</em></p></td>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">1.53.0</p></td>",
    "</tr>",
    "<tr>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><em>cargo</em></p></td>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">1.53.0</p></td>",
    "</tr>",
    "</tbody>",
    "</table>",
    "</div>",
    "</div>",
    "<div class=\"sect1\">",
    "<h2 id=\"_コマンドライン\">⚙️コマンドライン</h2>",
    "<div class=\"sectionbody\">",
    "<div class=\"sect2\">",
    "<h3 id=\"_go_言語\">Go 言語</h3>",
    "<div class=\"paragraph\">",
    "<p><em>C</em> 言語コードを呼び出す <em>cgo</em> を使っていると動的リンクされるらしい。<br>",
    "よって <em>cgo</em> を無効化したり、リンカーに静的リンクするオプションを渡したりする。</p>",
    "</div>",
    "<div class=\"exampleblock\">",
    "<div class=\"title\">Example 1. Go</div>",
    "<div class=\"content\">",
    "<div ",
    "    class=\"listingblock no-line-numbers command-line\">",
    "",
    "  <div class=\"content\">",
    "  <pre class=\"highlight command-line\" data-user=\"user\"",
    "    data-host=\"local\"",
    "    ><code class=\"language-bash\"",
    "    data-lang=\"bash\">export CGO_ENABLED=0    <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>",
    "go build -ldflags '-extldflags=-static'   <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>",
    "strip /path/to/binary   <i class=\"conum\" data-value=\"3\"></i><b>(3)</b></code></pre>",
    "  </div>",
    "</div>",
    "<div class=\"colist arabic\">",
    "<table>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>",
    "<td><em>C</em> 言語コードを利用してない場合は <code>cgo</code> を無効化するだけで静的リンクになる。</td>",
    "</tr>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>",
    "<td>リンカーに静的リンクであることを伝えてビルド。<br>",
    "利用しているパッケージによっては <code>-tags</code> オプションも使って <code>cgo</code> 部分をスキップする。</td>",
    "</tr>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>",
    "<td>デバッグに用いられるシンボル情報を削除してサイズ縮小。</td>",
    "</tr>",
    "</table>",
    "</div>",
    "</div>",
    "</div>",
    "</div>",
    "<div class=\"sect2\">",
    "<h3 id=\"_rust_言語\">Rust 言語</h3>",
    "<div class=\"paragraph\">",
    "<p><code>*-musl</code> ターゲットを使用すれば静的リンクになる。</p>",
    "</div>",
    "<div class=\"exampleblock\">",
    "<div class=\"title\">Example 2. Rust</div>",
    "<div class=\"content\">",
    "<div ",
    "    class=\"listingblock no-line-numbers command-line\">",
    "<div class=\"title\">x86_64 アーキテクチャの場合</div>",
    "  <div class=\"content\">",
    "  <pre class=\"highlight command-line\" data-user=\"user\"",
    "    data-host=\"local\"",
    "    ><code class=\"language-bash\"",
    "    data-lang=\"bash\">rustup target add x86_64-unknown-linux-musl   <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>",
    "cargo build --release --target x86_64-unknown-linux-musl  <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>",
    "strip /path/to/binary   <i class=\"conum\" data-value=\"3\"></i><b>(3)</b></code></pre>",
    "  </div>",
    "</div>",
    "<div class=\"colist arabic\">",
    "<table>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>",
    "<td><code>musl</code> ライブラリを利用するターゲットを追加。</td>",
    "</tr>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>",
    "<td>静的リンクでビルドするには <code>musl</code> ターゲットを使う。</td>",
    "</tr>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>",
    "<td>デバッグに用いられるシンボル情報を削除してサイズ縮小。</td>",
    "</tr>",
    "</table>",
    "</div>",
    "</div>",
    "</div>",
    "<hr>",
    "<div class=\"admonitionblock note\">",
    "<table>",
    "<tr>",
    "<td class=\"icon\">",
    "<i class=\"fa icon-note\" title=\"Note\" data-md-icon=\"info\"></i>",
    "</td>",
    "<td class=\"content\">",
    "<div class=\"title\">静的リンクの確認</div>",
    "<div class=\"paragraph\">",
    "<p><code>file</code> コマンドや <code>ldd</code> コマンドを使って確認する。</p>",
    "</div>",
    "<div ",
    "    class=\"listingblock no-line-numbers command-line\">",
    "",
    "  <div class=\"content\">",
    "  <pre class=\"highlight command-line\" data-user=\"user\"",
    "    data-host=\"local\"",
    "    data-output=\"2-10\"",
    "    ><code class=\"language-bash\"",
    "    data-lang=\"bash\">file path/to/static/binary | tr , '\\n'",
    "path/to/static/binary: ELF 64-bit LSB executable",
    " x86-64",
    " version 1 (SYSV)",
    " statically linked",
    " Go BuildID=abc...",
    " not stripped</code></pre>",
    "  </div>",
    "</div>",
    "</td>",
    "</tr>",
    "</table>",
    "</div>",
    "</div>",
    "</div>",
    "</div>",
    "<div class=\"sect1\">",
    "<h2 id=\"_dockerfile_マルチステージでの利用例\">🐳 <em>Dockerfile</em> マルチステージでの利用例</h2>",
    "<div class=\"sectionbody\">",
    "<div class=\"paragraph\">",
    "<p>もともとは <em>Dockerfile</em> でビルドさせたかったので、そのサンプル。</p>",
    "</div>",
    "<div class=\"exampleblock\">",
    "<div class=\"title\">Example 3. Go in dockerfile</div>",
    "<div class=\"content\">",
    "<div ",
    "    class=\"listingblock\">",
    "",
    "  <div class=\"content\">",
    "  <pre class=\"highlight \" ><code class=\"language-dockerfile\"",
    "    data-lang=\"dockerfile\">FROM golang:1.16-alpine AS build-go",
    "WORKDIR /go/src",
    "",
    "RUN \\",
    "  apk --no-cache add \\  <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>",
    "    git \\",
    "    binutils",
    "",
    "### Install to '/go/bin' as static binary",
    "ENV CGO_ENABLED=0",
    "ARG GO_INSTALL=\"go install -ldflags '-extldflags=-static'\"  <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>",
    "# ghq",
    "RUN ${GO_INSTALL} github.com/x-motemen/ghq@v1.2.1",
    "",
    "# stripped",
    "WORKDIR /go/bin",
    "RUN strip $(ls)",
    "",
    "# -----------------------",
    "FROM debian:buster-slim",
    "COPY --from=build-go /go/bin /usr/local/bin/",
    "RUN ...</code></pre>",
    "  </div>",
    "</div>",
    "<div class=\"colist arabic\">",
    "<table>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>",
    "<td>必要なパッケージ<sup class=\"footnote\">[<a id=\"_footnoteref_1\" class=\"footnote\" href=\"#_footnotedef_1\" title=\"View footnote.\">1</a>]</sup>をインストール。</td>",
    "</tr>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>",
    "<td>リモートリポジトリのパッケージをビルドするため、 <code>go build</code> の代わりに <code>go install</code> を利用。</td>",
    "</tr>",
    "</table>",
    "</div>",
    "</div>",
    "</div>",
    "<div class=\"exampleblock\">",
    "<div class=\"title\">Example 4. Rust in dockerfile</div>",
    "<div class=\"content\">",
    "<div class=\"paragraph\">",
    "<p><code>*-unknown-linux-musl</code> ターゲットを追加して利用することで、静的リンクにできる。</p>",
    "</div>",
    "<div ",
    "    class=\"listingblock\">",
    "",
    "  <div class=\"content\">",
    "  <pre class=\"highlight \" ><code class=\"language-dockerfile\"",
    "    data-lang=\"dockerfile\">FROM rust:1.53-alpine AS build-rust",
    "",
    "ENV CARGO_HOME=/cargo",
    "WORKDIR ${CARGO_HOME}/bin",
    "",
    "RUN apk --no-cache add musl-dev   <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>",
    "",
    "# Install",
    "RUN \\",
    "  cargo install --version ^0.10.1 exa &amp;&amp; \\  <i class=\"conum\" data-value=\"2\"></i><b>(2)</b> <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>",
    "  cargo install --version ^2.1.0 git-interactive-rebase-tool",
    "",
    "# Reduce binary size",
    "RUN strip $(ls)",
    "",
    "# -----------------------",
    "FROM debian:buster-slim",
    "COPY --from=build-rust /cargo/bin /usr/local/bin/",
    "RUN ...</code></pre>",
    "  </div>",
    "</div>",
    "<div class=\"colist arabic\">",
    "<table>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>",
    "<td>ビルドするのに必要な <code>musl-dev</code> パッケージをインストール。</td>",
    "</tr>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>",
    "<td><em>Alpine</em> ベースではデフォルトが <code>musl</code> ターゲットなので、ターゲットを追加・指定する必要がない。</td>",
    "</tr>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>",
    "<td><a href=\"https://crates.io\" target=\"_blank\" rel=\"noopener\">crates.io</a> に登録されているクレートをビルドするため、 <code>cargo install</code> を利用している。</td>",
    "</tr>",
    "</table>",
    "</div>",
    "</div>",
    "</div>",
    "</div>",
    "</div>",
    "<div class=\"sect1\">",
    "<h2 id=\"_参考\">📖参考</h2>",
    "<div class=\"sectionbody\">",
    "<div class=\"ulist\">",
    "<div class=\"title\">Go</div>",
    "<ul>",
    "<li>",
    "<p><a href=\"https://christina04.hatenablog.com/entry/installsuffix-cgo-is-no-longer-required\" target=\"_blank\" rel=\"noopener\">cgoを使わないGoのクロスコンパイル時に -installsuffix cgo が不要になってた - Carpe Diem</a></p>",
    "</li>",
    "<li>",
    "<p><a href=\"https://www.arp242.net/static-go.html\" target=\"_blank\" rel=\"noopener\">Statically compiling Go programs</a></p>",
    "</li>",
    "</ul>",
    "</div>",
    "<div class=\"ulist\">",
    "<div class=\"title\">Rust</div>",
    "<ul>",
    "<li>",
    "<p><a href=\"https://doc.rust-lang.org/edition-guide/rust-2018/platform-and-target-support/musl-support-for-fully-static-binaries.html\" target=\"_blank\" rel=\"noopener\">MUSL support for fully static binaries - The Edition Guide</a></p>",
    "</li>",
    "<li>",
    "<p><a href=\"https://blog.rust-jp.rs/tatsuya6502/posts/2019-12-statically-linked-binary/\" target=\"_blank\" rel=\"noopener\">RustのLinux muslターゲット （その1：Linux向けのポータブルなバイナリを作る）</a></p>",
    "</li>",
    "</ul>",
    "</div>",
    "</div>",
    "</div>",
    "<div id=\"footnotes\">",
    "<hr>",
    "<div class=\"footnote\" id=\"_footnotedef_1\">",
    "<a href=\"#_footnoteref_1\">1</a>. <code>binutils</code> パッケージは <code>strip</code> コマンドのためにインストールしている。",
    "</div>",
    "</div>"
  ],
  "title": "Go と Rust における静的リンクのビルド方法（+ Dockerfile サンプル）",
  "created_at": "2021-06-29",
  "tags": [
    "golang",
    "rust",
    "docker"
  ],
  "updated_at": "2021-06-29",
  "author": "秋々すすき",
  "revision": "1.0"
}