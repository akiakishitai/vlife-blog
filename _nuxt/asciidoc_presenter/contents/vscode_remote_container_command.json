{"filename":"vscode_remote_container_command.adoc","rendered":"<div id=\"toc\" class=\"toc\">\n<div id=\"toctitle\">目次</div>\n<ul class=\"sectlevel1\">\n<li><a href=\"#_はじめに\">はじめに🤔</a></li>\n<li><a href=\"#_各プロパティの実行タイミング\">各プロパティの実行タイミング🏄</a></li>\n<li><a href=\"#_おわりに\">おわりに🐾</a></li>\n<li><a href=\"#_参考\">参考📖</a></li>\n</ul>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_はじめに\">はじめに🤔</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p><em>VS Code</em> 拡張機能の <em>Remote Containers</em> を使ったときにコンテナ内でコマンド実行させるには <code>postCreateCommand</code>, <code>postStartCommand</code>, <code>postAttachCommand</code> プロパティで指定すればいい。<br>\nが、<a href=\"https://code.visualstudio.com/docs/remote/devcontainerjson-reference\" target=\"_blank\" rel=\"noopener\">devcontainer.jsonのリファレンス</a>を見ても、実際にどのタイミングで実行されるのかいまいち分からなかったのでメモ。</p>\n</div>\n<div class=\"paragraph\">\n<p>なお下記バージョンでの確認であることに注意。<br>\nGitHubのIssue見てると実行タイミングについて変更されているので、今後のバージョンによって変わることは十分ありえる。</p>\n</div>\n<table class=\"tableblock frame-all grid-all fit-content\">\n<caption class=\"title\">Table 1. 環境</caption>\n<colgroup>\n<col>\n<col>\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">App</th>\n<th class=\"tableblock halign-left valign-top\">Version</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">VS Code</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">1.52.1</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Remote-Containers</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">0.154.1</p></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_各プロパティの実行タイミング\">各プロパティの実行タイミング🏄</h2>\n<div class=\"sectionbody\">\n<details>\n<summary class=\"title\">テスト用に <code>devcontainer.json</code> ファイルを書いて確認した結果が以下の表。</summary>\n<div class=\"content\">\n<div \n    class=\"listingblock\">\n<div class=\"title\">.devcontainer/devcontainer.json</div>\n  <div class=\"content\">\n  <pre class=\"highlight \" ><code class=\"language-json\"\n    data-lang=\"json\">{\n  \"name\": \"Test for devcontainer\",\n  \"image\": \"alpine:3.12\",\n  \"extensions\": [\"mhutchie.git-graph\"],\n\n  \"postAttachCommand\": \"echo '---Attach---'\",\n  \"postCreateCommand\": \"echo '---Create---'\",\n  \"postStartCommand\": \"echo '--Start---'\"\n}</code></pre>\n  </div>\n</div>\n</div>\n</details>\n<table class=\"tableblock frame-all grid-all fit-content\">\n<caption class=\"title\">Table 2. コンテナ内でのコマンド実行</caption>\n<colgroup>\n<col>\n<col>\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">Property</th>\n<th class=\"tableblock halign-left valign-top\">Desc</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>postCreateCommand</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">コンテナ作成後、<em>dotfiles</em> や拡張機能のインストール前に実行される。<br>\nコンテナ作成時の1回のみ実行される。</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>postStartCommand</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">VS Code Server 接続後に実行される。<br>\n拡張機能以外のコンテナ設定が終わった後に実行される。<br>\nリモート接続するたびに実行される。</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>postAttachCommand</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>postStartCommand</code> の後に実行される。<br>\n拡張機能のインストールと並列実行されている。<br>\nリモート接続するたびに実行される。</p></td>\n</tr>\n</tbody>\n</table>\n<div class=\"admonitionblock note\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-note\" title=\"Note\" data-md-icon=\"info\"></i>\n</td>\n<td class=\"content\">\n各コマンドは <code>remoteUser</code> によって実行される（デフォルトは <code>root</code> ）。\n</td>\n</tr>\n</table>\n</div>\n<div class=\"imageblock kroki\">\n<div class=\"content\">\n<svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" contentStyleType=\"text/css\" height=\"610px\" preserveAspectRatio=\"none\" style=\"width:551px;height:610px;background:#FFFFFF;\" version=\"1.1\" viewBox=\"0 0 551 610\" width=\"551px\" zoomAndPan=\"magnify\"><defs/><g><rect fill=\"#F1F1F1\" height=\"33.9688\" rx=\"12.5\" ry=\"12.5\" style=\"stroke:#181818;stroke-width:0.5;\" width=\"168\" x=\"271\" y=\"11\"/><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"12\" lengthAdjust=\"spacing\" textLength=\"148\" x=\"281\" y=\"32.1387\">Remote Containers 実行</text><polygon fill=\"#F1F1F1\" points=\"261.5,64.9688,448.5,64.9688,460.5,76.9688,448.5,88.9688,261.5,88.9688,249.5,76.9688,261.5,64.9688\" style=\"stroke:#181818;stroke-width:0.5;\"/><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"11\" lengthAdjust=\"spacing\" textLength=\"187\" x=\"261.5\" y=\"80.7769\">コンテナが存在しない（初回実行）？</text><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"11\" font-weight=\"bold\" lengthAdjust=\"spacing\" textLength=\"22\" x=\"227.5\" y=\"74.3745\">yes</text><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"11\" font-weight=\"bold\" lengthAdjust=\"spacing\" textLength=\"16\" x=\"460.5\" y=\"74.3745\">no</text><rect fill=\"#F1F1F1\" height=\"47.9375\" style=\"stroke:#181818;stroke-width:0.5;\" width=\"248\" x=\"115.5\" y=\"98.9688\"/><line style=\"stroke:#181818;stroke-width:0.5;\" x1=\"120.5\" x2=\"120.5\" y1=\"98.9688\" y2=\"146.9063\"/><line style=\"stroke:#181818;stroke-width:0.5;\" x1=\"358.5\" x2=\"358.5\" y1=\"98.9688\" y2=\"146.9063\"/><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"12\" lengthAdjust=\"spacing\" textLength=\"144\" x=\"125.5\" y=\"120.1074\">コンテナの作成および起動</text><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"12\" lengthAdjust=\"spacing\" textLength=\"228\" x=\"125.5\" y=\"134.0762\">（ディレクトリやボリュームのマウント）</text><path d=\"M10,163.7578 L10,204.0234 A0,0 0 0 0 10,204.0234 L135,204.0234 A0,0 0 0 0 135,204.0234 L135,187.8906 L155,183.8906 L135,179.8906 L135,173.7578 L125,163.7578 L10,163.7578 A0,0 0 0 0 10,163.7578 \" fill=\"#FEFFDD\" style=\"stroke:#181818;stroke-width:0.5;\"/><path d=\"M125,163.7578 L125,173.7578 L135,173.7578 L125,163.7578 \" fill=\"#FEFFDD\" style=\"stroke:#181818;stroke-width:0.5;\"/><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"13\" lengthAdjust=\"spacing\" textLength=\"104\" x=\"16\" y=\"180.8247\">コンテナ作成時の</text><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"13\" lengthAdjust=\"spacing\" textLength=\"73\" x=\"16\" y=\"195.9575\">1回のみ実行</text><rect fill=\"#80DEEA\" height=\"33.9688\" rx=\"12.5\" ry=\"12.5\" style=\"stroke:#181818;stroke-width:0.5;\" width=\"169\" x=\"155\" y=\"166.9063\"/><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"12\" font-weight=\"bold\" lengthAdjust=\"spacing\" textLength=\"149\" x=\"165\" y=\"188.0449\">postCreateCommand</text><rect fill=\"#F1F1F1\" height=\"33.9688\" style=\"stroke:#181818;stroke-width:0.5;\" width=\"140\" x=\"400.5\" y=\"98.9688\"/><line style=\"stroke:#181818;stroke-width:0.5;\" x1=\"405.5\" x2=\"405.5\" y1=\"98.9688\" y2=\"132.9375\"/><line style=\"stroke:#181818;stroke-width:0.5;\" x1=\"535.5\" x2=\"535.5\" y1=\"98.9688\" y2=\"132.9375\"/><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"12\" lengthAdjust=\"spacing\" textLength=\"120\" x=\"410.5\" y=\"120.1074\">既存のコンテナに接続</text><polygon fill=\"#F1F1F1\" points=\"355,210.0234,367,222.0234,355,234.0234,343,222.0234,355,210.0234\" style=\"stroke:#181818;stroke-width:0.5;\"/><rect fill=\"#F1F1F1\" height=\"47.9375\" style=\"stroke:#181818;stroke-width:0.5;\" width=\"174\" x=\"268\" y=\"254.0234\"/><line style=\"stroke:#181818;stroke-width:0.5;\" x1=\"273\" x2=\"273\" y1=\"254.0234\" y2=\"301.9609\"/><line style=\"stroke:#181818;stroke-width:0.5;\" x1=\"437\" x2=\"437\" y1=\"254.0234\" y2=\"301.9609\"/><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"12\" lengthAdjust=\"spacing\" textLength=\"142\" x=\"278\" y=\"275.1621\">dotfilesのインストールや</text><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"12\" lengthAdjust=\"spacing\" textLength=\"154\" x=\"278\" y=\"289.1309\">.gitconfigファイルのコピー</text><rect fill=\"#F1F1F1\" height=\"33.9688\" style=\"stroke:#181818;stroke-width:0.5;\" width=\"144\" x=\"283\" y=\"321.9609\"/><line style=\"stroke:#181818;stroke-width:0.5;\" x1=\"288\" x2=\"288\" y1=\"321.9609\" y2=\"355.9297\"/><line style=\"stroke:#181818;stroke-width:0.5;\" x1=\"422\" x2=\"422\" y1=\"321.9609\" y2=\"355.9297\"/><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"12\" lengthAdjust=\"spacing\" textLength=\"124\" x=\"293\" y=\"343.0996\">VS Code Server 起動</text><rect fill=\"#555555\" height=\"6\" rx=\"2.5\" ry=\"2.5\" style=\"stroke:#555555;stroke-width:1.0;\" width=\"363\" x=\"173.5\" y=\"375.9297\"/><rect fill=\"#F1F1F1\" height=\"33.9688\" style=\"stroke:#181818;stroke-width:0.5;\" width=\"140\" x=\"187.5\" y=\"436.4141\"/><line style=\"stroke:#181818;stroke-width:0.5;\" x1=\"192.5\" x2=\"192.5\" y1=\"436.4141\" y2=\"470.3828\"/><line style=\"stroke:#181818;stroke-width:0.5;\" x1=\"322.5\" x2=\"322.5\" y1=\"436.4141\" y2=\"470.3828\"/><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"12\" lengthAdjust=\"spacing\" textLength=\"120\" x=\"197.5\" y=\"457.5527\">拡張機能インストール</text><rect fill=\"#80DEEA\" height=\"33.9688\" rx=\"12.5\" ry=\"12.5\" style=\"stroke:#181818;stroke-width:0.5;\" width=\"157\" x=\"360.5\" y=\"401.9297\"/><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"12\" font-weight=\"bold\" lengthAdjust=\"spacing\" textLength=\"137\" x=\"370.5\" y=\"423.0684\">postStartCommand</text><rect fill=\"#80DEEA\" height=\"33.9688\" rx=\"12.5\" ry=\"12.5\" style=\"stroke:#181818;stroke-width:0.5;\" width=\"167\" x=\"355.5\" y=\"470.8984\"/><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"12\" font-weight=\"bold\" lengthAdjust=\"spacing\" textLength=\"147\" x=\"365.5\" y=\"492.0371\">postAttachCommand</text><rect fill=\"#555555\" height=\"6\" rx=\"2.5\" ry=\"2.5\" style=\"stroke:#555555;stroke-width:1.0;\" width=\"363\" x=\"173.5\" y=\"524.8672\"/><rect fill=\"#F1F1F1\" height=\"47.9375\" style=\"stroke:#181818;stroke-width:0.5;\" width=\"168\" x=\"271\" y=\"550.8672\"/><line style=\"stroke:#181818;stroke-width:0.5;\" x1=\"276\" x2=\"276\" y1=\"550.8672\" y2=\"598.8047\"/><line style=\"stroke:#181818;stroke-width:0.5;\" x1=\"434\" x2=\"434\" y1=\"550.8672\" y2=\"598.8047\"/><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"12\" lengthAdjust=\"spacing\" textLength=\"88\" x=\"281\" y=\"572.0059\">セッション接続,</text><text fill=\"#000000\" font-family=\"sans-serif\" font-size=\"12\" lengthAdjust=\"spacing\" textLength=\"148\" x=\"281\" y=\"585.9746\">VS Codeウィンドウの描画</text><line style=\"stroke:#181818;stroke-width:1.0;\" x1=\"239.5\" x2=\"239.5\" y1=\"146.9063\" y2=\"166.9063\"/><polygon fill=\"#181818\" points=\"235.5,156.9063,239.5,166.9063,243.5,156.9063,239.5,160.9063\" style=\"stroke:#181818;stroke-width:1.0;\"/><line style=\"stroke:#181818;stroke-width:1.0;\" x1=\"249.5\" x2=\"239.5\" y1=\"76.9688\" y2=\"76.9688\"/><line style=\"stroke:#181818;stroke-width:1.0;\" x1=\"239.5\" x2=\"239.5\" y1=\"76.9688\" y2=\"98.9688\"/><polygon fill=\"#181818\" points=\"235.5,88.9688,239.5,98.9688,243.5,88.9688,239.5,92.9688\" style=\"stroke:#181818;stroke-width:1.0;\"/><line style=\"stroke:#181818;stroke-width:1.0;\" x1=\"460.5\" x2=\"470.5\" y1=\"76.9688\" y2=\"76.9688\"/><line style=\"stroke:#181818;stroke-width:1.0;\" x1=\"470.5\" x2=\"470.5\" y1=\"76.9688\" y2=\"98.9688\"/><polygon fill=\"#181818\" points=\"466.5,88.9688,470.5,98.9688,474.5,88.9688,470.5,92.9688\" style=\"stroke:#181818;stroke-width:1.0;\"/><line style=\"stroke:#181818;stroke-width:1.0;\" x1=\"239.5\" x2=\"239.5\" y1=\"200.875\" y2=\"222.0234\"/><line style=\"stroke:#181818;stroke-width:1.0;\" x1=\"239.5\" x2=\"343\" y1=\"222.0234\" y2=\"222.0234\"/><polygon fill=\"#181818\" points=\"333,218.0234,343,222.0234,333,226.0234,337,222.0234\" style=\"stroke:#181818;stroke-width:1.0;\"/><line style=\"stroke:#181818;stroke-width:1.0;\" x1=\"470.5\" x2=\"470.5\" y1=\"132.9375\" y2=\"222.0234\"/><line style=\"stroke:#181818;stroke-width:1.0;\" x1=\"470.5\" x2=\"367\" y1=\"222.0234\" y2=\"222.0234\"/><polygon fill=\"#181818\" points=\"377,218.0234,367,222.0234,377,226.0234,373,222.0234\" style=\"stroke:#181818;stroke-width:1.0;\"/><line style=\"stroke:#181818;stroke-width:1.0;\" x1=\"355\" x2=\"355\" y1=\"44.9688\" y2=\"64.9688\"/><polygon fill=\"#181818\" points=\"351,54.9688,355,64.9688,359,54.9688,355,58.9688\" style=\"stroke:#181818;stroke-width:1.0;\"/><line style=\"stroke:#181818;stroke-width:1.0;\" x1=\"355\" x2=\"355\" y1=\"234.0234\" y2=\"254.0234\"/><polygon fill=\"#181818\" points=\"351,244.0234,355,254.0234,359,244.0234,355,248.0234\" style=\"stroke:#181818;stroke-width:1.0;\"/><line style=\"stroke:#181818;stroke-width:1.0;\" x1=\"355\" x2=\"355\" y1=\"301.9609\" y2=\"321.9609\"/><polygon fill=\"#181818\" points=\"351,311.9609,355,321.9609,359,311.9609,355,315.9609\" style=\"stroke:#181818;stroke-width:1.0;\"/><line style=\"stroke:#181818;stroke-width:1.0;\" x1=\"439\" x2=\"439\" y1=\"435.8984\" y2=\"470.8984\"/><polygon fill=\"#181818\" points=\"435,460.8984,439,470.8984,443,460.8984,439,464.8984\" style=\"stroke:#181818;stroke-width:1.0;\"/><line style=\"stroke:#181818;stroke-width:1.0;\" x1=\"257.5\" x2=\"257.5\" y1=\"381.9297\" y2=\"436.4141\"/><polygon fill=\"#181818\" points=\"253.5,426.4141,257.5,436.4141,261.5,426.4141,257.5,430.4141\" style=\"stroke:#181818;stroke-width:1.0;\"/><line style=\"stroke:#181818;stroke-width:1.0;\" x1=\"439\" x2=\"439\" y1=\"381.9297\" y2=\"401.9297\"/><polygon fill=\"#181818\" points=\"435,391.9297,439,401.9297,443,391.9297,439,395.9297\" style=\"stroke:#181818;stroke-width:1.0;\"/><line style=\"stroke:#181818;stroke-width:1.0;\" x1=\"257.5\" x2=\"257.5\" y1=\"470.3828\" y2=\"524.8672\"/><polygon fill=\"#181818\" points=\"253.5,514.8672,257.5,524.8672,261.5,514.8672,257.5,518.8672\" style=\"stroke:#181818;stroke-width:1.0;\"/><line style=\"stroke:#181818;stroke-width:1.0;\" x1=\"439\" x2=\"439\" y1=\"504.8672\" y2=\"524.8672\"/><polygon fill=\"#181818\" points=\"435,514.8672,439,524.8672,443,514.8672,439,518.8672\" style=\"stroke:#181818;stroke-width:1.0;\"/><line style=\"stroke:#181818;stroke-width:1.0;\" x1=\"355\" x2=\"355\" y1=\"355.9297\" y2=\"375.9297\"/><polygon fill=\"#181818\" points=\"351,365.9297,355,375.9297,359,365.9297,355,369.9297\" style=\"stroke:#181818;stroke-width:1.0;\"/><line style=\"stroke:#181818;stroke-width:1.0;\" x1=\"355\" x2=\"355\" y1=\"530.8672\" y2=\"550.8672\"/><polygon fill=\"#181818\" points=\"351,540.8672,355,550.8672,359,540.8672,355,544.8672\" style=\"stroke:#181818;stroke-width:1.0;\"/><!--MD5=[488d0f1f0bb85226e0af328eb7c7733a]\n@startuml\n:Remote Containers 実行;\n\nif (コンテナが存在しない（初回実行）？) then (**yes**)\n  :コンテナの作成および起動\n  （ディレクトリやボリュームのマウント）|\n  #80DEEA:**postCreateCommand**;\n  note\n    コンテナ作成時の\n    1回のみ実行\n  end note\nelse (**no**)\n  :既存のコンテナに接続|\nendif\n\n:dotfilesのインストールや\n.gitconfigファイルのコピー|\n\n:VS Code Server 起動|\n\nfork\n  :拡張機能インストール|\nfork again\n  #80DEEA:**postStartCommand**;\n  #80DEEA:**postAttachCommand**;\nend fork\n\n:セッション接続,\nVS Codeウィンドウの描画|\n@enduml\n\nPlantUML version 1.2022.12(Sun Oct 23 18:12:26 GMT 2022)\n(GPL source distribution)\nJava Runtime: OpenJDK Runtime Environment\nJVM: OpenJDK 64-Bit Server VM\nDefault Encoding: UTF-8\nLanguage: en\nCountry: US\n--></g></svg>\n</div>\n<div class=\"title\">Figure 1. Remote Containers 実行フロー</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_おわりに\">おわりに🐾</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>とりあえず <code>postCreateCommand</code> を使っておけば大丈夫かと思ったけど、意外とそうでもなかった。</p>\n</div>\n<div class=\"paragraph\">\n<p>コマンドを1度だけ実行したいのか、毎回実行したいのかで使い分ける必要がわかってよかった。</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\">参考📖</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://code.visualstudio.com/docs/remote/devcontainerjson-reference\" target=\"_blank\" rel=\"noopener\">devcontainer.json reference</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","title":"VSCode拡張機能 Remote Containers におけるpostCreateCommandなどの実行タイミングについて","created_at":"2021-01-06","tags":["vscode","remote-containers","devcontainer.json"],"updated_at":"2021-01-06","author":"秋々すすき","revision":"1.0"}