{
  "filename": "github_actions_service_container.adoc",
  "rendered": [
    "<div id=\"toc\" class=\"toc\">",
    "<div id=\"toctitle\">目次</div>",
    "<ul class=\"sectlevel1\">",
    "<li><a href=\"#_はじめに\">はじめに🤔</a></li>",
    "<li><a href=\"#_サービスコンテナ\">サービスコンテナ📦</a></li>",
    "<li><a href=\"#_github_actions_ワークフローで_kroki_コンテナを利用する例\"><em>GitHub Actions</em> ワークフローで <em>Kroki</em> コンテナを利用する例🧾</a>",
    "<ul class=\"sectlevel2\">",
    "<li><a href=\"#_github_actions_ワークフロー\"><em>GitHub Actions</em> ワークフロー</a></li>",
    "<li><a href=\"#_asciidoc_の例\"><em>Asciidoc</em> の例</a></li>",
    "</ul>",
    "</li>",
    "<li><a href=\"#_おわりに\">おわりに😎</a></li>",
    "<li><a href=\"#_参考\">参考📖</a></li>",
    "</ul>",
    "</div>",
    "<div class=\"sect1\">",
    "<h2 id=\"_はじめに\">はじめに🤔</h2>",
    "<div class=\"sectionbody\">",
    "<div class=\"paragraph\">",
    "<p>本ブログは <em>Asciidoc</em> 記法で記事を書いており、その中でダイアグラム図を描画するのに <em><a href=\"https://kroki.io\" target=\"_blank\" rel=\"noopener\">Kroki</a></em> APIサーバーを利用している。<br>",
    "デフォルト設定では公式のAPIサーバーを利用するので、ブログをビルドするたびに負担をかけるのは申し訳ないなぁ、と思ってなんとかしたかった。</p>",
    "</div>",
    "<div class=\"paragraph\">",
    "<p>そこで <em>GitHub Actions</em> ワークフローで使える<a href=\"https://docs.github.com/ja/actions/guides/about-service-containers\" target=\"_blank\" rel=\"noopener\">サービスコンテナ</a>という機能を利用して、ビルド時に <code>kroki</code> をセルフホストしてみる。</p>",
    "</div>",
    "</div>",
    "</div>",
    "<div class=\"sect1\">",
    "<h2 id=\"_サービスコンテナ\"><a href=\"https://docs.github.com/ja/actions/guides/about-service-containers\" target=\"_blank\" rel=\"noopener\">サービスコンテナ📦</a></h2>",
    "<div class=\"sectionbody\">",
    "<div class=\"paragraph\">",
    "<p><em>GitHub Actions</em> ワークフローのジョブ実行時にいっしょに起動させる <em>Docker</em> コンテナのこと。<br>",
    "テストやビルド時にデータベースやAPIサーバが必要なときに利用する。<br>",
    "（公式ドキュメントでは <a href=\"https://docs.github.com/ja/actions/guides/creating-redis-service-containers\" target=\"_blank\" rel=\"noopener\">Redis</a> と <a href=\"https://docs.github.com/ja/actions/guides/creating-postgresql-service-containers\" target=\"_blank\" rel=\"noopener\">PostgreSQL</a> のサンプルが紹介されている。）</p>",
    "</div>",
    "<div class=\"paragraph\">",
    "<p>サービスコンテナの定義は以下のように <code>jobs.&lt;job_id&gt;.services</code> キーで定義する。<br>",
    "なお本記事の例はランナーマシン上での実行を前提としている。</p>",
    "</div>",
    "<details>",
    "<summary class=\"title\">ランナーマシン上って？</summary>",
    "<div class=\"content\">",
    "<div class=\"paragraph\">",
    "<p><em>GitHub Actions</em> ワークフローにおいて、ジョブを実行する環境は用意されている環境から選ぶだけでなく、任意の <em>Docker</em> コンテナ上で実行させることもできる。</p>",
    "</div>",
    "<div class=\"admonitionblock note\">",
    "<table>",
    "<tr>",
    "<td class=\"icon\">",
    "<i class=\"fa icon-note\" title=\"Note\" data-md-icon=\"info\"></i>",
    "</td>",
    "<td class=\"content\">",
    "<div class=\"title\">ランナーマシン or コンテナ 上でのジョブ実行</div>",
    "<table class=\"tableblock frame-all grid-all stretch\">",
    "<colgroup>",
    "<col style=\"width: 33.3333%;\">",
    "<col style=\"width: 66.6667%;\">",
    "</colgroup>",
    "<thead>",
    "<tr>",
    "<th class=\"tableblock halign-left valign-top\">ジョブを実行する環境</th>",
    "<th class=\"tableblock halign-left valign-top\">指定方法</th>",
    "</tr>",
    "</thead>",
    "<tbody>",
    "<tr>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ランナーマシン</p></td>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>jobs.&lt;job_id&gt;.runs-on</code> で指定。</p></td>",
    "</tr>",
    "<tr>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">コンテナ</p></td>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>jobs.&lt;job_id&gt;.container</code> で指定。</p></td>",
    "</tr>",
    "</tbody>",
    "</table>",
    "</td>",
    "</tr>",
    "</table>",
    "</div>",
    "<div class=\"paragraph\">",
    "<p>よってランナーマシン上での実行とは、 <code>jobs.&lt;job_id&gt;.container</code> を使っていないということ。</p>",
    "</div>",
    "</div>",
    "</details>",
    "<div class=\"exampleblock\">",
    "<div class=\"title\">Example 1. サービスコンテナの例</div>",
    "<div class=\"content\">",
    "<div ",
    "    class=\"listingblock\">",
    "<div class=\"title\">.github/workflows/service-container.yml</div>",
    "  <div class=\"content\">",
    "  <pre class=\"highlight \" ><code class=\"language-yaml\"",
    "    data-lang=\"yaml\">jobs:",
    "  build:",
    "    runs-on: ubuntu-20.04",
    "",
    "    services:   <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>",
    "      kroki:    <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>",
    "        image: yuzutech/kroki   <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>",
    "        ports:",
    "          - 8000:8000   <i class=\"conum\" data-value=\"4\"></i><b>(4)</b>",
    "",
    "    steps:",
    "      # ...</code></pre>",
    "  </div>",
    "</div>",
    "<div class=\"colist arabic\">",
    "<table>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>",
    "<td>サービスコンテナを定義するキー。</td>",
    "</tr>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>",
    "<td>ここで指定したキーがそのままコンテナ名となる。</td>",
    "</tr>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>",
    "<td>利用する <em>Docker</em> イメージを指定。</td>",
    "</tr>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"4\"></i><b>4</b></td>",
    "<td><code>&lt;host&gt;:&lt;container&gt;</code> を書式とするポートマッピング。<br>",
    "ランナーマシン上で実行する場合はアクセスするために必須。</td>",
    "</tr>",
    "</table>",
    "</div>",
    "</div>",
    "</div>",
    "<div class=\"admonitionblock note\">",
    "<table>",
    "<tr>",
    "<td class=\"icon\">",
    "<i class=\"fa icon-note\" title=\"Note\" data-md-icon=\"info\"></i>",
    "</td>",
    "<td class=\"content\">",
    "ランナーマシン上でワークフロー・ジョブを実行する場合、サービスコンテナには <code>http://localhost:&lt;PORT&gt;</code> でアクセスできる。",
    "</td>",
    "</tr>",
    "</table>",
    "</div>",
    "<div class=\"admonitionblock caution\">",
    "<table>",
    "<tr>",
    "<td class=\"icon\">",
    "<i class=\"fa icon-caution\" title=\"Caution\" data-md-icon=\"local_fire_department\"></i>",
    "</td>",
    "<td class=\"content\">",
    "<em>GitHub Actions</em> のローカル実行ツール <a href=\"https://github.com/nektos/act\"><code>act</code></a> では、残念ながら現時点（v0.2.20）でこのサービスコンテナに対応できていない。",
    "</td>",
    "</tr>",
    "</table>",
    "</div>",
    "</div>",
    "</div>",
    "<div class=\"sect1\">",
    "<h2 id=\"_github_actions_ワークフローで_kroki_コンテナを利用する例\"><em>GitHub Actions</em> ワークフローで <em>Kroki</em> コンテナを利用する例🧾</h2>",
    "<div class=\"sectionbody\">",
    "<div class=\"paragraph\">",
    "<p>サービスコンテナを使って <code>kroki</code> を利用する <em>GitHub Actions</em> ワークフローおよび <em>Asciidoc</em> と <em>Javascript</em> の例。</p>",
    "</div>",
    "<div class=\"sect2\">",
    "<h3 id=\"_github_actions_ワークフロー\"><em>GitHub Actions</em> ワークフロー</h3>",
    "<div class=\"admonitionblock note\">",
    "<table>",
    "<tr>",
    "<td class=\"icon\">",
    "<i class=\"fa icon-note\" title=\"Note\" data-md-icon=\"info\"></i>",
    "</td>",
    "<td class=\"content\">",
    "<code>kroki</code> の <em>Docker</em> コンテナの記述については<a href=\"https://docs.kroki.io/kroki/setup/install/#_using_docker_compose\" target=\"_blank\" rel=\"noopener\">Kroki公式ドキュメントの docker-compose.yaml</a>を参考。",
    "</td>",
    "</tr>",
    "</table>",
    "</div>",
    "<div class=\"paragraph\">",
    "<p>ワークフロー全体の例。</p>",
    "</div>",
    "<div class=\"exampleblock\">",
    "<div class=\"title\">Example 2. サービスコンテナでkrokiを利用するワークフロー</div>",
    "<div class=\"content\">",
    "<div ",
    "    class=\"listingblock\">",
    "<div class=\"title\">.github/workflows/asciidoc.yml</div>",
    "  <div class=\"content\">",
    "  <pre class=\"highlight \" ><code class=\"language-yaml\"",
    "    data-lang=\"yaml\">name: Asciidoc with Kroki",
    "on:",
    "  push:",
    "    branches:",
    "      - main",
    "jobs:",
    "  build:",
    "    runs-on: ubuntu-20.04",
    "    services:",
    "      kroki:  <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>",
    "        image: yuzutech/kroki",
    "        env:",
    "          KROKI_MERMAID_HOST: mermaid   <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>",
    "        ports:",
    "          - 8000:8000   <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>",
    "      mermaid:  <i class=\"conum\" data-value=\"4\"></i><b>(4)</b>",
    "        image: yuzutech/kroki-mermaid",
    "    steps:",
    "      - name: checkout",
    "        uses: actions/checkout@v2",
    "      - name: setup node",
    "        uses: actions/setup-node@v1",
    "        with:",
    "          node-version: '12.x'",
    "      - name: install packages",
    "        run: yarn install",
    "      - name: build",
    "        run: yarn build</code></pre>",
    "  </div>",
    "</div>",
    "<div class=\"colist arabic\">",
    "<table>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>",
    "<td><code>kroki</code> コンテナの定義を行う。</td>",
    "</tr>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>",
    "<td><code>Mermaid</code> 記法は別コンテナで提供されるため、この環境変数に <code>mermaid</code> コンテナ名を指定しておく。</td>",
    "</tr>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>",
    "<td>ポートマッピング。<code>kroki</code> コンテナは <code>8000</code> ポートを利用する。</td>",
    "</tr>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"4\"></i><b>4</b></td>",
    "<td><code>mermaid</code> コンテナの定義。</td>",
    "</tr>",
    "</table>",
    "</div>",
    "</div>",
    "</div>",
    "</div>",
    "<div class=\"sect2\">",
    "<h3 id=\"_asciidoc_の例\"><em>Asciidoc</em> の例</h3>",
    "<div class=\"paragraph\">",
    "<p><code>asciidoctor/core</code> を利用する場合の例。</p>",
    "</div>",
    "<div class=\"admonitionblock important\">",
    "<table>",
    "<tr>",
    "<td class=\"icon\">",
    "<i class=\"fa icon-important\" title=\"Important\" data-md-icon=\"report\"></i>",
    "</td>",
    "<td class=\"content\">",
    "<em>GitHub Actions</em> ワークフローでは環境変数 <code>GITHUB_ACTIONS</code> が <code>true</code> に設定されているため、それを指標にして条件分岐している。",
    "</td>",
    "</tr>",
    "</table>",
    "</div>",
    "<div class=\"exampleblock\">",
    "<div class=\"title\">Example 3. Asciidoc</div>",
    "<div class=\"content\">",
    "<div ",
    "    class=\"listingblock\">",
    "",
    "  <div class=\"content\">",
    "  <pre class=\"highlight \" ><code class=\"language-asciidoc\"",
    "    data-lang=\"asciidoc\">= サービスコンテナkrokiのテスト",
    "ifdef::env-github[]   <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>",
    ":kroki-server-url: http://localhost:8000",
    ":kroki-default-options: inline",
    "endif::[]",
    "",
    "`kroki` Docerコンテナのテスト。",
    "",
    ".Mermaid.js",
    "[mermaid, mermaid.js, svg]",
    "....",
    "gantt",
    "  title サンプル",
    "",
    "  section サンプルタスク",
    "    apple :a, 2017-07-20, 1w",
    "    banana :crit, b, 2017-07-23, 1d",
    "    ぶどう :active, c, after b a, 1d",
    "    オレンジ  : d, after c, 3d",
    "....</code></pre>",
    "  </div>",
    "</div>",
    "<div class=\"colist arabic\">",
    "<table>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>",
    "<td><code>env-github</code> 属性が設定されていれば <code>kroki</code> はローカルサーバーのものを利用する。</td>",
    "</tr>",
    "</table>",
    "</div>",
    "</div>",
    "</div>",
    "<div class=\"exampleblock\">",
    "<div class=\"title\">Example 4. Asciidocを変換するjavascript</div>",
    "<div class=\"content\">",
    "<div ",
    "    class=\"listingblock\">",
    "",
    "  <div class=\"content\">",
    "  <pre class=\"highlight \" ><code class=\"language-js\"",
    "    data-lang=\"js\">/** @type {import('@asciidoctor/core').Asciidoctor} */",
    "const asciidoctor = require('@asciidoctor/core')()",
    "const kroki = require('asciidoctor-kroki')",
    "const { resolve } = require('path')",
    "",
    "kroki.register(asciidoctor.Extensions)",
    "",
    "const doc = asciidoctor.convertFile(resolve(__dirname, 'test.adoc'), {",
    "  safe: 'safe',",
    "  mkdirs: true,",
    "  base_dir: __dirname,",
    "  to_dir: 'dist',",
    "  attributes: Object.assign(",
    "    { 'allow-uri-read': true },",
    "    process.env.GITHUB_ACTIONS != null ? { 'env-github': true } : undefined   <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>",
    "  ),",
    "})",
    "",
    "// output file",
    "doc.convert()</code></pre>",
    "  </div>",
    "</div>",
    "<div class=\"colist arabic\">",
    "<table>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>",
    "<td>環境変数 <code>GITHUB_ACTIONS</code> が設定されていれば、条件分岐用に <code>env-github</code> 属性を設定しておく。</td>",
    "</tr>",
    "</table>",
    "</div>",
    "</div>",
    "</div>",
    "</div>",
    "</div>",
    "</div>",
    "<div class=\"sect1\">",
    "<h2 id=\"_おわりに\">おわりに😎</h2>",
    "<div class=\"sectionbody\">",
    "<div class=\"paragraph\">",
    "<p><em>GitHub Actions</em> ワークフローのサービスコンテナを使うことで外部APIサーバーに負担をかけなくてすむようになった。<br>",
    "ついでに外部通信がなくなることでワークフローの実行時間も短縮できた。</p>",
    "</div>",
    "<div class=\"paragraph\">",
    "<p>こういう便利な機能を知らなかったの悔しい😣。</p>",
    "</div>",
    "</div>",
    "</div>",
    "<div class=\"sect1\">",
    "<h2 id=\"_参考\">参考📖</h2>",
    "<div class=\"sectionbody\">",
    "<div class=\"ulist\">",
    "<div class=\"title\">GitHub Actions ワークフロー</div>",
    "<ul>",
    "<li>",
    "<p><a href=\"https://docs.github.com/ja/actions/guides/about-service-containers\" target=\"_blank\" rel=\"noopener\">サービスコンテナについて - GitHub Docs</a></p>",
    "</li>",
    "<li>",
    "<p><a href=\"https://docs.github.com/ja/actions/reference/workflow-syntax-for-github-actions#jobsjob_idservices\" target=\"_blank\" rel=\"noopener\">GitHub Actionsのワークフロー構文 - GitHub Docs</a></p>",
    "</li>",
    "</ul>",
    "</div>",
    "<div class=\"ulist\">",
    "<div class=\"title\">Kroki</div>",
    "<ul>",
    "<li>",
    "<p><a href=\"https://kroki.io\" target=\"_blank\" rel=\"noopener\">Kroki!</a></p>",
    "</li>",
    "<li>",
    "<p><a href=\"https://github.com/Mogztter/asciidoctor-kroki\" target=\"_blank\" rel=\"noopener\">Mogztter/asciidoctor-kroki: Asciidoctor.js extension to convert diagrams to images using Kroki!</a></p>",
    "</li>",
    "</ul>",
    "</div>",
    "</div>",
    "</div>"
  ],
  "title": "GitHub Actions ワークフローのサービスコンテナ機能を利用してみる",
  "created_at": "2021-03-26",
  "tags": [
    "github",
    "github-actions",
    "kroki"
  ],
  "updated_at": "2021-03-26",
  "author": "秋々すすき",
  "revision": "1.0"
}