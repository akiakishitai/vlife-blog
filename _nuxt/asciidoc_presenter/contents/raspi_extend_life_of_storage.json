{"filename":"raspi_extend_life_of_storage.adoc","rendered":"<div id=\"toc\" class=\"toc\">\n<div id=\"toctitle\">目次</div>\n<ul class=\"sectlevel1\">\n<li><a href=\"#_はじめに\">🥧はじめに</a></li>\n<li><a href=\"#_スワップの調整\">🗃️スワップの調整</a></li>\n<li><a href=\"#_マウントオプションから_atime_を除外する\">🔪マウントオプションから <code>atime</code> を除外する</a></li>\n<li><a href=\"#_ログ\">📊ログ</a>\n<ul class=\"sectlevel2\">\n<li><a href=\"#_tmpfs_を使ってメモリ上にログを出力する\"><code>tmpfs</code> を使ってメモリ上にログを出力する</a></li>\n<li><a href=\"#_ログの出力を抑制\">ログの出力を抑制</a></li>\n<li><a href=\"#_systemd_の_journal_ログ\">systemd の journal ログ</a></li>\n</ul>\n</li>\n<li><a href=\"#_参考\">📖参考</a></li>\n</ul>\n</div>\n<div id=\"preamble\">\n<div class=\"sectionbody\">\n<table class=\"tableblock frame-all grid-all fit-content\">\n<caption class=\"title\">Table 1. 環境</caption>\n<colgroup>\n<col>\n<col>\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\"></th>\n<th class=\"tableblock halign-left valign-top\">Version</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Raspberry Pi 4B</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">4GB</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Raspberry Pi OS Lite</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Debian 10 (buster) 64bit</p></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_はじめに\">🥧はじめに</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p><em>Raspberry Pi 4B</em> で、起動ストレージへの書き込みを抑えて寿命を伸ばすために行ったことの備忘録。</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_スワップの調整\">🗃️スワップの調整</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>スワップはストレージの予約領域で読み書きを行うため、理論的には無効化したほうがストレージ寿命を伸ばせる。</p>\n</div>\n<div class=\"paragraph\">\n<p>ただし、</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>スワップはメモリの利用について最適化する</p>\n</li>\n<li>\n<p>無効化するとシステムが不安定になる恐れがある</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>という点から、無効化ではなくサイズを調整する方法をとった。</p>\n</div>\n<div class=\"exampleblock\">\n<div class=\"title\">Example 1. スワップサイズの変更</div>\n<div class=\"content\">\n<div class=\"admonitionblock note\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-note\" title=\"Note\" data-md-icon=\"info\"></i>\n</td>\n<td class=\"content\">\n<div class=\"title\">推奨サイズについて</div>\nサーバーとしての利用＆メモリ 2GB 以上 &#8594; とりあえずメモリの半分でいい（参考：<a href=\"https://help.ubuntu.com/community/SwapFaq\" target=\"_blank\" rel=\"noopener\">SwapFaq - Community Help Wiki</a>）。<br>\nあとはシステムの利用状況を見て増減しておく。\n</td>\n</tr>\n</table>\n</div>\n<div class=\"paragraph\">\n<p>変更する場合は <a href=\"https://manpages.debian.org/buster/dphys-swapfile/dphys-swapfile.8.en.html\" target=\"_blank\" rel=\"noopener\"><code>/etc/dphys-swapfile</code></a> ファイルを修正する。</p>\n</div>\n<div \n    class=\"listingblock\">\n<div class=\"title\">/etc/dphys-swapfile</div>\n  <div class=\"content\">\n  <pre class=\"highlight \" ><code class=\"language-ini\"\n    data-lang=\"ini\">CONF_SWAPSIZE=100   <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\nCONF_SWAPFILE=/var/swap     <i class=\"conum\" data-value=\"2\"></i><b>(2)</b></code></pre>\n  </div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td><strong>MB</strong> 単位でスワップサイズを指定。<br>\n👉 推奨サイズと異なるが、現在システムがメモリをほとんど使ってないので少なくしている。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>USBや外付けドライブにスワップファイルを保存したい場合はここのパスを変更する。</td>\n</tr>\n</table>\n</div>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">変更したスワップ設定を適用</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"pi\"\n    data-host=\"raspi\"\n    data-output=\"2-10\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">sudo service dphys-swapfile restart</code></pre>\n  </div>\n</div>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">スワップの確認</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"pi\"\n    data-host=\"raspi\"\n    data-output=\"2-10\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">swapon --show=NAME,TYPE,SIZE,USED\nNAME      TYPE SIZE USED\n/var/swap file 100M   0B</code></pre>\n  </div>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_マウントオプションから_atime_を除外する\">🔪マウントオプションから <code>atime</code> を除外する</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p><code>atime</code> だと頻繁に書き込み処理が発生するため、代わりに <code>noatime</code> や <code>relatime</code> を使用する。</p>\n</div>\n<div class=\"admonitionblock note\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-note\" title=\"Note\" data-md-icon=\"info\"></i>\n</td>\n<td class=\"content\">\n<div class=\"paragraph\">\n<p>ただ、最初から <code>noatime</code> に設定されているかも。</p>\n</div>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">マウントオプションの確認</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"pi\"\n    data-host=\"raspi\"\n    data-output=\"2-10\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">findmnt --target /\nTARGET SOURCE    FSTYPE OPTIONS\n/      /dev/sda2 ext4   rw,<strong class=\"text-red-400\">noatime</strong></code></pre>\n  </div>\n</div>\n</td>\n</tr>\n</table>\n</div>\n<div class=\"exampleblock\">\n<div class=\"title\">Example 2. /etc/fstab からマウントオプションを変更</div>\n<div class=\"content\">\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">/etc/fstab のサンプル</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"pi\"\n    data-host=\"raspi\"\n    data-output=\"2-10\"\n    ><code class=\"language-ini\"\n    data-lang=\"ini\"># Use noatime option\ntmpfs   /tmp            tmpfs   rw,async,nodev,nosuid,<strong class=\"text-red-400 underline\">noatime</strong>,size=256M,mode=0777               0 0\ntmpfs   /var/log        tmpfs   rw,async,noexec,nodev,nosuid,<strong class=\"text-red-400 underline\">noatime</strong>,size=64M,mode=0755         0 0</code></pre>\n  </div>\n</div>\n</div>\n</div>\n<div class=\"admonitionblock tip\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-tip\" title=\"Tip\" data-md-icon=\"emoji_objects\"></i>\n</td>\n<td class=\"content\">\n<div class=\"title\">アクセス日時情報について</div>\n<div class=\"dlist\">\n<dl>\n<dt class=\"hdlist1\">atime</dt>\n<dd>\n<p>ファイルが読み込まれる度にアクセス日時を書き込む。</p>\n</dd>\n<dt class=\"hdlist1\">noatime</dt>\n<dd>\n<p>アクセス日時を一切書き込まない。</p>\n</dd>\n<dt class=\"hdlist1\">relatime</dt>\n<dd>\n<p>ファイルに変更があった時だけアクセス日時を書き込む。<br>\n<code>noatime</code> ではうまく動かないプログラムがある場合に有効。</p>\n</dd>\n</dl>\n</div>\n</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_ログ\">📊ログ</h2>\n<div class=\"sectionbody\">\n<div class=\"sect2\">\n<h3 id=\"_tmpfs_を使ってメモリ上にログを出力する\"><code>tmpfs</code> を使ってメモリ上にログを出力する</h3>\n<div class=\"paragraph\">\n<p>事あるごとにログをストレージに書き込むことを止めさせ、代わりにメモリ上へ出力するようにさせる。<br>\n👉 <code>/var/log</code>（とついでに <code>/tmp</code>）を <code>tmpfs</code> でマウントすればいい。</p>\n</div>\n<div class=\"admonitionblock caution\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-caution\" title=\"Caution\" data-md-icon=\"local_fire_department\"></i>\n</td>\n<td class=\"content\">\nこの作業を行うと電源を落とす度にログが消えてしまうことに注意する。\n</td>\n</tr>\n</table>\n</div>\n<div class=\"admonitionblock note\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-note\" title=\"Note\" data-md-icon=\"info\"></i>\n</td>\n<td class=\"content\">\n<div class=\"paragraph\">\n<p>やっぱりログを保存しておきたいという場合は、以下のような方法が考えられる。</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>rsyslog</code> サーバーを構築して、そこへログを転送させる</p>\n</li>\n<li>\n<p>ログ保存用のUSBメモリとかを用意して、そこへログを出力する</p>\n</li>\n<li>\n<p><code>Logwatch</code> などのログ収集ツールを使う。</p>\n</li>\n</ul>\n</div>\n</td>\n</tr>\n</table>\n</div>\n<div class=\"exampleblock\">\n<div class=\"title\">Example 3. tmpfs としてマウントさせる設定</div>\n<div class=\"content\">\n<div class=\"paragraph\">\n<p><code>/var/log</code> と <code>/tmp</code> を <code>tmpfs</code> としてマウントするよう設定変更する。</p>\n</div>\n<div \n    class=\"listingblock\">\n<div class=\"title\">/etc/fstab に下記を追記</div>\n  <div class=\"content\">\n  <pre class=\"highlight \" ><code class=\"language-ini\"\n    data-lang=\"ini\">### ADD custom tmpfs\ntmpfs /tmp      tmpfs  rw,async,nodev,nosuid,noatime,size=256M,mode=0777        0 0\ntmpfs /var/log  tmpfs  rw,async,noexec,nodev,nosuid,noatime,size=64M,mode=0755  0 0</code></pre>\n  </div>\n</div>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">ログのバックアップを取っておく</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"pi\"\n    data-host=\"raspi\"\n    data-output=\"7\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">sudo tar \\      <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n    -czf /var/early-logs.tar.gz \\\n    --directory=/var/log .\nsudo rm -rf /var/log/*      <i class=\"conum\" data-value=\"2\"></i><b>(2)</b></code></pre>\n  </div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>現在の <code>/var/log</code> を圧縮してバックアップする。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>バックアップ後、<code>/var/log</code> を空にする。<br>\n👉 空ディレクトリ以外に <code>tmpfs</code> をマウントしようとするとエラーが発生するため。</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n<div class=\"exampleblock\">\n<div class=\"title\">Example 4. systemdサービスの修正</div>\n<div class=\"content\">\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">エラー対策に rsyslog.service を修正</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"pi\"\n    data-host=\"raspi\"\n    data-output=\"2,4-20\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">sudo systemctl edit rsyslog.service</code></pre>\n  </div>\n</div>\n<div \n    class=\"listingblock\">\n\n  <div class=\"content\">\n  <pre class=\"highlight \" ><code class=\"language-ini\"\n    data-lang=\"ini\">[Unit]\nAfter=local-fs.target   <i class=\"conum\" data-value=\"1\"></i><b>(1)</b></code></pre>\n  </div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td><code>fstab</code> の処理が終わってから <code>rsyslog.service</code> が起動するように修正。</td>\n</tr>\n</table>\n</div>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">修正した設定を適用</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"pi\"\n    data-host=\"raspi\"\n    data-output=\"2-10\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">sudo systemctl daemon-reload</code></pre>\n  </div>\n</div>\n</div>\n</div>\n<hr>\n<div class=\"paragraph\">\n<p>上記設定後、再起動して適用する。</p>\n</div>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">再起動して設定を適用</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"pi\"\n    data-host=\"raspi\"\n    data-output=\"2,4-10\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">sudo reboot\n\nfindmnt --target /var/log   <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\nTARGET   SOURCE FSTYPE OPTIONS\n/var/log tmpfs  tmpfs  rw,nosuid,nodev,noexec,noatime,size=65536k,mode=755</code></pre>\n  </div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td><code>/var/log</code> のマウントオプションが変更されているか確認。</td>\n</tr>\n</table>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_ログの出力を抑制\">ログの出力を抑制</h3>\n<div class=\"exampleblock\">\n<div class=\"content\">\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">rsyslog 設定を修正</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"pi\"\n    data-host=\"raspi\"\n    data-output=\"3\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">sudo cp /etc/rsyslog.conf{,.bk}\nsudo nano /etc/rsyslog.conf</code></pre>\n  </div>\n</div>\n<div \n    class=\"listingblock\">\n<div class=\"title\">デバッグ情報とプリンタ・メールのログは出力しない</div>\n  <div class=\"content\">\n  <pre class=\"highlight \" ><code class=\"language-diff\"\n    data-lang=\"diff\">diff -U 0 --label before --label after /etc/rsyslog.conf{.bk,}\n--- before\n+++ after\n@@ -62 +62 @@\n-*.*;auth,authpriv.none         -/var/log/syslog\n+*.info;auth,authpriv.none      -/var/log/syslog\n@@ -64,5 +64,5 @@\n-daemon.*                       -/var/log/daemon.log\n-kern.*                         -/var/log/kern.log\n-lpr.*                          -/var/log/lpr.log\n-mail.*                         -/var/log/mail.log\n-user.*                         -/var/log/user.log\n+daemon.warn                    -/var/log/daemon.log\n+kern.warn                      -/var/log/kern.log\n+#lpr.*                         -/var/log/lpr.log\n+#mail.*                        -/var/log/mail.log\n+user.warn                      -/var/log/user.log\n@@ -74 +74 @@\n-mail.info                      -/var/log/mail.info\n+#mail.info                     -/var/log/mail.info\n@@ -81,3 +81,3 @@\n-*.=debug;\\\n-       auth,authpriv.none;\\\n-       news.none;mail.none     -/var/log/debug\n+#*.=debug;\\\n+#      auth,authpriv.none;\\\n+#      news.none;mail.none     -/var/log/debug</code></pre>\n  </div>\n</div>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">変更したログ設定を適用</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"pi\"\n    data-host=\"raspi\"\n    data-output=\"2-10\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">sudo service rsyslog restart</code></pre>\n  </div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_systemd_の_journal_ログ\">systemd の journal ログ</h3>\n<div class=\"paragraph\">\n<p>デフォルトで <code>/run/log/journal</code> に保存される。<br>\n<code>/run</code> は <code>tmpfs</code> なので、何もする必要がない。そのままでOK。</p>\n</div>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"pi\"\n    data-host=\"raspi\"\n    data-output=\"2-10\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">findmnt --target /run/log/journal\nTARGET SOURCE FSTYPE OPTIONS\n/run   tmpfs  tmpfs  rw,nosuid,nodev,mode=755</code></pre>\n  </div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\">📖参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<div class=\"title\">tmpfs</div>\n<ul>\n<li>\n<p><a href=\"https://qiita.com/girlfellfromsky/items/953ad71ad6ed09a97dfe\" target=\"_blank\" rel=\"noopener\">ラズパイでログディレクトリをRAM DISKに移行する手順の簡略化 - Qiita</a></p>\n</li>\n</ul>\n</div>\n<div class=\"ulist\">\n<div class=\"title\">swap</div>\n<ul>\n<li>\n<p><a href=\"https://help.ubuntu.com/community/SwapFaq\" target=\"_blank\" rel=\"noopener\">SwapFaq - Community Help Wiki</a></p>\n</li>\n<li>\n<p><a href=\"https://manpages.debian.org/buster/dphys-swapfile/dphys-swapfile.8.en.html\" target=\"_blank\" rel=\"noopener\">dphys-swapfile(8) — dphys-swapfile — Debian buster — Debian Manpages</a></p>\n</li>\n</ul>\n</div>\n<div class=\"ulist\">\n<div class=\"title\">rsyslog</div>\n<ul>\n<li>\n<p><a href=\"https://knowledge.sakura.ad.jp/8969/\" target=\"_blank\" rel=\"noopener\">多機能なログ管理システム「rsyslog」の基本的な設定 | さくらのナレッジ</a></p>\n</li>\n</ul>\n</div>\n<div class=\"ulist\">\n<div class=\"title\">logrotate</div>\n<ul>\n<li>\n<p><a href=\"https://linux.die.net/man/8/logrotate\" target=\"_blank\" rel=\"noopener\">logrotate(8) - Linux man page</a></p>\n</li>\n<li>\n<p><a href=\"https://qiita.com/Esfahan/items/a8058f1eb593170855a1\" target=\"_blank\" rel=\"noopener\">任意のログをlogrotateを使って管理する - Qiita</a></p>\n</li>\n</ul>\n</div>\n<div class=\"ulist\">\n<div class=\"title\">mount</div>\n<ul>\n<li>\n<p><a href=\"https://wiki.archlinux.jp/index.php/Fstab\" target=\"_blank\" rel=\"noopener\">fstab - ArchWiki</a></p>\n</li>\n<li>\n<p><a href=\"https://linux.die.net/man/8/mount\" target=\"_blank\" rel=\"noopener\">mount(8): mount filesystem - Linux man page</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","title":"Raspberry Pi の起動ストレージ（SD/SSD/USBメモリ）の寿命を伸ばす","created_at":"2021-09-24","tags":["raspi","raspi4b","備忘録"],"updated_at":"2021-09-24","author":"秋々すすき","revision":"1.0"}