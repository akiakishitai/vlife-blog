{"filename":"linux_tmux_autostart.adoc","rendered":"<div id=\"toc\" class=\"toc\">\n<div id=\"toctitle\">目次</div>\n<ul class=\"sectlevel1\">\n<li><a href=\"#_やりたいこと\">🏄やりたいこと</a></li>\n<li><a href=\"#_tmux_をssh接続後に自動起動させる方法について\">🔭 <code>tmux</code> をSSH接続後に自動起動させる方法について</a>\n<ul class=\"sectlevel2\">\n<li><a href=\"#_クライアント側でやる場合推奨\">🌟クライアント側でやる場合（推奨）</a></li>\n<li><a href=\"#_サーバー側でやる場合\">😕サーバー側でやる場合</a></li>\n</ul>\n</li>\n<li><a href=\"#_参考\">📖参考</a></li>\n</ul>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_やりたいこと\">🏄やりたいこと</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>SSH接続時にはいつも <a href=\"https://github.com/tmux/tmux\" target=\"_blank\" rel=\"noopener\"><code>tmux</code></a> <sup class=\"footnote\">[<a id=\"_footnoteref_1\" class=\"footnote\" href=\"#_footnotedef_1\" title=\"View footnote.\">1</a>]</sup><sup class=\"footnote\">[<a id=\"_footnoteref_2\" class=\"footnote\" href=\"#_footnotedef_2\" title=\"View footnote.\">2</a>]</sup>を起動させるので、どうせなら自動起動させたい。</p>\n</div>\n<table class=\"tableblock frame-all grid-all fit-content\">\n<caption class=\"title\">Table 1. 環境</caption>\n<colgroup>\n<col>\n<col>\n<col>\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-center valign-top\"></th>\n<th class=\"tableblock halign-center valign-top\">Server</th>\n<th class=\"tableblock halign-center valign-top\">Client</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-center valign-top\"><p class=\"tableblock\"><strong>OS</strong></p></td>\n<td class=\"tableblock halign-center valign-top\"><p class=\"tableblock\">Debian10<br>\n(RaspberryPi OS Lite)</p></td>\n<td class=\"tableblock halign-center valign-top\"><p class=\"tableblock\">Windows10 Pro</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-center valign-top\"><p class=\"tableblock\"><strong>OpenSSH</strong></p></td>\n<td class=\"tableblock halign-center valign-top\"><p class=\"tableblock\">8.4p1</p></td>\n<td class=\"tableblock halign-center valign-top\"><p class=\"tableblock\">7.7p1</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-center valign-top\"><p class=\"tableblock\"><strong>tmux</strong></p></td>\n<td class=\"tableblock halign-center valign-top\"><p class=\"tableblock\">2.8</p></td>\n<td class=\"tableblock halign-center valign-top\"><p class=\"tableblock\">&#8201;&#8212;&#8201;</p></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_tmux_をssh接続後に自動起動させる方法について\">🔭 <code>tmux</code> をSSH接続後に自動起動させる方法について</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>クライアント側からやる方法と、サーバー側でやる方法の2通り。<br>\n<strong>クライアント側を推奨</strong>。</p>\n</div>\n<div class=\"admonitionblock note\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-note\" title=\"Note\" data-md-icon=\"info\"></i>\n</td>\n<td class=\"content\">\n<div class=\"title\">サーバー側での設定が非推奨の理由</div>\nうっかり設定を間違えてSSH接続が不可能になり死んだ、という悲劇が起こり得るため。<br>\nあと、SSH接続を使うツール（<em>Ansible</em> とか）で不具合が出たときが面倒（クライアント側なら別の <code>ssh_config</code> を参照させればいいだけなので修正が簡単）。\n</td>\n</tr>\n</table>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_クライアント側でやる場合推奨\">🌟クライアント側でやる場合（推奨）</h3>\n<div class=\"paragraph\">\n<p><code>ssh_config</code> の設定に追記するだけで達成できる。<br>\n以下のように、SSH接続後にリモート側で実行するコマンドを指定する <code>RemoteCommand</code> プロパティを設定すればいい。</p>\n</div>\n<div class=\"exampleblock\">\n<div class=\"title\">Example 1. クライアント側</div>\n<div class=\"content\">\n<div \n    class=\"listingblock\">\n<div class=\"title\">~/.ssh/config の例</div>\n  <div class=\"content\">\n  <pre class=\"highlight \" ><code class=\"language-diff\"\n    data-lang=\"diff\"> Host raspi\n   HostName      192.168.1.10\n   User          pi\n   Port          2222\n   IdentityFile  %d/.ssh/id_ed25519\n+  RequestTTY    yes    <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n+  RemoteCommand tmux new-session -A -s %r   <i class=\"conum\" data-value=\"2\"></i><b>(2)</b></code></pre>\n  </div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td><code>ssh</code> の <code>--tty</code> オプションと同じく、常に疑似 <em>TTY</em> を要求する。<br>\nこの設定がないと <em>open terminal failed: not a terminal</em> エラーが発生する。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>リモートログイン後に実行するコマンド。<br>\nここでは <code>tmux</code> を利用するコマンドを指定。</td>\n</tr>\n</table>\n</div>\n<table class=\"tableblock frame-all grid-all stretch\">\n<caption class=\"title\">Table 2. 実行する <code>tmux</code> コマンドについて</caption>\n<colgroup>\n<col style=\"width: 33.3333%;\">\n<col style=\"width: 66.6667%;\">\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-center valign-top\">Command</th>\n<th class=\"tableblock halign-left valign-top\">Desc</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-center valign-top\"><p class=\"tableblock\"><strong>new-session</strong></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">新規セッションを作成。</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-center valign-top\"><p class=\"tableblock\"><strong>-A</strong></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">既存のセッションがあれば接続し、新規作成はしない。<br>\n（<code>attach-session</code> と同様のふるまいにする）</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-center valign-top\"><p class=\"tableblock\"><strong>-s</strong></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">セッション名を指定。</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-center valign-top\"><p class=\"tableblock\"><strong>%r</strong></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">リモートユーザー名を表す。<br>\n<em>ssh_config</em> にて利用できる定数（<a href=\"https://manpages.debian.org/buster/openssh-client/ssh_config.5.en.html#TOKENS\" target=\"_blank\" rel=\"noopener\">参考</a>）。</p></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>あとは通常通りにSSH接続すれば、<code>tmux</code> が起動された状態になる。<br>\nまたデタッチするとSSH切断される。</p>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_サーバー側でやる場合\">😕サーバー側でやる場合</h3>\n<div class=\"paragraph\">\n<p><code>~/.profile</code> ファイル<sup class=\"footnote\">[<a id=\"_footnoteref_3\" class=\"footnote\" href=\"#_footnotedef_3\" title=\"View footnote.\">3</a>]</sup>に以下のようなスクリプト文を追記すればいい。</p>\n</div>\n<div class=\"exampleblock\">\n<div class=\"title\">Example 2. サーバー側</div>\n<div class=\"content\">\n<div class=\"paragraph\">\n<p><code>tmux</code> のセッション内ではなく、SSH接続中であり、対話的なシェル（インタラクティブモード）であれば <code>tmux</code> を起動する。</p>\n</div>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">サーバー側で tmux 自動起動の設定</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"remote\"\n    data-host=\"server\"\n    data-output=\"2-10\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">tee -a ~/.profile &lt;&lt;'EOF'\n\n# Auto start tmux when SSH connecting\nif [ -z \"$TMUX\" ] &amp;&amp; [ -n \"$SSH_TTY\" ] &amp;&amp; [[ $- =~ i ]]; then   <i class=\"conum\" data-value=\"1\"></i><b>(1)</b> <i class=\"conum\" data-value=\"2\"></i><b>(2)</b> <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>\n    tmux new-session -A -s \"$USER\"\nfi\n\nEOF</code></pre>\n  </div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td><code>[ -z \"$TMUX\" ]</code>: <code>tmux</code> のセッション内でなければ真。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td><code>[ -n \"$SSH_TTY\" ]</code>: SSH接続中であれば真。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>\n<td><code>[[ $- =~ i ]]</code>: <code>bash</code> が対話的なシェルであれば真。</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n<details>\n<summary class=\"title\"><code>[[ $- =~ i ]]</code> について補足</summary>\n<div class=\"content\">\n<div class=\"quoteblock\">\n<blockquote>\n<div class=\"paragraph\">\n<p><strong>PS1</strong> is set and <strong>$-</strong> includes <strong>i</strong> if <strong>bash</strong> is interactive, allowing a shell script or a startup file to test this state.</p>\n</div>\n</blockquote>\n<div class=\"attribution\">\n&#8212; Debian Manpages<br>\n<cite><a href=\"https://manpages.debian.org/buster/bash/bash.1.en.html\" target=\"_blank\" rel=\"noopener\">bash(1) — bash — Debian buster</a></cite>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>とうことらしい。<br>\nよって、<code>$-</code> に <code>i</code> 文字が含まれているか調べる <code>[[ $- =~ i ]]</code> が真ならば対話的なシェルだと判別できる。</p>\n</div>\n</div>\n</details>\n<div class=\"admonitionblock note\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-note\" title=\"Note\" data-md-icon=\"info\"></i>\n</td>\n<td class=\"content\">\n<code>authorized_key</code> ファイルにおいて、<a href=\"https://manpages.debian.org/buster/openssh-server/authorized_keys.5.en.html#command=_command_\"><code>command</code> オプション</a>を使うことでも実装できるらしい。\n</td>\n</tr>\n</table>\n</div>\n<hr>\n<div class=\"paragraph\">\n<p>自動化できて快適！🤗</p>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\">📖参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://manpages.debian.org/buster/tmux/tmux.1.en.html\" target=\"_blank\" rel=\"noopener\">tmux(1) — tmux — Debian buster — Debian Manpages</a></p>\n</li>\n<li>\n<p><a href=\"https://manpages.debian.org/buster/openssh-client/ssh_config.5.en.html\" target=\"_blank\" rel=\"noopener\">ssh_config(5) — openssh-client — Debian buster — Debian Manpages</a></p>\n</li>\n<li>\n<p><a href=\"https://stackoverflow.com/questions/27613209/how-to-automatically-start-tmux-on-ssh-session/29533034\" target=\"_blank\" rel=\"noopener\">How to automatically start tmux on SSH session? - Stack Overflow</a></p>\n</li>\n<li>\n<p><a href=\"https://dev.classmethod.jp/articles/ssh-bash-set-u-after-bashrc/\" target=\"_blank\" rel=\"noopener\">接続先サーバのファイルに手を付けずに、sshで接続したインタラクティブシェルで自動的にset -uする #bash #ssh | DevelopersIO</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div id=\"footnotes\">\n<hr>\n<div class=\"footnote\" id=\"_footnotedef_1\">\n<a href=\"#_footnoteref_1\">1</a>. 端末多重化ソフトと呼ばれる。セッションという単位で複数のターミナルを単一ウィンドウ管理できる。\n</div>\n<div class=\"footnote\" id=\"_footnotedef_2\">\n<a href=\"#_footnoteref_2\">2</a>. SSH接続が切断されても作業中のセッションはバックグラウンドとして継続され、再接続できるのがえらい。\n</div>\n<div class=\"footnote\" id=\"_footnotedef_3\">\n<a href=\"#_footnoteref_3\">3</a>. もしくは <code>~/.bash_profile</code> または <code>~/.bash_login</code> の3つのうちいずれか1つ。\n</div>\n</div>","title":"SSH接続時に tmux を自動起動させる","created_at":"2021-08-09","tags":["linux","ssh","tmux"],"updated_at":"2021-08-09","author":"秋々すすき","revision":"1.0"}