{
  "filename": "github_actions_dispatch.adoc",
  "rendered": [
    "<div id=\"toc\" class=\"toc\">",
    "<div id=\"toctitle\">目次</div>",
    "<ul class=\"sectlevel1\">",
    "<li><a href=\"#_はじめに\">はじめに</a>",
    "<ul class=\"sectlevel2\">",
    "<li><a href=\"#_やりたいこと\">やりたいこと💭</a></li>",
    "<li><a href=\"#_やったこと\">やったこと💪</a></li>",
    "</ul>",
    "</li>",
    "<li><a href=\"#_方法について\">方法について🍣</a>",
    "<ul class=\"sectlevel2\">",
    "<li><a href=\"#_ワークフローの手動実行\">ワークフローの手動実行</a></li>",
    "<li><a href=\"#_workflow_dispatch_イベント\"><code>workflow_dispatch</code> イベント</a></li>",
    "<li><a href=\"#_rest_api_からイベント発行\">REST API からイベント発行</a>",
    "<ul class=\"sectlevel3\">",
    "<li><a href=\"#_個人アクセストークン_personal_access_token_の作成\">個人アクセストークン（ <em>Personal Access Token</em> ）の作成</a></li>",
    "</ul>",
    "</li>",
    "<li><a href=\"#_別ワークフローからイベント発行\">別ワークフローからイベント発行</a></li>",
    "</ul>",
    "</li>",
    "<li><a href=\"#_おわりに\">おわりに😎</a></li>",
    "<li><a href=\"#_参考\">参考📖</a></li>",
    "</ul>",
    "</div>",
    "<div class=\"sect1\">",
    "<h2 id=\"_はじめに\">はじめに</h2>",
    "<div class=\"sectionbody\">",
    "<div class=\"sect2\">",
    "<h3 id=\"_やりたいこと\">やりたいこと💭</h3>",
    "<div class=\"paragraph\">",
    "<p><code>orphan</code> ブランチの更新に合わせて <code>main</code> ブランチのワークフローを実行させたい。</p>",
    "</div>",
    "<div class=\"imageblock kroki\">",
    "<div class=\"content\">",
    "<img src=\"_images/wish-1cbbd15c1584133042c230a2ac3a18784fa36117.svg\" alt=\"やりたいことのイメージ\">",
    "</div>",
    "<div class=\"title\">Figure 1. やりたいことのイメージ</div>",
    "</div>",
    "</div>",
    "<div class=\"sect2\">",
    "<h3 id=\"_やったこと\">やったこと💪</h3>",
    "<div class=\"imageblock kroki\">",
    "<div class=\"content\">",
    "<img src=\"_images/doit-57f52aed2542d93f6ac72955dc92a283b34f7ede.svg\" alt=\"doit\">",
    "</div>",
    "</div>",
    "<div class=\"paragraph\">",
    "<p>簡単にできた😊。</p>",
    "</div>",
    "</div>",
    "</div>",
    "</div>",
    "<div class=\"sect1\">",
    "<h2 id=\"_方法について\">方法について🍣</h2>",
    "<div class=\"sectionbody\">",
    "<div class=\"sect2\">",
    "<h3 id=\"_ワークフローの手動実行\">ワークフローの手動実行</h3>",
    "<div class=\"paragraph\">",
    "<p>ここでの手動実行とは、<em>GitHub</em> 上から実行したり <em>REST API</em> から実行したりすること。<br>",
    "今回は他ワークフローを呼び出したいので、<em>REST API</em> から実行することを目指す。</p>",
    "</div>",
    "<div class=\"paragraph\">",
    "<p>ワークフロー・イベントを次のどちらかに指定しておけば <em>REST API</em> からそのイベントを受信できる。</p>",
    "</div>",
    "<table class=\"tableblock frame-all grid-all stretch\">",
    "<caption class=\"title\">Table 1. 手動実行が可能となるイベント</caption>",
    "<colgroup>",
    "<col style=\"width: 33.3333%;\">",
    "<col style=\"width: 66.6667%;\">",
    "</colgroup>",
    "<thead>",
    "<tr>",
    "<th class=\"tableblock halign-left valign-top\">イベント</th>",
    "<th class=\"tableblock halign-left valign-top\">特徴</th>",
    "</tr>",
    "</thead>",
    "<tbody>",
    "<tr>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><strong><code>workflow_dispatch</code></strong></p></td>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">特定（単一）のワークフローを実行する<br>",
    "ブランチやタグの指定も可能</p></td>",
    "</tr>",
    "<tr>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>repository_dispatch</code></p></td>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">複数のワークフローを実行する<br>",
    "カスタムイベントやイベント型を作成可能</p></td>",
    "</tr>",
    "</tbody>",
    "</table>",
    "<div class=\"paragraph\">",
    "<p>他のワークフローを呼び出す目的には <code>workflow_dispatch</code> イベントが必要十分。</p>",
    "</div>",
    "</div>",
    "<div class=\"sect2\">",
    "<h3 id=\"_workflow_dispatch_イベント\"><code>workflow_dispatch</code> イベント</h3>",
    "<div class=\"paragraph\">",
    "<p>特定のワークフローを実行するために使われるイベント。<br>",
    "イベント発行時にブランチやタグの指定が可能。</p>",
    "</div>",
    "<div class=\"paragraph\">",
    "<p>デフォルト入力値やプロパティの定義は <code>github.event.inputs</code> コンテキストで設定可能。</p>",
    "</div>",
    "<div class=\"paragraph\">",
    "<p><strong><em>REST API</em> から呼び出される</strong> ワークフローがこのイベントをトリガーとするように指定する（今回だと <code>main</code> ブランチのワークフローに設定）。</p>",
    "</div>",
    "<div class=\"exampleblock\">",
    "<div class=\"title\">Example 1. mainブランチのワークフロー例</div>",
    "<div class=\"content\">",
    "<div ",
    "    class=\"listingblock\">",
    "<div class=\"title\">.github/workflows/main.yaml</div>",
    "  <div class=\"content\">",
    "  <pre class=\"highlight \" ><code class=\"language-yaml\"",
    "    data-lang=\"yaml\">on:",
    "  push:",
    "    branches:",
    "      - main",
    "  workflow_dispatch:  <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>",
    "    branches:",
    "      - main",
    "",
    "jobs:",
    "  build:",
    "    runs-on: ubuntu-18.04",
    "    steps:",
    "      - run: ...</code></pre>",
    "  </div>",
    "</div>",
    "<div class=\"colist arabic\">",
    "<table>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>",
    "<td><code>workflow_dispatch</code> イベントをトリガー</td>",
    "</tr>",
    "</table>",
    "</div>",
    "</div>",
    "</div>",
    "</div>",
    "<div class=\"sect2\">",
    "<h3 id=\"_rest_api_からイベント発行\">REST API からイベント発行</h3>",
    "<div class=\"paragraph\">",
    "<p>上記で編集したワークフローが手動実行できるかどうか、ローカルのシェルから試してみる。</p>",
    "</div>",
    "<div ",
    "    class=\"listingblock no-line-numbers command-line\">",
    "<div class=\"title\">ローカル端末からワークフローを実行</div>",
    "  <div class=\"content\">",
    "  <pre class=\"highlight command-line\" data-user=\"user\"",
    "    data-host=\"local\"",
    "    ><code class=\"language-bash\"",
    "    data-lang=\"bash\">curl -X POST \\",
    "  -H \"Authorization: token ${GITHUB_TOKEN}\" \\",
    "  -H \"Accept: application/vnd.github.v3+json\" \\",
    "  https://api.github.com/repos/${owner}/${repo}/actions/workflows/${workflow_id}/dispatches \\",
    "  -d '{\"ref\": \"main\"}'</code></pre>",
    "  </div>",
    "</div>",
    "<table class=\"tableblock frame-all grid-all stretch\">",
    "<colgroup>",
    "<col style=\"width: 20%;\">",
    "<col style=\"width: 80%;\">",
    "</colgroup>",
    "<thead>",
    "<tr>",
    "<th class=\"tableblock halign-left valign-top\">プロパティ</th>",
    "<th class=\"tableblock halign-left valign-top\">説明</th>",
    "</tr>",
    "</thead>",
    "<tbody>",
    "<tr>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">GITHUB_TOKEN</p></td>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">個人アクセストークン（<em>Personal Access Token</em>）。<br>",
    "<code>repo</code> スコープ（プライベートリポジトリを含む）ないし<br>",
    "<code>public_repo</code> スコープの許可が必要。</p></td>",
    "</tr>",
    "<tr>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">owner</p></td>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">リポジトリの所有者名</p></td>",
    "</tr>",
    "<tr>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">repo</p></td>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">リポジトリ名</p></td>",
    "</tr>",
    "<tr>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">workflow_id</p></td>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">イベント送信先の ワークフローID または<br>",
    "ワークフローの拡張子つきファイル名（例えば <code>main.yaml</code> ）</p></td>",
    "</tr>",
    "<tr>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">{\"ref\": \"&#8230;&#8203;\"}</p></td>",
    "<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ブランチやタグを指定する</p></td>",
    "</tr>",
    "</tbody>",
    "</table>",
    "<div class=\"admonitionblock note\">",
    "<table>",
    "<tr>",
    "<td class=\"icon\">",
    "<i class=\"fa icon-note\" title=\"Note\" data-md-icon=\"info\"></i>",
    "</td>",
    "<td class=\"content\">",
    "ワークフローIDは <em>REST API</em> から取得する必要があるため、ファイル名を指定するほうが簡単。",
    "</td>",
    "</tr>",
    "</table>",
    "</div>",
    "<div class=\"admonitionblock warning\">",
    "<table>",
    "<tr>",
    "<td class=\"icon\">",
    "<i class=\"fa icon-warning\" title=\"Warning\" data-md-icon=\"warning\"></i>",
    "</td>",
    "<td class=\"content\">",
    "個人アクセストークンは直書きせず、環境変数やパスワードマネージャーで設定する。",
    "</td>",
    "</tr>",
    "</table>",
    "</div>",
    "<div class=\"sect3\">",
    "<h4 id=\"_個人アクセストークン_personal_access_token_の作成\">個人アクセストークン（ <em>Personal Access Token</em> ）の作成</h4>",
    "<div class=\"paragraph\">",
    "<p><em>REST API</em> を使うために作成。<br>",
    "以前に作成して <em>Secrets</em> 登録したやつがあったのでそれを使った。</p>",
    "</div>",
    "<div class=\"paragraph\">",
    "<p>新規作成する場合は、下記ドキュメントを参考にする。</p>",
    "</div>",
    "<div class=\"olist arabic\">",
    "<ol class=\"arabic\">",
    "<li>",
    "<p><a href=\"https://docs.github.com/ja/free-pro-team@latest/github/authenticating-to-github/creating-a-personal-access-token\" target=\"_blank\" rel=\"noopener\">個人アクセストークンを使用する</a> を参考に作成</p>",
    "<div class=\"ulist\">",
    "<ul>",
    "<li>",
    "<p><code>repo</code> または <code>public_repo</code> スコープを許可する</p>",
    "</li>",
    "</ul>",
    "</div>",
    "</li>",
    "<li>",
    "<p>作成したトークンは <a href=\"https://docs.github.com/ja/free-pro-team@latest/actions/reference/encrypted-secrets\" target=\"_blank\" rel=\"noopener\">暗号化されたシークレット</a> を参考にリポジトリの <em>Secrets</em> に登録</p>",
    "</li>",
    "</ol>",
    "</div>",
    "<div class=\"paragraph\">",
    "<p>登録した <em>Secrets</em> はワークフローにおいて <code>${{ secrets.XXX }}</code> という形で参照できる。</p>",
    "</div>",
    "</div>",
    "</div>",
    "<div class=\"sect2\">",
    "<h3 id=\"_別ワークフローからイベント発行\">別ワークフローからイベント発行</h3>",
    "<div class=\"paragraph\">",
    "<p>上記の <code>curl</code> コマンドをワークフロー内で実行すればいい。</p>",
    "</div>",
    "<div class=\"exampleblock\">",
    "<div class=\"title\">Example 2. <code>orphan</code> ブランチのワークフロー例</div>",
    "<div class=\"content\">",
    "<div ",
    "    class=\"listingblock\">",
    "<div class=\"title\">.github/workflows/orphan.yaml</div>",
    "  <div class=\"content\">",
    "  <pre class=\"highlight \" ><code class=\"language-yaml\"",
    "    data-lang=\"yaml\">on:",
    "  push:",
    "    branches:",
    "      - orphan-branch",
    "",
    "env:  <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>",
    "  WORKFLOW_ID: main.yml",
    "  DISPATCH_API: https://api.github.com/repos/$GITHUB_REPOSITORY/actions/workflows/$WORKFLOW_ID/dispatches",
    "",
    "jobs:",
    "  trigger:",
    "    runs-on: ubuntu-18.04",
    "    steps:",
    "      - name: logger",
    "        run: echo \"::debug::POST to ${{ env.DISPATCH_API }}\"",
    "",
    "      - name: publish the event  <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>",
    "        run: |",
    "          curl -X POST \\",
    "            -H \"Authorization: token ${{ secrets.PERSONAL_TOKEN }}\" \\",
    "            -H \"Accept: application/vnd.github.v3+json\" \\",
    "            ${{ env.DISPATCH_API }} \\",
    "            -d '{\"ref\": \"main\"}'</code></pre>",
    "  </div>",
    "</div>",
    "<div class=\"colist arabic\">",
    "<table>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>",
    "<td>環境変数としてURLを設定</td>",
    "</tr>",
    "<tr>",
    "<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>",
    "<td><em>REST API</em> から <code>workflow_dispatch</code> イベントを発行</td>",
    "</tr>",
    "</table>",
    "</div>",
    "<div class=\"admonitionblock note\">",
    "<table>",
    "<tr>",
    "<td class=\"icon\">",
    "<i class=\"fa icon-note\" title=\"Note\" data-md-icon=\"info\"></i>",
    "</td>",
    "<td class=\"content\">",
    "<code>GITHUB_REPOSITORY</code> はデフォルト環境変数で、 <code>オーナー名/リポジトリ名</code> が設定されている。",
    "</td>",
    "</tr>",
    "</table>",
    "</div>",
    "<div class=\"admonitionblock note\">",
    "<table>",
    "<tr>",
    "<td class=\"icon\">",
    "<i class=\"fa icon-note\" title=\"Note\" data-md-icon=\"info\"></i>",
    "</td>",
    "<td class=\"content\">",
    "<code>env</code> の変数で他の環境変数を使った場合に <code>steps</code> 内で参照するときは、<br>",
    "<code>${{ env.XXX }}</code> としないとうまく環境変数を展開してくれなかった。",
    "</td>",
    "</tr>",
    "</table>",
    "</div>",
    "</div>",
    "</div>",
    "</div>",
    "</div>",
    "</div>",
    "<div class=\"sect1\">",
    "<h2 id=\"_おわりに\">おわりに😎</h2>",
    "<div class=\"sectionbody\">",
    "<div class=\"paragraph\">",
    "<p>以上で <code>orphan</code> ブランチを更新すれば <code>main</code> ブランチの <em>GitHub Actions</em> が実行するようにできた。</p>",
    "</div>",
    "<div class=\"paragraph\">",
    "<p>これで <em>Nuxt</em> プログラムコードと記事ソースのブランチを分けて、記事だけを更新しても自動的にデプロイ用ワークフローを実行してくれるようにできた。<br>",
    "おかげでブログ更新も捗る……といいな！🙄<span class=\"line-through\">進捗どうですか</span>。</p>",
    "</div>",
    "</div>",
    "</div>",
    "<div class=\"sect1\">",
    "<h2 id=\"_参考\">参考📖</h2>",
    "<div class=\"sectionbody\">",
    "<div class=\"ulist\">",
    "<ul>",
    "<li>",
    "<p><a href=\"https://docs.github.com/ja/free-pro-team@latest/actions/reference/events-that-trigger-workflows\" target=\"_blank\" rel=\"noopener\">ワークフローをトリガーするイベント - GitHub Docs</a></p>",
    "</li>",
    "<li>",
    "<p><a href=\"https://docs.github.com/en/free-pro-team@latest/rest/reference/actions#workflows\" target=\"_blank\" rel=\"noopener\">Actions#workflows - GitHub Docs</a></p>",
    "</li>",
    "<li>",
    "<p><a href=\"https://docs.github.com/ja/free-pro-team@latest/rest/guides/getting-started-with-the-rest-api\" target=\"_blank\" rel=\"noopener\">REST API を使ってみる - GitHub Docs</a></p>",
    "</li>",
    "</ul>",
    "</div>",
    "</div>",
    "</div>"
  ],
  "title": "Github Actions を手動実行するための workflow_dispatch イベント",
  "created_at": "2020-11-13",
  "tags": [
    "github",
    "github-actions"
  ],
  "updated_at": "2020-11-19",
  "author": "秋々すすき",
  "revision": "1.1"
}