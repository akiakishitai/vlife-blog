{"filename":"git_partial_clone.adoc","rendered":"<div id=\"toc\" class=\"toc\">\n<div id=\"toctitle\">目次</div>\n<ul class=\"sectlevel1\">\n<li><a href=\"#_どう使うかの結論\">💪どう使うかの結論</a></li>\n<li><a href=\"#_パーシャルクローン_partial_clone_とは\">🍕パーシャルクローン（ <em>partial clone</em> ）とは</a>\n<ul class=\"sectlevel2\">\n<li><a href=\"#_ブロブレスクローン\">🌟ブロブレス・クローン</a></li>\n<li><a href=\"#_ツリーレスクローン\">ツリーレス・クローン</a></li>\n</ul>\n</li>\n<li><a href=\"#_一部のファイルディレクトリだけをクローンする_sparse_checkout\">🧩一部のファイル/ディレクトリだけをクローンする（ <em>sparse-checkout</em> ）</a>\n<ul class=\"sectlevel2\">\n<li><a href=\"#_git_sparse_checkout_コマンドについて\"><code>git sparse-checkout</code> コマンドについて</a></li>\n</ul>\n</li>\n<li><a href=\"#_参考\">📖参考</a></li>\n</ul>\n</div>\n<div id=\"preamble\">\n<div class=\"sectionbody\">\n<table class=\"tableblock frame-all grid-all stretch\">\n<caption class=\"title\">Table 1. 環境</caption>\n<colgroup>\n<col style=\"width: 50%;\">\n<col style=\"width: 50%;\">\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">App</th>\n<th class=\"tableblock halign-left valign-top\">Version</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><em>git</em></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">2.32.0</p></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_どう使うかの結論\">💪どう使うかの結論</h2>\n<div class=\"sectionbody\">\n<div class=\"imageblock kroki\">\n<div class=\"content\">\n<span class=\"alt\">クローン方法を選ぶワークフロー</span>\n</div>\n<div class=\"title\">Figure 1. クローン方法を選ぶワークフロー</div>\n</div>\n<div class=\"exampleblock\">\n<div class=\"title\">Example 1. 一般的な使い方をするとき</div>\n<div class=\"content\">\n<div class=\"paragraph\">\n<p>リポジトリで作業をする場合はブロブレス・クローンを利用する。</p>\n</div>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"user\"\n    data-host=\"local\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">git clone --filter=blob:none &lt;URL&gt;</code></pre>\n  </div>\n</div>\n</div>\n</div>\n<div class=\"exampleblock\">\n<div class=\"title\">Example 2. ビルド生成物だけが必要なとき</div>\n<div class=\"content\">\n<div class=\"paragraph\">\n<p><em>CI</em> でビルドするためだけに使うなど、リポジトリにおいて <em>git</em> 操作をほぼ行わない場合はツリーレス・クローンまたはシャロー・クローンを利用する。</p>\n</div>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">コミット履歴は参照したいならツリーレス・クローン</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"user\"\n    data-host=\"local\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">git clone --filter=tree:0 &lt;URL&gt;</code></pre>\n  </div>\n</div>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">コミット履歴も不要ならばシャロー・クローン</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"user\"\n    data-host=\"local\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">git clone --depth=1 &lt;URL&gt;</code></pre>\n  </div>\n</div>\n</div>\n</div>\n<div class=\"exampleblock\">\n<div class=\"title\">Example 3. 一部のファイル/ディレクトリだけ必要なとき</div>\n<div class=\"content\">\n<div class=\"paragraph\">\n<p><em>sparse-checkout</em> 機能を使う。<br>\nパーシャルクローンと組み合わせると更に効果的。</p>\n</div>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"user\"\n    data-host=\"local\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">git clone --filter=blob:none --sparse &lt;URL&gt;\ncd &lt;REPOSITORY&gt;\ngit sparse-checkout init --cone\ngit sparse-checkout set &lt;PATTERN1&gt; [&lt;PATTERN2&gt; ...]</code></pre>\n  </div>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_パーシャルクローン_partial_clone_とは\">🍕パーシャルクローン（ <em>partial clone</em> ）とは</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>指定されたコミットの範囲内でダウンロードする <em>blob</em> オブジェクト<sup class=\"footnote\">[<a id=\"_footnoteref_1\" class=\"footnote\" href=\"#_footnotedef_1\" title=\"View footnote.\">1</a>]</sup>や <em>tree</em> オブジェクト<sup class=\"footnote\">[<a id=\"_footnoteref_2\" class=\"footnote\" href=\"#_footnotedef_2\" title=\"View footnote.\">2</a>]</sup>の数を制限してクローンする機能のこと。<br>\n巨大なリポジトリから必要なものだけをクローンすることで、ダウンロード時間やディスク使用容量を削減するために使われる。</p>\n</div>\n<div class=\"paragraph\">\n<p>パーシャルクローンは <code>git clone</code> コマンドにおいて <code>--filter</code> オプションを指定することで有効化される。</p>\n</div>\n<div class=\"paragraph\">\n<p><em>GitHub</em> から利用できるパーシャルクローンは <em>ブロブレス・クローン</em> と <em>ツリーレス・クローン</em> の2種類がある。</p>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_ブロブレスクローン\">🌟ブロブレス・クローン</h3>\n<div class=\"paragraph\">\n<p><code>git clone</code> 実行時にすべてのコミット履歴と <em>tree</em> オブジェクトはダウンロードされるが、各 <em>blob</em> オブジェクトはそれぞれが必要となった時にダウンロードされる<sup class=\"footnote\" id=\"_footnote_cloned\">[<a id=\"_footnoteref_3\" class=\"footnote\" href=\"#_footnotedef_3\" title=\"View footnote.\">3</a>]</sup>。<br>\nこのブロブレス・クローンは汎用的に使えるパーシャルクローンであり、一般的に使われる手法である。</p>\n</div>\n<div class=\"paragraph\">\n<p>リポジトリでの作業において、<em>blob</em> オブジェクトを必要とするコマンドは使用頻度が比較的低い。<br>\nそのため、ブロブレス・クローンは通常のクローンと同じような感覚で使える。</p>\n</div>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">ブロブレス・クローンの実行</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"user\"\n    data-host=\"local\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">git clone --filter=blob:none &lt;URL&gt;</code></pre>\n  </div>\n</div>\n<div class=\"admonitionblock caution\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-caution\" title=\"Caution\" data-md-icon=\"local_fire_department\"></i>\n</td>\n<td class=\"content\">\n<div class=\"title\">blobオブジェクトのダウンロードが行われるコマンド</div>\n<div class=\"paragraph\">\n<p><code>git checkout</code> や <code>git pull</code>、 <code>git blame</code> など。<br>\nファイル内容を利用するコマンドが該当する。</p>\n</div>\n</td>\n</tr>\n</table>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_ツリーレスクローン\">ツリーレス・クローン</h3>\n<div class=\"paragraph\">\n<p><code>git clone</code> 実行時にはすべてのコミット履歴のみがダウンロードされ、<em>tree</em> オブジェクトと <em>blob</em> オブジェクトはそれぞれが必要となった時にダウンロードされる<sup class=\"footnoteref\">[<a class=\"footnote\" href=\"#_footnotedef_3\" title=\"View footnote.\">3</a>]</sup>。</p>\n</div>\n<div class=\"paragraph\">\n<p>利用方法はシャロー・クローンと似たような感じになり、使い所が限られる。<br>\n（<em>tree</em> オブジェクトを必要とする <em>git</em> コマンドが意外とあるみたい）</p>\n</div>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">ツリーレス・クローンの実行</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"user\"\n    data-host=\"local\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">git clone --filter=tree:0 &lt;URL&gt;</code></pre>\n  </div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_一部のファイルディレクトリだけをクローンする_sparse_checkout\">🧩一部のファイル/ディレクトリだけをクローンする（ <a href=\"https://git-scm.com/docs/git-sparse-checkout\" target=\"_blank\" rel=\"noopener\"><em>sparse-checkout</em></a> ）</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p><em>sparse-checkout</em> 機能を利用することで、一部のファイルまたはディレクトリだけに制限してクローンすることができる。<br>\nこの <em>sparse-checkout</em> 機能は <code>git sparse-checkout</code> コマンドから操作する。</p>\n</div>\n<div class=\"paragraph\">\n<p>例として <a href=\"https://github.com/derrickstolee/sparse-checkout-example\" target=\"_blank\" rel=\"noopener\"><em>Sparse-Checkout Example Repo</em></a> リポジトリを対象にすると次のようになる。</p>\n</div>\n<div class=\"exampleblock\">\n<div class=\"title\">Example 4. 一部のファイル/ディレクトリだけをクローンする例</div>\n<div class=\"content\">\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">パーシャルクローンと組み合わせ</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"user\"\n    data-host=\"local\"\n    data-output=\"5,9,11\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">git clone \\\n    --filter=blob:none \\    <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\n    --sparse \\              <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n    https://github.com/derrickstolee/sparse-checkout-example\n\ncd ./sparse-checkout-example\ngit sparse-checkout init --cone         <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>\ngit sparse-checkout set web/browser     <i class=\"conum\" data-value=\"4\"></i><b>(4)</b>\n\nls -AF\nbootstrap.sh  .git/  LICENSE.md  README.md  web/</code></pre>\n  </div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td>ブロブレス・クローンとして実行<sup class=\"footnote\">[<a id=\"_footnoteref_4\" class=\"footnote\" href=\"#_footnotedef_4\" title=\"View footnote.\">4</a>]</sup>。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>リポジトリのルート直下にあるファイルだけをダウンロードするオプション。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>\n<td><em>sparse-checkout</em> 機能の有効化。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"4\"></i><b>4</b></td>\n<td>ダウンロードしたいファイル/ディレクトリのパスをパターンで新規指定。<br>\nパターンを追加する場合は <code>add</code> サブコマンドを使う。</td>\n</tr>\n</table>\n</div>\n<div class=\"admonitionblock note\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-note\" title=\"Note\" data-md-icon=\"info\"></i>\n</td>\n<td class=\"content\">\n<em>git v2.27.0</em> 以降では <code>--no-checkout</code> オプションと <code>git sparse-checkout</code> の組み合わせはバグがあったため機能しない。<br>\nただし v2.32.0 では修正されて動作するっぽい。\n</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_git_sparse_checkout_コマンドについて\"><code>git sparse-checkout</code> コマンドについて</h3>\n<div class=\"admonitionblock caution\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-caution\" title=\"Caution\" data-md-icon=\"local_fire_department\"></i>\n</td>\n<td class=\"content\">\n<em>git v2.32.0</em> でもまだ実験的なコマンドのため、動作やサブコマンドが変更される可能性がある。\n</td>\n</tr>\n</table>\n</div>\n<div class=\"dlist\">\n<dl>\n<dt class=\"hdlist1\"><em>sparse-checkout</em> 機能の有効化</dt>\n<dd>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"user\"\n    data-host=\"local\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">git sparse-checkout init --cone</code></pre>\n  </div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>パフォーマンス改善のため、 <code>--cone</code> オプションが一般的に付けられる（詳細は <a href=\"https://git-scm.com/docs/git-sparse-checkout#_cone_pattern_set\" target=\"_blank\" rel=\"noopener\">CONE PATTERN SET</a> を参照）。</p>\n</li>\n</ul>\n</div>\n</dd>\n<dt class=\"hdlist1\">必要なパスのパターンを登録</dt>\n<dd>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"user\"\n    data-host=\"local\"\n    data-output=\"2-10\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">git sparse-checkout set &lt;PATTERN1&gt; [&lt;PATTERN2&gt; ...]\ngit sparse-checkout add &lt;PATTERN1&gt; [&lt;PATTERN2&gt; ...]</code></pre>\n  </div>\n</div>\n<table class=\"tableblock frame-all grid-all fit-content\">\n<colgroup>\n<col>\n<col>\n</colgroup>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>set</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">指定したパターンで登録リストを新規作成。<br>\n既存のリストは上書きされる。</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>add</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">登録リストに指定したパターンを追加登録。</p></td>\n</tr>\n</tbody>\n</table>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>指定するパターンの書式は <code>.gitignore</code> と同様。</p>\n</li>\n</ul>\n</div>\n</dd>\n<dt class=\"hdlist1\">登録されているパターンの一覧</dt>\n<dd>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"user\"\n    data-host=\"local\"\n    data-output=\"2-10\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">git sparse-checkout list</code></pre>\n  </div>\n</div>\n</dd>\n<dt class=\"hdlist1\"><em>sparse-checkout</em> 機能を再適用</dt>\n<dd>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"user\"\n    data-host=\"local\"\n    data-output=\"2-10\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">git sparse-checkout reapply</code></pre>\n  </div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>git merge</code> や <code>git rebase</code> でパスを実体化した場合に使ったりする。</p>\n</li>\n</ul>\n</div>\n</dd>\n<dt class=\"hdlist1\"><em>sparse-checkout</em> 機能を無効化</dt>\n<dd>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"user\"\n    data-host=\"local\"\n    data-output=\"2-10\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">git sparse-checkout disable</code></pre>\n  </div>\n</div>\n</dd>\n</dl>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\">📖参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<div class=\"title\">Partial Clone</div>\n<ul>\n<li>\n<p><a href=\"https://git-scm.com/docs/partial-clone\" target=\"_blank\" rel=\"noopener\">Git - partial-clone Documentation</a></p>\n</li>\n<li>\n<p><a href=\"https://github.blog/jp/2021-01-13-get-up-to-speed-with-partial-clone-and-shallow-clone/\" target=\"_blank\" rel=\"noopener\">パーシャルクローンとシャロークローンを活用しよう - GitHubブログ</a></p>\n</li>\n</ul>\n</div>\n<div class=\"ulist\">\n<div class=\"title\">sparse-checkout</div>\n<ul>\n<li>\n<p><a href=\"https://git-scm.com/docs/git-sparse-checkout\" target=\"_blank\" rel=\"noopener\">git-sparse-checkout Documentation</a></p>\n</li>\n<li>\n<p><a href=\"https://github.blog/2020-01-17-bring-your-monorepo-down-to-size-with-sparse-checkout/\" target=\"_blank\" rel=\"noopener\">Bring your monorepo down to size with sparse-checkout | The GitHub Blog</a></p>\n</li>\n<li>\n<p><a href=\"https://iucstscui.hatenablog.com/entry/2020/08/29/080322\" target=\"_blank\" rel=\"noopener\">git2.27以降にgit sparse-checkoutを使う場合はno-checkoutではなくsparseを使おう - はんなりと、ゆるやかに</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div id=\"footnotes\">\n<hr>\n<div class=\"footnote\" id=\"_footnotedef_1\">\n<a href=\"#_footnoteref_1\">1</a>. <em>git</em> 内部で使用されているオブジェクトタイプ。リポジトリ内の各ファイルの中身が保存されている。\n</div>\n<div class=\"footnote\" id=\"_footnotedef_2\">\n<a href=\"#_footnoteref_2\">2</a>. ディレクトリのようなもの。各オブジェクトの階層情報が保存されている。\n</div>\n<div class=\"footnote\" id=\"_footnotedef_3\">\n<a href=\"#_footnoteref_3\">3</a>. <code>HEAD</code> コミットだけは全てのデータがダウンロードされている。\n</div>\n<div class=\"footnote\" id=\"_footnotedef_4\">\n<a href=\"#_footnoteref_4\">4</a>. 通常のクローンと比較して、この例では <em>172MB</em> &#8594; <em>504KB</em> へとサイズ削減できた。\n</div>\n</div>","title":"巨大なリポジトリをクローンするときに便利なパーシャルクローンとsparse-checkout","created_at":"2021-07-22","tags":["git","partial-clone"],"updated_at":"2021-07-22","author":"秋々すすき","revision":"1.0"}