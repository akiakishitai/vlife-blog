{"filename":"nuxt_detect_props_changes.adoc","rendered":"<div id=\"toc\" class=\"toc\">\n<div id=\"toctitle\">目次</div>\n<ul class=\"sectlevel1\">\n<li><a href=\"#_はじめに\">はじめに🥯</a></li>\n<li><a href=\"#_nuxtvue_における変更検出の基本\"><em>Nuxt（Vue）</em> における変更検出の基本📝</a></li>\n<li><a href=\"#_props_のオブジェクトデータの変更を検出する\"><code>props</code> のオブジェクトデータの変更を検出する🔍</a>\n<ul class=\"sectlevel2\">\n<li><a href=\"#_監視プロパティwatchで変更を検出する\">監視プロパティ（<code>watch</code>）で変更を検出する</a></li>\n</ul>\n</li>\n<li><a href=\"#_おわりに\">おわりに😎</a></li>\n<li><a href=\"#_参考\">参考📖</a></li>\n</ul>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_はじめに\">はじめに🥯</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>親コンポーネントから渡されたプロパティ（<code>props</code>）のデータが変更されたとき、それを検出してビューを更新したい。</p>\n</div>\n<div class=\"paragraph\">\n<p><code>string</code> 型や <code>number</code> 型のデータならばなんの手間もいらず変更を検出してくれるが、オブジェクトや配列データでは一手間が必要になってくる。<br>\nその一手間について記事にしてみた。</p>\n</div>\n<table class=\"tableblock frame-all grid-all fit-content\">\n<caption class=\"title\">Table 1. 環境</caption>\n<colgroup>\n<col>\n<col>\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">App</th>\n<th class=\"tableblock halign-left valign-top\">Version</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Nuxt.js</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">2.14.12</p></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_nuxtvue_における変更検出の基本\"><em>Nuxt（Vue）</em> における変更検出の基本📝</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p><a href=\"https://jp.vuejs.org/v2/guide/reactivity.html\" target=\"_blank\" rel=\"noopener\"><em>Vue</em> 公式のドキュメント</a>に書いてある通り。</p>\n</div>\n<div class=\"paragraph\">\n<p>全てのコンポーネントには対応するウォッチャ（<em>watcher</em>）があり、コンポーネントのデータが変更されると <code>setter</code> がこのウォッチャに通知する。<br>\nそして通知を受け取ったウォッチャからコンポーネントの再描画が行われる。</p>\n</div>\n<div class=\"imageblock kroki\">\n<div class=\"content\">\n<svg viewBox=\"0 0 448 360\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:inkspace=\"http://www.inkscape.org/namespaces/inkscape\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"448px\" height=\"360px\">\n  <defs id=\"defs_block\">\n    <filter height=\"1.504\" id=\"filter_blur\" inkspace:collect=\"always\" width=\"1.1575\" x=\"-0.07875\" y=\"-0.252\">\n      <feGaussianBlur id=\"feGaussianBlur3780\" inkspace:collect=\"always\" stdDeviation=\"4.2\" />\n    </filter>\n  </defs>\n  <title>blockdiag</title>\n  <desc>blockdiag {\n  component [label = \"コンポーネントの\\n描画関数\"]\n  dom [label = \"仮想DOMツリー\", shape = roundedbox]\n  data [label = \"データの変更\", shape = flowchart.input]\n\n  group {\n    orientation = portrait\n    shape = line;\n\n    data -&gt; setter;\n  }\n\n  setter -&gt; Watcher;\n\n  group {\n    orientation = portrait\n    shape = line;\n    color = \"#4DD0E1\";\n\n    Watcher -&gt; component -&gt; dom;\n  }\n}</desc>\n  <rect fill=\"rgb(0,0,0)\" height=\"40\" stroke=\"rgb(0,0,0)\" style=\"filter:url(#filter_blur);opacity:0.7;fill-opacity:1\" width=\"128\" x=\"259\" y=\"126\" />\n  <rect fill=\"rgb(0,0,0)\" height=\"40\" stroke=\"rgb(0,0,0)\" style=\"filter:url(#filter_blur);opacity:0.7;fill-opacity:1\" width=\"128\" x=\"259\" y=\"206\" />\n  <path d=\"M 267 286 L 379 286 A8,8 0 0 1 387 294 L 387 318 A8,8 0 0 1 379 326 L 267 326 A8,8 0 0 1 259 318 L 259 294 A8,8 0 0 1 267 286\" fill=\"rgb(0,0,0)\" stroke=\"rgb(0,0,0)\" style=\"filter:url(#filter_blur);opacity:0.7;fill-opacity:1\" />\n  <polygon fill=\"rgb(0,0,0)\" points=\"91,46 195,46 171,86 67,86 91,46\" stroke=\"rgb(0,0,0)\" style=\"filter:url(#filter_blur);opacity:0.7;fill-opacity:1\" />\n  <rect fill=\"rgb(0,0,0)\" height=\"40\" stroke=\"rgb(0,0,0)\" style=\"filter:url(#filter_blur);opacity:0.7;fill-opacity:1\" width=\"128\" x=\"67\" y=\"126\" />\n  <rect fill=\"rgb(255,255,255)\" height=\"40\" stroke=\"rgb(0,0,0)\" width=\"128\" x=\"256\" y=\"120\" />\n  <text fill=\"rgb(0,0,0)\" font-family=\"sans-serif\" font-size=\"11\" font-style=\"normal\" font-weight=\"normal\" text-anchor=\"middle\" textLength=\"48\" x=\"320.0\" y=\"146\">Watcher</text>\n  <rect fill=\"rgb(255,255,255)\" height=\"40\" stroke=\"rgb(0,0,0)\" width=\"128\" x=\"256\" y=\"200\" />\n  <text fill=\"rgb(0,0,0)\" font-family=\"sans-serif\" font-size=\"11\" font-style=\"normal\" font-weight=\"normal\" text-anchor=\"middle\" textLength=\"56\" x=\"320.0\" y=\"219\">コンポーネントの</text>\n  <text fill=\"rgb(0,0,0)\" font-family=\"sans-serif\" font-size=\"11\" font-style=\"normal\" font-weight=\"normal\" text-anchor=\"middle\" textLength=\"28\" x=\"320.0\" y=\"234\">描画関数</text>\n  <path d=\"M 264 280 L 376 280 A8,8 0 0 1 384 288 L 384 312 A8,8 0 0 1 376 320 L 264 320 A8,8 0 0 1 256 312 L 256 288 A8,8 0 0 1 264 280\" fill=\"rgb(255,255,255)\" stroke=\"rgb(0,0,0)\" />\n  <text fill=\"rgb(0,0,0)\" font-family=\"sans-serif\" font-size=\"11\" font-style=\"normal\" font-weight=\"normal\" text-anchor=\"middle\" textLength=\"64\" x=\"320.0\" y=\"307\">仮想DOMツリー</text>\n  <polygon fill=\"rgb(255,255,255)\" points=\"88,40 192,40 168,80 64,80 88,40\" stroke=\"rgb(0,0,0)\" />\n  <text fill=\"rgb(0,0,0)\" font-family=\"sans-serif\" font-size=\"11\" font-style=\"normal\" font-weight=\"normal\" text-anchor=\"middle\" textLength=\"42\" x=\"128.0\" y=\"67\">データの変更</text>\n  <rect fill=\"rgb(255,255,255)\" height=\"40\" stroke=\"rgb(0,0,0)\" width=\"128\" x=\"64\" y=\"120\" />\n  <text fill=\"rgb(0,0,0)\" font-family=\"sans-serif\" font-size=\"11\" font-style=\"normal\" font-weight=\"normal\" text-anchor=\"middle\" textLength=\"34\" x=\"128.0\" y=\"146\">setter</text>\n  <path d=\"M 320 160 L 320 192\" fill=\"none\" stroke=\"rgb(0,0,0)\" />\n  <polygon fill=\"rgb(0,0,0)\" points=\"320,199 316,192 324,192 320,199\" stroke=\"rgb(0,0,0)\" />\n  <path d=\"M 320 240 L 320 272\" fill=\"none\" stroke=\"rgb(0,0,0)\" />\n  <polygon fill=\"rgb(0,0,0)\" points=\"320,279 316,272 324,272 320,279\" stroke=\"rgb(0,0,0)\" />\n  <path d=\"M 128 80 L 128 112\" fill=\"none\" stroke=\"rgb(0,0,0)\" />\n  <polygon fill=\"rgb(0,0,0)\" points=\"128,119 124,112 132,112 128,119\" stroke=\"rgb(0,0,0)\" />\n  <path d=\"M 192 140 L 248 140\" fill=\"none\" stroke=\"rgb(0,0,0)\" />\n  <polygon fill=\"rgb(0,0,0)\" points=\"255,140 248,136 248,144 255,140\" stroke=\"rgb(0,0,0)\" />\n  <rect fill=\"none\" height=\"220\" stroke=\"rgb(77,208,225)\" stroke-width=\"3\" width=\"144\" x=\"248\" y=\"110\" />\n  <rect fill=\"none\" height=\"140\" stroke=\"rgb(243,152,0)\" stroke-width=\"3\" width=\"144\" x=\"56\" y=\"30\" />\n</svg>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>このデータ変更を検出させるために注意すべきなのが</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>オブジェクトデータの変更</p>\n</li>\n<li>\n<p>配列データの変更</p>\n</li>\n<li>\n<p>リアクティブなプロパティ</p>\n</li>\n<li>\n<p>DOM操作をしたいとき</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>となる（詳細は<a href=\"https://jp.vuejs.org/v2/guide/reactivity.html\" target=\"_blank\" rel=\"noopener\">公式のドキュメント</a>や参考リンクを参照）。</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_props_のオブジェクトデータの変更を検出する\"><code>props</code> のオブジェクトデータの変更を検出する🔍</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>今回つまったのは、親コンポーネントから <code>props</code> オプションで渡されたオブジェクトデータの変更を検出する方法について。</p>\n</div>\n<div class=\"paragraph\">\n<p>検出可能にするには、<a href=\"https://jp.vuejs.org/v2/guide/reactivity.html#%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E9%96%A2%E3%81%97%E3%81%A6\" target=\"_blank\" rel=\"noopener\">ドキュメント</a>より</p>\n</div>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>親コンポーネントにおいてプロパティ値変更に <code>vm.$set</code> インスタンスメソッドを使う</p>\n</li>\n<li>\n<p>親コンポーネントにおいて新しいオブジェクトとして生成し直す</p>\n</li>\n</ol>\n</div>\n<div class=\"paragraph\">\n<p>という方法が考えられるが、いちいち親コンポーネントで上記のことを気にかけるのが面倒くさい。</p>\n</div>\n<div class=\"paragraph\">\n<p>よって今回は<strong>子コンポーネント</strong>において、<code>watch</code> オプションを使って <code>props</code> のオブジェクトを監視させる。</p>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_監視プロパティwatchで変更を検出する\">監視プロパティ（<code>watch</code>）で変更を検出する</h3>\n<div class=\"paragraph\">\n<p><code>watch</code> オプションで <code>props</code> のデータを監視し、変更に対して反応させる。<br>\n下記の例では <a href=\"https://github.com/nuxt-community/nuxt-property-decorator\" target=\"_blank\" rel=\"noopener\">nuxt-property-decorator</a> ライブラリを利用しているので、代わりに <code>@Watch</code> デコレータを利用している。</p>\n</div>\n<div class=\"exampleblock\">\n<div class=\"title\">Example 1. オブジェクトのプロパティを監視して変更を検出する</div>\n<div class=\"content\">\n<div \n    class=\"listingblock\">\n\n  <div class=\"content\">\n  <pre class=\"highlight \" data-line=\"13-16\"\n    ><code class=\"language-ts\"\n    data-lang=\"ts\">&lt;script lang=\"ts\"&gt;\nimport { Component, Prop, Vue, Watch } from 'nuxt-property-decorator'\n\n@Component\nexport default class InputSearch extends Vue {\n  /** 入力値 */\n  message = ''\n\n  /** URLクエリパラメータ */\n  @Prop({ required: true, default: {} }) query!: Record&lt;'tags', string&gt;\n\n  /** `query.tags` プロパティの変更を監視 */\n  @Watch('query.tags', { immediate: true })   <i class=\"conum\" data-value=\"1\"></i><b>(1)</b> <i class=\"conum\" data-value=\"2\"></i><b>(2)</b> <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>\n  onUpdateQueryTags() {   <i class=\"conum\" data-value=\"4\"></i><b>(4)</b>\n    this.message = this.query.tags?.toString() ?? ''\n  }\n}\n&lt;/script&gt;</code></pre>\n  </div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td><code>watch</code> オプションの代わりに <code>@Watch</code> デコレータを利用。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td>オブジェクトのプロパティを指定（ここでは <code>query</code> オブジェクトの <code>tags</code> プロパティ）して監視。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>\n<td><em>Vue</em> インスタンスの初期化時にも処理を実行したいので <code>immediate</code> オプションを有効化。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"4\"></i><b>4</b></td>\n<td>変更を検出したときに実行する処理を定義。</td>\n</tr>\n</table>\n</div>\n<div class=\"admonitionblock tip\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-tip\" title=\"Tip\" data-md-icon=\"emoji_objects\"></i>\n</td>\n<td class=\"content\">\n<div class=\"paragraph\">\n<p>オブジェクトのネストされているプロパティ全てを監視したい場合は <code>deep</code> オプションを有効化する。</p>\n</div>\n<div \n    class=\"listingblock\">\n\n  <div class=\"content\">\n  <pre class=\"highlight \" ><code class=\"language-ts\"\n    data-lang=\"ts\">@Watch('query', { immediate: true, deep: true })</code></pre>\n  </div>\n</div>\n</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_おわりに\">おわりに😎</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>うっかりやらかす度合いが高そうなので、備忘録代わりに記事にしてみた。</p>\n</div>\n<div class=\"paragraph\">\n<p><code>props</code> でオブジェクトそのまま渡すのは落とし穴ができやすくて怖いなーって思ったり。</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\">参考📖</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<div class=\"title\">Vue.js</div>\n<ul>\n<li>\n<p><a href=\"https://jp.vuejs.org/v2/guide/reactivity.html\" target=\"_blank\" rel=\"noopener\">リアクティブの探求 — Vue.js</a></p>\n</li>\n<li>\n<p><a href=\"https://jp.vuejs.org/v2/guide/computed.html\" target=\"_blank\" rel=\"noopener\">算出プロパティとウォッチャ — Vue.js</a></p>\n</li>\n</ul>\n</div>\n<div class=\"ulist\">\n<div class=\"title\">nuxt-property-decorator</div>\n<ul>\n<li>\n<p><a href=\"https://github.com/nuxt-community/nuxt-property-decorator\" target=\"_blank\" rel=\"noopener\">nuxt-community/nuxt-property-decorator: Property decorators for Nuxt (base on vue-property-decorator)</a></p>\n</li>\n</ul>\n</div>\n<div class=\"ulist\">\n<div class=\"title\">ビュー更新について</div>\n<ul>\n<li>\n<p><a href=\"++https://qiita.com/_Keitaro_/items/8e3f8448d1a0fe281648++\" target=\"_blank\" rel=\"noopener\">$watchでオブジェクトの変更を監視する方法 - Qiita</a></p>\n</li>\n<li>\n<p><a href=\"https://qiita.com/bobu_web/items/ec5a98d03758d12ad721\" target=\"_blank\" rel=\"noopener\">Vue.jsでビューの変更がされないときに疑うこと+主な解決策方法 - Qiita</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","title":"Nuxtで親コンポーネントから渡されるプロパティ（props）の変更を検出する","created_at":"2021-04-02","tags":["nuxt.js"],"updated_at":"2021-04-02","author":"秋々すすき","revision":"1.0"}