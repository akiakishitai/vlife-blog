{"filename":"apt-get_ppa_without_apt-key.adoc","rendered":"<div id=\"toc\" class=\"toc\">\n<div id=\"toctitle\">目次</div>\n<ul class=\"sectlevel1\">\n<li><a href=\"#_はじめに\">🐶はじめに</a>\n<ul class=\"sectlevel2\">\n<li><a href=\"#_試してみた結果\">試してみた結果</a></li>\n</ul>\n</li>\n<li><a href=\"#_apt_key_を使わない_ppa_追加方法\">🔌<code>apt-key</code> を使わない <em>PPA</em> 追加方法</a>\n<ul class=\"sectlevel2\">\n<li><a href=\"#_リポジトリの公開鍵を登録\">リポジトリの公開鍵を登録</a></li>\n<li><a href=\"#_リポジトリの追加\">リポジトリの追加</a></li>\n</ul>\n</li>\n<li><a href=\"#_トラブルシューティング\">🛠️トラブルシューティング</a>\n<ul class=\"sectlevel2\">\n<li><a href=\"#_公開鍵はインポートできたのに_public_key_is_not_available_no_pubkey_エラー\">公開鍵はインポートできたのに <code>public key is not available: NO_PUBKEY</code> エラー</a></li>\n</ul>\n</li>\n<li><a href=\"#_参考\">📖参考</a></li>\n</ul>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_はじめに\">🐶はじめに</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p><em>Docker</em> コンテナで最新版の <code>git</code> をインストールしたかった。</p>\n</div>\n<div class=\"ulist none\">\n<ul class=\"none\">\n<li>\n<p><em>Ubuntu</em> や <em>Debian</em> の場合は <code>add-apt-repository</code> コマンドを使って <em>PPA</em> から簡単にインストールできる。</p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>ただ、<code>add-apt-repository</code> が含まれる`software-properties-common` パッケージは依存パッケージが多くてサイズが肥大化しやすいので、コンテナであまり使いたくない。</p>\n</li>\n</ul>\n</div>\n</li>\n<li>\n<p>別の方法として <code>apt-key</code> を使う方法がある。</p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><em>Ubuntu 20.10 (Groovy)</em> や <em>Debian 11</em> からは <code>apt-key</code> が非推奨になるらしい。</p>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>そのため、今後推奨される方法である <code>gnupg</code> を使う方法を試してみた。</p>\n</div>\n<table class=\"tableblock frame-all grid-all fit-content\">\n<caption class=\"title\">Table 1. 環境</caption>\n<colgroup>\n<col>\n<col>\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\">App</th>\n<th class=\"tableblock halign-left valign-top\">Version</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Windows10</p></td>\n<td class=\"tableblock halign-left valign-top\"></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Docker Desktop</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">3.5.1</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Docker</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">20.10.7</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Ubuntu</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">20.04</p></td>\n</tr>\n</tbody>\n</table>\n<div class=\"sect2\">\n<h3 id=\"_試してみた結果\">試してみた結果</h3>\n<div class=\"paragraph\">\n<p>結論から言えば、次のような <em>Dockerfile</em> にすればいい。</p>\n</div>\n<div class=\"exampleblock\">\n<div class=\"title\">Example 1. Dockerfileのサンプル</div>\n<div class=\"content\">\n<div class=\"paragraph\">\n<p>最新版の <em>git</em> をインストールしたい場合の例。</p>\n</div>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">Dockerfile</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" ><code class=\"language-dockerfile\"\n    data-lang=\"dockerfile\">FROM ubuntu:20.04 AS keyrings\nWORKDIR /keyrings\n\nRUN \\\n  apt-get update &amp;&amp; \\\n  apt-get install -y --no-install-recommends \\\n    gnupg\n\nRUN \\\n  mkdir -m 700 /tmp/.gnupg &amp;&amp; \\\n  gpg \\\n    --no-default-keyring \\\n    --homedir /tmp/.gnupg \\\n    --keyserver keyserver.ubuntu.com \\\n    --keyring gnupg-ring:/keyrings/git-archive-keyring.gpg \\\n    --recv-keys E1DD270288B4E6030699E45FA1715D88E1DF1F24\nRUN chmod -R a+r /keyrings\n\n# ----------------\nFROM ubuntu:20.04\nCOPY --from=keyrings /keyrings /usr/share/keyrings/\nCOPY --chown=root:root ./sourcelists /etc/apt/sources.list.d/\n\n# install git\nRUN \\\n  apt-get update &amp;&amp; \\\n  apt-get install -y --no-install-recommends \\\n    git &amp;&amp; \\\n  apt-get clean &amp;&amp; \\\n  rm -rf \\\n    /tmp/* \\\n    /var/lib/apt/lists/* \\\n    /var/tmp/*</code></pre>\n  </div>\n</div>\n<div \n    class=\"listingblock\">\n<div class=\"title\">sourcelists/git.list</div>\n  <div class=\"content\">\n  <pre class=\"highlight \" ><code class=\"language-text\"\n    data-lang=\"text\">deb [signed-by=/usr/share/keyrings/git-archive-keyring.gpg] http://ppa.launchpad.net/git-core/ppa/ubuntu focal main</code></pre>\n  </div>\n</div>\n</div>\n</div>\n<hr>\n<div class=\"paragraph\">\n<p>以下、詳細。</p>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_apt_key_を使わない_ppa_追加方法\">🔌<code>apt-key</code> を使わない <em>PPA</em> 追加方法</h2>\n<div class=\"sectionbody\">\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>リポジトリの公開鍵を登録</p>\n</li>\n<li>\n<p>リポジトリを追加</p>\n</li>\n<li>\n<p>対象パッケージをインストール（<code>apt-get update &amp;&amp; apt-get install &#8230;&#8203;</code>）</p>\n</li>\n</ol>\n</div>\n<div class=\"paragraph\">\n<p>とすればいい。</p>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_リポジトリの公開鍵を登録\">リポジトリの公開鍵を登録</h3>\n<div class=\"exampleblock\">\n<div class=\"title\">Example 2. 公開鍵の登録</div>\n<div class=\"content\">\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">リポジトリ公開鍵を登録</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"root\"\n    data-host=\"host\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">mkdir -m 700 /tmp/.gnupg    <i class=\"conum\" data-value=\"1\"></i><b>(1)</b>\ngpg \\\n  --no-default-keyring \\\n  --homedir /tmp/.gnupg \\   <i class=\"conum\" data-value=\"2\"></i><b>(2)</b>\n  --keyserver keyserver.ubuntu.com \\\n  --keyring gnupg-ring:/usr/share/keyrings/&lt;REPOSITRY&gt;-archive-keyring.gpg \\    <i class=\"conum\" data-value=\"3\"></i><b>(3)</b>\n  --recv-keys &lt;FINGER_PRINT&gt;  <i class=\"conum\" data-value=\"4\"></i><b>(4)</b>\nchmod -R a+r /usr/share/keyrings  <i class=\"conum\" data-value=\"5\"></i><b>(5)</b></code></pre>\n  </div>\n</div>\n<div class=\"colist arabic\">\n<table>\n<tr>\n<td><i class=\"conum\" data-value=\"1\"></i><b>1</b></td>\n<td><em>GnuPG</em> が使うディレクトリを作成しておく。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"2\"></i><b>2</b></td>\n<td><em>GnuPG</em> が一時ファイルなどを出力するディレクトリのパスを指定。<br>\nデフォルト値は <code>$HOME/.gnupg</code> となる。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"3\"></i><b>3</b></td>\n<td>インポートした公開鍵を出力するファイルパスを指定。<br>\n非公式リポジトリの鍵は <code>/usr/share/keyrings</code> 以下に保存することを推奨<sup class=\"footnote\" id=\"_footnote_debian\">[<a id=\"_footnoteref_1\" class=\"footnote\" href=\"#_footnotedef_1\" title=\"View footnote.\">1</a>]</sup>。<br>\nまた、ファイル名の末尾を <code>-archive-keyring</code> とすることが推奨される<sup class=\"footnoteref\">[<a class=\"footnote\" href=\"#_footnotedef_1\" title=\"View footnote.\">1</a>]</sup>。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"4\"></i><b>4</b></td>\n<td>インポートするリポジトリ公開鍵のフィンガープリントを指定。<br>\n<a href=\"https://launchpad.net\" target=\"_blank\" rel=\"noopener\">Launchpad</a> でリポジトリを検索したときに表示されるものをコピペすればいい。</td>\n</tr>\n<tr>\n<td><i class=\"conum\" data-value=\"5\"></i><b>5</b></td>\n<td><code>apt-get</code> がインポートしたリポジトリ公開鍵を読み込めるように、読み取り権限を付与。</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_リポジトリの追加\">リポジトリの追加</h3>\n<div class=\"paragraph\">\n<p>上記の方法で鍵を <code>/usr/share/keyrings/</code> 以下に登録したあとは、いつものように <code>/etc/apt/sources.list.d/</code> 以下に <code>&lt;REPOSITRY&gt;.list</code> ファイルを作成する。<br>\nこのとき、<code>signed-by</code> オプションを付け加える。</p>\n</div>\n<div class=\"exampleblock\">\n<div class=\"title\">Example 3. リポジトリ追加の例</div>\n<div class=\"content\">\n<div class=\"paragraph\">\n<p><em>git-core</em> の <em>PPA</em> を追加したい場合は次のようなファイルを作成する。</p>\n</div>\n<div \n    class=\"listingblock\">\n<div class=\"title\">/etc/apt/sources.list.d/git.list</div>\n  <div class=\"content\">\n  <pre class=\"highlight \" ><code class=\"language-text\"\n    data-lang=\"text\">deb [signed-by=/usr/share/keyrings/git-archive-keyring.gpg] http://ppa.launchpad.net/git-core/ppa/ubuntu focal main</code></pre>\n  </div>\n</div>\n<div class=\"admonitionblock tip\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-tip\" title=\"Tip\" data-md-icon=\"emoji_objects\"></i>\n</td>\n<td class=\"content\">\n<div class=\"title\">[signed-by=&lt;GPGKEY_PATH&gt;]</div>\nこのリポジトリの認証に使う鍵を指定する。<br>\n鍵を <code>/usr/share/keyrings</code> などに保存している場合に<strong>必須</strong>。\n</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n<hr>\n<div class=\"paragraph\">\n<p>できた！💪💪💪</p>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_トラブルシューティング\">🛠️トラブルシューティング</h2>\n<div class=\"sectionbody\">\n<div class=\"sect2\">\n<h3 id=\"_公開鍵はインポートできたのに_public_key_is_not_available_no_pubkey_エラー\">公開鍵はインポートできたのに <code>public key is not available: NO_PUBKEY</code> エラー</h3>\n<div class=\"dlist\">\n<dl>\n<dt class=\"hdlist1\">問題</dt>\n<dd>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">インポートも設定もできてるはずなのにエラー！ナンデ！？</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"root\"\n    data-host=\"docker\"\n    data-output=\"2-10\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">apt-get update\n...\nW: GPG error: XXX: The following signatures couldn't be verified\n   because the public key is not available: NO_PUBKEY ABCDEFG\nE: The repository 'XXX' is not signed.</code></pre>\n  </div>\n</div>\n</dd>\n<dt class=\"hdlist1\">原因</dt>\n<dd>\n<p><code>apt-get</code> が鍵を読み取れない場合にもこのエラーが発生する。<br>\nよって公開鍵のパーミッションを <code>644</code> にしておく。</p>\n<div class=\"admonitionblock note\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-note\" title=\"Note\" data-md-icon=\"info\"></i>\n</td>\n<td class=\"content\">\n<div class=\"title\">やらかしてた例</div>\n<code>/usr/share/keyrings</code> 以下にある鍵のパーミッションを一括変更するときに、うっかりディレクトリの実行権限を削除（<em>644</em> パーミッションに）してた。\n</td>\n</tr>\n</table>\n</div>\n</dd>\n<dt class=\"hdlist1\">解決</dt>\n<dd>\n<div \n    class=\"listingblock no-line-numbers command-line\">\n<div class=\"title\">/usr/share/keyrings 以下にある鍵を 644 パーミッションに一括変更</div>\n  <div class=\"content\">\n  <pre class=\"highlight command-line\" data-user=\"root\"\n    data-host=\"docker\"\n    data-output=\"2-10\"\n    ><code class=\"language-bash\"\n    data-lang=\"bash\">chmod -R a=rX,u+w /usr/share/keyrings</code></pre>\n  </div>\n</div>\n</dd>\n</dl>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\">📖参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://www.usagi1975.com/2019152355/\" target=\"_blank\" rel=\"noopener\">add-apt-repositoryを使わないでPPAを追加する</a></p>\n</li>\n<li>\n<p><a href=\"https://gnupg.org/documentation/manpage.html\" target=\"_blank\" rel=\"noopener\">GnuPG - gpg man page</a></p>\n</li>\n<li>\n<p><a href=\"https://wiki.debian.org/DebianRepository/UseThirdParty\" target=\"_blank\" rel=\"noopener\">DebianRepositoryUseThirdParty - Debian Wiki</a></p>\n</li>\n</ul>\n</div>\n<div class=\"ulist\">\n<div class=\"title\">apt-key の代わりに gnupg を使う</div>\n<ul>\n<li>\n<p><a href=\"https://sleeplessbeastie.eu/2018/08/08/how-to-download-public-key-used-to-verify-gnupg-signature-for-the-repository/\" target=\"_blank\" rel=\"noopener\">How to download public key used to verify GnuPG signature for the repository – sleeplessbeastie&#8217;s notes</a></p>\n</li>\n<li>\n<p><a href=\"https://www.clear-code.com/blog/2021/5/5.html\" target=\"_blank\" rel=\"noopener\">非推奨となったapt-keyの代わりにsigned-byとgnupgを使う方法 - 2021-05-05 - ククログ</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div id=\"footnotes\">\n<hr>\n<div class=\"footnote\" id=\"_footnotedef_1\">\n<a href=\"#_footnoteref_1\">1</a>. <a href=\"https://wiki.debian.org/DebianRepository/UseThirdParty\" target=\"_blank\" rel=\"noopener\">DebianRepositoryUseThirdParty - Debian Wiki</a> を参考。\n</div>\n</div>","title":"Dockerfile で apt-key を使わず PPA を追加する","created_at":"2021-07-18","tags":["ubuntu","debian","docker"],"updated_at":"2021-07-18","author":"秋々すすき","revision":"1.0"}